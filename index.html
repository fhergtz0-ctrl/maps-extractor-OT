<script>
  "use strict";

  document.getElementById("origin").textContent = location.origin;

  function toStr(v){ return (v == null) ? "" : String(v); }
  function esc(v){ return '"' + toStr(v).replace(/"/g, '""') + '"'; }
  function downloadCSV(filename, rows){
    if (!rows.length) { alert("No hay filas."); return; }
    const headers = Object.keys(rows[0]);
    const lines = [headers.map(esc).join(",")];
    for (const r of rows) lines.push(headers.map(h => esc(r[h])).join(","));
    const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function log(msg){
    const el = document.getElementById("log");
    el.textContent = (el.textContent ? el.textContent + "\n" : "") + msg;
    console.log("[Extractor]", msg);
  }

  // Mensajes útiles según status de Places
  const helpByStatus = {
    REQUEST_DENIED:
      "- Verifica que tu proyecto tiene BILLING activado.\n" +
      "- En Credenciales → tu API key → API restrictions: incluye Maps JavaScript API y Places API.\n" +
      "- En Application restrictions: HTTP referrers y agrega " + location.origin + "/*",
    INVALID_REQUEST:
      "- Revisa parámetros: query, location y radius (usa números válidos).",
    OVER_QUERY_LIMIT:
      "- Estás excediendo cuota. Baja velocidad o espera y vuelve a intentar.",
    UNKNOWN_ERROR:
      "- Error temporal de Google. Reintenta.",
    ZERO_RESULTS:
      "- Sin resultados con esa query/radio. Prueba un radio mayor o otra ciudad."
  };

  document.getElementById("run").addEventListener("click", () => {
    const key = document.getElementById("apiKey").value.trim();
    if (!key) { alert("Coloca tu API key."); return; }

    // Limpia scripts previos
    const existing = document.querySelector('script[data-dyn="mapsjs"]');
    if (existing) existing.remove();

    log("Cargando Google Maps JS…");
    const s = document.createElement("script");
    s.src = "https://maps.googleapis.com/maps/api/js?key=" + encodeURIComponent(key) + "&libraries=places&v=quarterly";
    s.async = true; s.defer = true; s.dataset.dyn = "mapsjs";
    s.onload = () => {
      log("Maps JS cargado ✓");
      start();
    };
    s.onerror = () => {
      log("No se pudo cargar Google Maps JS API. Revisa tu API key, restricciones de dominio y que Places + Maps JS estén habilitadas.");
    };
    document.body.appendChild(s);
  });

  function start() {
    const q = document.getElementById("query").value.trim();
    const lat = parseFloat(document.getElementById("lat").value);
    const lng = parseFloat(document.getElementById("lng").value);
    const radius = parseInt(document.getElementById("radius").value, 10) || 3000;

    log(`Inicializando búsqueda… query="${q}", lat=${lat}, lng=${lng}, radius=${radius}`);

    const dummy = document.createElement("div");
    dummy.style.width = "0"; dummy.style.height = "0";
    document.body.appendChild(dummy);

    let center;
    if (isFinite(lat) && isFinite(lng)) center = new google.maps.LatLng(lat, lng);
    else { center = new google.maps.LatLng(23.2167, -106.4167); log("Lat/Lng inválidos. Usando Mazatlán por defecto."); }

    const map = new google.maps.Map(dummy, { center, zoom: 14 });
    const service = new google.maps.places.PlacesService(map);

    const allPlaces = [];
    const rows = [];

    function fetchDetailsNext(i) {
      if (i >= allPlaces.length) {
        log(`Listo. Total filas: ${rows.length}`);
        if (rows.length) downloadCSV("restaurantes.csv", rows);
        return;
      }
      const place = allPlaces[i];
      const fields = [
        "name","types","website","formatted_phone_number","international_phone_number",
        "formatted_address","address_components","rating","user_ratings_total","url"
      ];
      service.getDetails({ placeId: place.place_id, fields }, (detail, status) => {
        log(`getDetails status: ${status} ${detail && detail.name ? "→ " + detail.name : ""}`);
        if (status === google.maps.places.PlacesServiceStatus.OK && detail) {
          let city = "", state = "";
          (detail.address_components || []).forEach(c => {
            if (c.types.includes("locality") || c.types.includes("sublocality")) city = c.long_name;
            if (c.types.includes("administrative_area_level_1")) state = c.long_name;
          });
          rows.push({
            company_name: detail.name || "",
            category: (detail.types || []).join("|"),
            website: detail.website || "",
            phone: detail.formatted_phone_number || detail.international_phone_number || "",
            email: "",
            address: detail.formatted_address || "",
            city, state,
            rating: detail.rating ?? "",
            rating_count: detail.user_ratings_total ?? "",
            reviews: "",
            maplink: detail.url || ""
          });
        } else if (status !== google.maps.places.PlacesServiceStatus.OK) {
          const tip = helpByStatus[status] || "";
          if (tip) log("Pista: \n" + tip);
        }
        setTimeout(() => fetchDetailsNext(i+1), 200);
      });
    }

    function handleTextSearch(results, status, pagination) {
      log("TextSearch status: " + status + (results && results.length ? ` (recibidos ${results.length})` : ""));
      if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length) {
        allPlaces.push(...results);
        log("Resultados acumulados: " + allPlaces.length);
        if (pagination && pagination.hasNextPage) {
          setTimeout(() => pagination.nextPage(), 2000);
        } else {
          log("Descargando detalles de cada lugar…");
          fetchDetailsNext(0);
        }
      } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
        log("Sin resultados. Prueba con un radio mayor o una query diferente.");
      } else {
        const tip = helpByStatus[status] || "";
        if (tip) log("Pista: \n" + tip);
      }
    }

    try {
      service.textSearch({ query: q, location: center, radius }, handleTextSearch);
    } catch (e) {
      log("Excepción al llamar textSearch: " + e.message);
    }
  }
</script>
