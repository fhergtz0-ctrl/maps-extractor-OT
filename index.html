<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Extracto de Restaurantes (Google Places)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 20px; max-width: 920px; }
    h1 { margin-bottom: 4px; }
    label { display:block; margin: 10px 0 4px; font-weight: 600; }
    input, button { padding: 8px; }
    input { width: 100%; max-width: 420px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    #log { margin-top: 12px; white-space: pre-wrap; font-size: 14px; background:#f7f7f7; padding:10px; border-radius:8px; min-height: 80px; }
    .hint { color:#555; font-size: 12px; }
    .bar { display:flex; gap:12px; align-items:center; margin-top:12px; }
    .bar button { border-radius: 8px; border: 1px solid #e5e5e5; background:#fff; cursor:pointer; }
    .bar button:hover { background:#f5f5f5; }
  </style>
</head>
<body>
  <h1>Extraer Restaurantes con Google Places</h1>
  <p class="hint"><strong>Paso 4:</strong> Pega tu API key de Google Maps Platform (con <code>Places API</code> y <code>Maps JavaScript API</code> habilitadas) y lanza la búsqueda.</p>

  <label>API Key</label>
  <input id="apiKey" placeholder="AIza... (tu key)" />

  <label>Búsqueda</label>
  <input id="query" value="restaurantes" />

  <label>Centro (lat, lng)</label>
  <div class="row">
    <input id="lat" value="23.2167" />
    <input id="lng" value="-106.4167" />
  </div>
  <div class="hint">Ejemplo: Mazatlán, Sinaloa</div>

  <label>Radio (metros)</label>
  <input id="radius" value="5000" />

  <div class="bar">
    <button id="run">Buscar y generar CSV</button>
  </div>

  <div id="log">Origen detectado: <span id="origin"></span></div>

  <script>
    "use strict";

    // Mostrar el origin real (útil para Website restrictions de la API key)
    document.getElementById("origin").textContent = location.origin;

    function toStr(v){ return (v === null || v === undefined) ? "" : String(v); }
    function esc(v){ return '"' + toStr(v).replace(/"/g, '""') + '"'; }

    function downloadCSV(filename, rows) {
      if (!rows.length) { alert("No hay filas."); return; }
      var headers = Object.keys(rows[0]);
      var lines = [];
      lines.push(headers.map(esc).join(","));
      for (var i=0; i<rows.length; i++){
        var r = rows[i];
        lines.push(headers.map(function(h){ return esc(r[h]); }).join(","));
      }
      var csv = lines.join("\n");
      var blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function log(msg){
      var el = document.getElementById("log");
      el.textContent = (el.textContent ? el.textContent + "\n" : "") + msg;
    }

    document.getElementById("run").addEventListener("click", function(){
      var key = document.getElementById("apiKey").value.trim();
      if (!key) { alert("Coloca tu API key."); return; }

      // Quitar script previo si existe
      var existing = document.querySelector('script[data-dyn="mapsjs"]');
      if (existing) existing.remove();

      // Cargar Google Maps JS (Places)
      var s = document.createElement("script");
      s.src = "https://maps.googleapis.com/maps/api/js?key=" + encodeURIComponent(key) + "&libraries=places&v=quarterly";
      s.async = true; s.defer = true; s.dataset.dyn = "mapsjs";
      s.onload = start;
      s.onerror = function(){
        log("No se pudo cargar Google Maps JS API. Revisa tu API key, las restricciones de dominio y que Places + Maps JS estén habilitadas.");
      };
      document.body.appendChild(s);
    });

    function start() {
      var q = document.getElementById("query").value.trim();
      var lat = parseFloat(document.getElementById("lat").value);
      var lng = parseFloat(document.getElementById("lng").value);
      var radius = parseInt(document.getElementById("radius").value, 10) || 3000;

      document.getElementById("log").textContent = "Inicializando búsqueda…\nOrigen detectado: " + location.origin;

      var dummy = document.createElement("div");
      dummy.style.width = "0"; dummy.style.height = "0"; document.body.appendChild(dummy);

      var center = new google.maps.LatLng(lat, lng);
      var map = new google.maps.Map(dummy, { center: center, zoom: 14 });
      var service = new google.maps.places.PlacesService(map);

      var allPlaces = [];
      var rows = [];

      function fetchDetailsNext(idx) {
        if (idx >= allPlaces.length) {
          log("\nListo. Total filas: " + rows.length);
          downloadCSV("restaurantes.csv", rows);
          return;
        }
        var place = allPlaces[idx];
        var fields = [
          "name","types","website","formatted_phone_number","international_phone_number",
          "formatted_address","address_components","rating","user_ratings_total","url"
        ];
        service.getDetails({ placeId: place.place_id, fields: fields }, function(detail, status){
          if (status === google.maps.places.PlacesServiceStatus.OK && detail) {
            var city = "", state = "";
            (detail.address_components || []).forEach(function(c){
              if (c.types.indexOf("locality") !== -1 || c.types.indexOf("sublocality") !== -1) city = c.long_name;
              if (c.types.indexOf("administrative_area_level_1") !== -1) state = c.long_name;
            });
            rows.push({
              company_name: detail.name || "",
              category: (detail.types || []).join("|"),
              website: detail.website || "",
              phone: detail.formatted_phone_number || detail.international_phone_number || "",
              email: "",
              address: detail.formatted_address || "",
              city: city, state: state,
              rating: (detail.rating != null ? detail.rating : ""),
              rating_count: (detail.user_ratings_total != null ? detail.user_ratings_total : ""),
              reviews: "",
              maplink: detail.url || ""
            });
            log("Detalle " + (idx+1) + "/" + allPlaces.length + ": " + (detail.name || place.place_id));
          } else {
            log("Detalles fallidos para " + (place.name || place.place_id) + ": " + status);
          }
          setTimeout(function(){ fetchDetailsNext(idx+1); }, 180);
        });
      }

      function handleTextSearch(results, status, pagination) {
        if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length) {
          Array.prototype.push.apply(allPlaces, results);
          log("Resultados acumulados: " + allPlaces.length);
          if (pagination && pagination.hasNextPage) {
            setTimeout(function(){ pagination.nextP
