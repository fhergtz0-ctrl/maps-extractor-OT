<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Scrapping Tool ‚Äî Google Places</title>

<!-- CSP b√°sica para que todo funcione con inline scripts/estilos -->
<meta http-equiv="Content-Security-Policy"
      content="
        default-src 'self';
        script-src 'self' https://maps.googleapis.com https://maps.gstatic.com 'unsafe-inline';
        connect-src 'self' https://places.googleapis.com https://api.countapi.xyz https://ipapi.co;
        img-src 'self' data: https://maps.gstatic.com https://maps.googleapis.com https://lh3.googleusercontent.com https://*.ggpht.com;
        style-src 'self' 'unsafe-inline';
        frame-src https://www.google.com;
      ">

<style>
  :root{ --panel:#111; --border:#2a2a2a; --fg:#eaeaea; --muted:#bfbfbf; --accent:#1db954; }
  html,body{margin:0;padding:0;background:#0b0b0b;color:var(--fg);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .app{padding:12px;}

  /* ======= BARRA √öNICA ======= */
  .unibar{
    display:grid;
    /* 12 columnas: KW | Ubi | API | Lat | Web | Email | Radio | SegEmail | Extras | Iniciar | Exportar | spacer */
    grid-template-columns: 1.25fr 1.25fr 1fr .8fr .8fr .8fr .6fr .7fr 1.5fr .9fr .9fr auto;
    gap:8px;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px;align-items:start;
  }
  .cell{display:flex;flex-direction:column;gap:6px;min-width:0}
  .head{font-size:12px;color:var(--muted)}
  textarea,input[type="text"],input[type="number"]{
    width:100%;min-height:36px;box-sizing:border-box;background:#1a1a1a;color:var(--fg);
    border:1px solid var(--border);border-radius:8px;padding:8px 10px;
  }
  textarea{min-height:58px;resize:vertical}
  .checkwrap{height:36px;display:flex;align-items:center;justify-content:center;background:#1a1a1a;border:1px solid var(--border);border-radius:8px;}
  .checkwrap input{transform:scale(1.15)}
  .btn{height:36px;border-radius:8px;border:1px solid var(--border);background:#2b2b2b;color:#fff;font-weight:600;white-space:nowrap;padding:0 12px}
  .btn.primary{background:var(--accent);border-color:#159a45;color:#0b130d}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .extras{display:flex;flex-wrap:wrap;gap:8px;background:#1a1a1a;border:1px solid var(--border);border-radius:8px;padding:6px 8px;align-items:center}
  .extras label{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--fg)}
  .spacer{min-width:10px}

  /* ======= M√âTRICAS ======= */
  #metricsBar{margin:10px 0 0;display:flex;gap:12px;align-items:center;font-size:13px;opacity:.9}
  #metricsBar strong{font-variant-numeric:tabular-nums}

  /* ======= TABLA ======= */
  .panel{margin-top:10px}
  .log{white-space:pre-wrap;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px;margin:10px 0;max-height:120px;overflow:auto}
  .tblwrap{overflow:auto;max-height:65vh;border:1px solid var(--border);border-radius:10px}
  table{table-layout:fixed;width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:8px 10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  thead th{position:relative;background:#161616}
  .col-resizer{position:absolute;right:0;top:0;bottom:0;width:6px;cursor:col-resize}
  .col-resizer:hover{background:rgba(255,255,255,.06)}
  thead input{width:100%;box-sizing:border-box;background:#1a1a1a;color:#fff;border:1px solid var(--border);border-radius:8px;padding:6px 8px}
</style>
</head>
<body>
<div class="app">

  <!-- ====== BARRA √öNICA ====== -->
  <div class="unibar" id="unibar">
    <div class="cell">
      <div class="head">Keywords</div>
      <textarea id="keywords">Restaurante</textarea>
    </div>
    <div class="cell">
      <div class="head">Ubicaciones</div>
      <textarea id="locations">Hermosillo Sonora
Nogales Sonora</textarea>
    </div>
    <div class="cell">
      <div class="head">API Key</div>
      <input type="text" id="apiKey" placeholder="pegar aqui la Key" autocomplete="off" autocapitalize="off" spellcheck="false">
    </div>
    <div class="cell">
      <div class="head">Lat &amp; Long</div>
      <div class="checkwrap"><input type="checkbox" id="includeLatLng" checked disabled></div>
    </div>
    <div class="cell">
      <div class="head">Website</div>
      <div class="checkwrap"><input type="checkbox" id="includeWebsite"></div>
    </div>
    <div class="cell">
      <div class="head">Email</div>
      <div class="checkwrap"><input type="checkbox" id="extractEmail"></div>
    </div>
    <div class="cell">
      <div class="head">Radio (km)</div>
      <input type="number" id="radiusKm" min="0.1" max="50" step="0.1" value="5">
    </div>
    <div class="cell">
      <div class="head">Seg m√°x. email</div>
      <input type="number" id="emailTimeoutTop" min="1" max="20" value="10">
    </div>
    <div class="cell">
      <div class="head">Campos extra</div>
      <div class="extras">
        <label><input type="checkbox" id="tgHours"> Horario</label>
        <label><input type="checkbox" id="tgPrice"> Precio</label>
        <label><input type="checkbox" id="tgMaps"> Maps URI</label>
        <label><input type="checkbox" id="tgPhoto"> Foto</label>
        <label><input type="checkbox" id="tgTypes"> Tipo + Subtipos</label>
        <label><input type="checkbox" id="tgShort"> Short Addr</label>
        <label><input type="checkbox" id="tgSummary"> Resumen</label>
        <label><input type="checkbox" id="tgActions"> Reservas/Delivery</label>
      </div>
    </div>
    <div class="cell">
      <div class="head">&nbsp;</div>
      <button class="btn primary" id="start">Iniciar extracci√≥n</button>
    </div>
    <div class="cell">
      <div class="head">&nbsp;</div>
      <button class="btn" id="export">Descargar</button>
    </div>
    <div class="spacer"></div>
  </div>

  <!-- ====== M√âTRICAS ====== -->
  <div id="metricsBar">
    <span>üëÄ Visitas: <strong id="visitsCount">‚Äî</strong></span>
    <span>‚öôÔ∏è Extracciones: <strong id="runsCount">‚Äî</strong></span>
    <span>üìç Pa√≠s: <strong id="countryLabel">‚Äî</strong></span>
  </div>

  <!-- ====== RESULTADOS ====== -->
  <div class="panel">
    <div class="log" id="log"></div>
    <div class="tblwrap">
      <table id="table">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
"use strict";

/* ============ Helpers UI ============ */
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
function toStr(v){return v==null?"":String(v);}
function escCSV(v){return '"'+toStr(v).replace(/"/g,'""')+'"'}

function log(msg){
  const el=$("#log");
  el.textContent=(el.textContent?el.textContent+"\\n":"")+msg;
  console.log("[ScrappingTool]", msg);
}

function buildPhotoUrl(photoName, apiKey, maxW=800, maxH=600){
  if(!photoName || !apiKey) return "";
  const base = `https://places.googleapis.com/v1/${encodeURIComponent(photoName)}/media`;
  const params = new URLSearchParams({ key: apiKey });
  if(maxW) params.set("maxWidthPx", String(maxW));
  if(maxH) params.set("maxHeightPx", String(maxH));
  return `${base}?${params.toString()}`;
}

/* ============ Toggles ============ */
let includeEmail=false, includeWebsite=false, isRunning=false;
$("#extractEmail").addEventListener("change",e=>{ includeEmail=e.target.checked; renderHeader(); renderBody(); });
$("#includeWebsite").addEventListener("change",e=>{ includeWebsite=e.target.checked; });

const toggles = {
  hours: $("#tgHours").checked || false,
  price: $("#tgPrice").checked || false,
  maps:  $("#tgMaps").checked  || false,
  photo: $("#tgPhoto").checked || false,
  types: $("#tgTypes").checked || false,
  short: $("#tgShort").checked || false,
  summary: $("#tgSummary").checked || false,
  actions: $("#tgActions").checked || false
};
for(const id of Object.keys(toggles)){
  const el = $("#tg"+id.charAt(0).toUpperCase()+id.slice(1));
  el.addEventListener("change", e=>{
    toggles[id]=e.target.checked;
    renderHeader(); renderBody();
  });
}

/* ============ Tabla: columnas ============ */
const BASE_COLS = [
  "KW","Location","Company Name","Category","Website","Phone","email","address",
  "Has Reservation","Reservation Provider","Reservation Link","Delivery Providers",
  "Postal Code + City","state","pin code","# Reviews","Review","CID","MapLink",
  "Lat","Lng","Plus Code","Status","Embed"
];
const DEFAULT_WIDTHS = {
  "KW":120,"Location":140,"Company Name":220,"Category":130,
  "Website":180,"Phone":120,"email":220,"address":340,"Short Address":180,
  "Postal Code + City":160,"state":120,"pin code":100,
  "# Reviews":110,"Review":90,"Price Level":110,"Open Now":110,"Hours (week)":220,
  "CID":150,"MapLink":220,"Maps URI":220,
  "Lat":120,"Lng":120,"Plus Code":150,"Status":150,
  "Primary Type (display)":180,"Subtypes":240,"Editorial Summary":300,"PhotoURL":260,"Embed":220,
  "Has Reservation":130,"Reservation Provider":170,"Reservation Link":220,"Delivery Providers":200
};
const COL_WIDTHS = {...DEFAULT_WIDTHS};
let rows=[];

function currentHeaders(){
  const cols=[...BASE_COLS];

  // Campos extra API
  if(toggles.short) cols.splice(cols.indexOf("Postal Code + City"), 0, "Short Address");
  if(toggles.price) cols.splice(cols.indexOf("CID"), 0, "Price Level");
  if(toggles.hours) cols.splice(cols.indexOf("CID"), 0, "Open Now", "Hours (week)");
  if(toggles.maps) cols.splice(cols.indexOf("Lat"), 0, "Maps URI");
  if(toggles.photo) cols.splice(cols.indexOf("Embed"), 0, "PhotoURL");
  if(toggles.types) cols.splice(cols.indexOf("Status"), 0, "Primary Type (display)","Subtypes");
  if(toggles.summary) cols.splice(cols.indexOf("Embed"), 0, "Editorial Summary");

  // Acciones heur√≠sticas
  if(!toggles.actions){
    for(const c of ["Has Reservation","Reservation Provider","Reservation Link","Delivery Providers"]){
      const i=cols.indexOf(c); if(i>-1) cols.splice(i,1);
    }
  }

  // Website/Email visibles
  if(!includeEmail){ const i=cols.indexOf("email"); if(i>-1) cols.splice(i,1); }
  if(!includeWebsite){ const i=cols.indexOf("Website"); if(i>-1) cols.splice(i,1); }
  return cols;
}

function renderColGroup(){
  const table=$("#table");
  let cg=table.querySelector("colgroup"); if(cg) cg.remove();
  cg=document.createElement("colgroup");
  currentHeaders().forEach(h=>{
    const col=document.createElement("col");
    col.style.width=(COL_WIDTHS[h]||160)+"px";
    cg.appendChild(col);
  });
  table.insertBefore(cg, table.firstChild);
}
function makeHeadersResizable(){
  const table=$("#table");
  const cols=Array.from(table.querySelectorAll("colgroup col"));
  const ths=Array.from(document.querySelectorAll("#thead tr:first-child th"));
  ths.forEach((th,i)=>{
    let g=th.querySelector(".col-resizer");
    if(!g){ g=document.createElement("span"); g.className="col-resizer"; th.appendChild(g); }
    else { const c=g.cloneNode(true); g.replaceWith(c); g=c; }
    g.addEventListener("mousedown",(ev)=>{
      ev.preventDefault();
      const startX=ev.pageX;
      const startW=parseInt((cols[i].style.width||th.offsetWidth)+"",10)||th.offsetWidth;
      function onMove(e){
        const nw=Math.max(60,startW+(e.pageX-startX));
        cols[i].style.width=nw+"px";
        const head=currentHeaders()[i]; if(head) COL_WIDTHS[head]=nw;
      }
      function onUp(){ document.removeEventListener("mousemove",onMove); document.removeEventListener("mouseup",onUp); }
      document.addEventListener("mousemove",onMove);
      document.addEventListener("mouseup",onUp);
    });
  });
}
function renderHeader(){
  renderColGroup();
  const thead=$("#thead"); thead.innerHTML="";
  const tr1=document.createElement("tr"), tr2=document.createElement("tr");
  currentHeaders().forEach(h=>{
    const th=document.createElement("th"); th.textContent=h; tr1.appendChild(th);
    const th2=document.createElement("th");
    const inp=document.createElement("input"); inp.placeholder="filtrar‚Ä¶"; inp.dataset.col=h; inp.addEventListener("input",renderBody);
    th2.appendChild(inp); tr2.appendChild(th2);
  });
  thead.appendChild(tr1); thead.appendChild(tr2);
  makeHeadersResizable();
}
function renderBody(){
  const tbody=$("#tbody"); tbody.innerHTML="";
  const filters={}; $$("#thead input").forEach(i=>{ const v=i.value.trim().toLowerCase(); if(v) filters[i.dataset.col]=v;});
  const cols=currentHeaders();
  const data=rows.map(r=>{const pruned={}; cols.forEach(c=>pruned[c]=r[c]??""); return pruned;})
                 .filter(r=>{ for(const k in filters){ if(!toStr(r[k]).toLowerCase().includes(filters[k])) return false; } return true; });
  for(const r of data){
    const tr=document.createElement("tr"); cols.forEach(h=>{ const td=document.createElement("td"); td.textContent=toStr(r[h]??""); tr.appendChild(td); });
    tbody.appendChild(tr);
  }
}
renderHeader(); renderBody();

/* ===== Export ===== */
$("#export").addEventListener("click",()=>{
  if(!rows.length){ alert("No hay filas."); return; }
  const cols=currentHeaders();
  const csv=[ cols.map(escCSV).join(",") ];
  for(const r of rows){ csv.push( cols.map(h=>escCSV(r[h]??"")).join(",") ); }
  const blob=new Blob([csv.join("\n")],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="resultados-scrapping.csv"; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

/* ===== FieldMask din√°mico ===== */
function buildFieldMask(){
  const fm = [
    "places.id",
    "places.displayName",
    "places.primaryType",
    "places.types",
    "places.formattedAddress",
    "places.addressComponents",
    "places.location",
    "places.plusCode",
    "places.businessStatus",
    "places.nationalPhoneNumber",
    "places.internationalPhoneNumber",
    "places.rating",
    "places.userRatingCount"
  ];
  if(toggles.short) fm.push("places.shortFormattedAddress");
  if(toggles.price) fm.push("places.priceLevel");
  if(toggles.maps)  fm.push("places.googleMapsUri");
  if(toggles.hours){
    fm.push("places.currentOpeningHours.openNow","places.currentOpeningHours.weekdayDescriptions");
  }
  if(toggles.types){
    fm.push("places.primaryTypeDisplayName","places.subtypes");
  }
  if(toggles.summary) fm.push("places.editorialSummary");
  if(toggles.photo)   fm.push("places.photos.name");
  fm.push("nextPageToken");
  return fm.join(",");
}

/* ===== Acciones (reservas/delivery) ===== */
function fetchHtml(url, timeoutMs){
  const ctrl=new AbortController();
  const to=setTimeout(()=>ctrl.abort(), timeoutMs);
  return fetch(url,{mode:"cors",signal:ctrl.signal})
    .then(r=>r.text())
    .catch(()=> "")
    .finally(()=>clearTimeout(to));
}
const RESERVATION_PROVIDERS = [
  {name:"OpenTable", match:/opentable\./i},
  {name:"TheFork", match:/(thefork\.|eltenedor\.)/i},
  {name:"Tock", match:/exploretock\.com/i},
  {name:"SevenRooms", match:/sevenrooms\.com/i},
  {name:"Resy", match:/resy\.com/i},
  {name:"Yelp Reservations", match:/yelp\.com\/reservations/i}
];
const DELIVERY_PROVIDERS = [
  {name:"Rappi", match:/rappi\./i},
  {name:"Uber Eats", match:/ubereats\.|ubereats/i},
  {name:"DoorDash", match:/doordash\./i},
  {name:"Just Eat", match:/just\-eat|menulog\./i},
  {name:"Didi Food", match:/didi.*food|didi\.mx\/food/i}
];
function detectActionsFromHtml(html){
  const out={hasReservation:"",reservationProvider:"",reservationLink:"",deliveryProviders:[]};
  if(!html) return out;
  const links=Array.from(html.matchAll(/href\s*=\s*["']([^"']+)["']/gi)).map(m=>m[1]);
  for(const p of RESERVATION_PROVIDERS){
    const link=links.find(h=>p.match.test(h));
    if(link){ out.hasReservation="yes"; out.reservationProvider=p.name; out.reservationLink=link; break; }
  }
  for(const p of DELIVERY_PROVIDERS){
    if(links.some(h=>p.match.test(h))) out.deliveryProviders.push(p.name);
  }
  return out;
}

/* ===== Google Places ===== */
async function textSearchAll({apiKey,textQuery,center,radius=5000,language="es"}){
  const url="https://places.googleapis.com/v1/places:searchText";
  const headers={
    "Content-Type":"application/json",
    "X-Goog-Api-Key":apiKey,
    "X-Goog-FieldMask": buildFieldMask()
  };
  const out=[]; let pageToken=null;
  do{
    const body={ textQuery, languageCode:language,
      locationBias:{ circle:{ center:{ latitude:center.lat, longitude:center.lng }, radius } },
      pageSize:20, pageToken };
    const res=await fetch(url,{method:"POST",headers,body:JSON.stringify(body)});
    if(!res.ok){ const t=await res.text().catch(()=>String(res.status)); throw new Error(`HTTP ${res.status} en searchText: ${t}`); }
    const data=await res.json(); out.push(...(data.places||[])); pageToken=data.nextPageToken||null;
    if(pageToken) await new Promise(r=>setTimeout(r,300));
  }while(pageToken);
  return out;
}
async function geocodeAddress(geocoder, address){
  try{
    const { results } = await geocoder.geocode({ address });
    if(results && results[0]){
      const { lat, lng } = results[0].geometry.location;
      return { lat: lat(), lng: lng() };
    }
    return null;
  }catch{ return null; }
}
async function tryExtractEmail(url, timeoutMs){
  const ctrl=new AbortController(); const to=setTimeout(()=>ctrl.abort(),timeoutMs);
  try{
    const res=await fetch(url,{mode:"cors",signal:ctrl.signal});
    const txt=await res.text(); const m=txt.match(/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}/i);
    return m?m[0]:"";
  }catch{ return ""; } finally{ clearTimeout(to); }
}

/* ===== M√âTRICAS (CountAPI + pa√≠s por IP) ===== */
const COUNT_NS = (location.hostname || 'local'); // puedes fijarlo a tu dominio si prefieres
const KEY_VIEWS = 'pageviews';
const KEY_RUNS  = 'runs';

async function countapiHit(ns,key){
  try{
    const r = await fetch(`https://api.countapi.xyz/hit/${encodeURIComponent(ns)}/${encodeURIComponent(key)}`);
    const j = await r.json(); return j.value ?? null;
  }catch{ return null; }
}
async function countapiGet(ns,key){
  try{
    const r = await fetch(`https://api.countapi.xyz/get/${encodeURIComponent(ns)}/${encodeURIComponent(key)}`);
    const j = await r.json(); return j.value ?? null;
  }catch{ return null; }
}
async function updateMetricsUI(initRuns=false){
  const v = await countapiHit(COUNT_NS, KEY_VIEWS);
  const runs = initRuns ? await countapiHit(COUNT_NS, KEY_RUNS) : await countapiGet(COUNT_NS, KEY_RUNS);
  if($('#visitsCount')) $('#visitsCount').textContent = v ?? '‚Äî';
  if($('#runsCount'))   $('#runsCount').textContent   = runs ?? '‚Äî';
  try{
    const geo = await fetch('https://ipapi.co/json/').then(r=>r.json());
    const label = geo?.country_name ? `${geo.country_name} (${geo.country})` : '‚Äî';
    if($('#countryLabel')) $('#countryLabel').textContent = label;
  }catch{ if($('#countryLabel')) $('#countryLabel').textContent='‚Äî'; }
}
updateMetricsUI(false);

/* ===== Start ===== */
window.addEventListener('unhandledrejection',e=>log('Error no capturado: '+(e?.reason?.message||String(e?.reason||e))));
$("#start").addEventListener("click", start);

async function start(){
  if(isRunning) return; isRunning=true; $("#start").disabled=true;
  try{
    const key=($("#apiKey").value||"").trim();
    if(!key){ alert("Coloca tu API key para ejecutar la b√∫squeda."); return; }

    // incrementa contador de usos y actualiza UI
    try{
      const runsNow = await countapiHit(COUNT_NS, KEY_RUNS);
      if($('#runsCount')) $('#runsCount').textContent = runsNow ?? '‚Äî';
    }catch{}

    if(!window.google || !google.maps || !google.maps.importLibrary){
      const s=document.createElement("script");
      s.src="https://maps.googleapis.com/maps/api/js?key="+encodeURIComponent(key)+"&v=quarterly";
      s.async=true; s.defer=true; s.onerror=()=>log("No se pudo cargar Maps JS.");
      document.body.appendChild(s); await new Promise(r=>s.onload=r);
    }

    const keywords=$("#keywords").value.split("\n").map(s=>s.trim()).filter(Boolean);
    const locations=$("#locations").value.split("\n").map(s=>s.trim()).filter(Boolean);
    if(!keywords.length || !locations.length){ alert("Agrega al menos 1 keyword y 1 ubicaci√≥n."); return; }

    const emailTimeout=Math.max(1,Math.min(20,parseInt($("#emailTimeoutTop").value,10)||10));
    const radiusKm=Math.max(0.1,Math.min(50,parseFloat($("#radiusKm").value)||5));
    const radiusMeters=Math.round(radiusKm*1000);
    const language="es";

    rows=[]; renderHeader(); renderBody();

    const { Place } = await google.maps.importLibrary("places");
    const geocoder=new google.maps.Geocoder();

    let combo=0, total=keywords.length*locations.length;
    for(const kw of keywords){
      for(const loc of locations){
        combo++; log(`(${combo}/${total}) ${kw} @ ${loc} (radio ${radiusKm} km)`);

        const center=await geocodeAddress(geocoder, loc);
        if(!center){ log(`No se pudo geocodificar: ${loc}`); continue; }

        let places=[];
        try{ places=await textSearchAll({apiKey:key,textQuery:kw,center,radius:radiusMeters,language}); }
        catch(err){ log(`Error "${kw}" @ "${loc}": ${err?.message||err}`); continue; }

        let i=0;
        for(const p of places){
          i++;
          const name=(typeof p.displayName==="string")?p.displayName: (p.displayName?.text || "");
          let city="",state="",postal="";
          if(Array.isArray(p.addressComponents)){
            for(const c of p.addressComponents){
              const t=c.types||[]; const v=c.longText||c.long_name||c.name||"";
              if(t.includes("locality")||t.includes("sublocality")||t.includes("postal_town")) city=city||v;
              if(t.includes("administrative_area_level_1")) state=state||v;
              if(t.includes("postal_code")) postal=postal||v;
            }
          }
          const phone=p.nationalPhoneNumber||p.internationalPhoneNumber||"";
          const mapLink="https://www.google.com/maps/search/?api=1&query="+encodeURIComponent((name||" ")+" "+(p.formattedAddress||""));
          const embed="https://www.google.com/maps?q="+encodeURIComponent((name||" ")+" "+(p.formattedAddress||""))+"&output=embed";

          /* Campos extra API */
          const shortAddr   = toggles.short  ? (p.shortFormattedAddress || "") : "";
          const priceLevel  = toggles.price  ? (p.priceLevel ?? "")+"" : "";
          const mapsUri     = toggles.maps   ? (p.googleMapsUri || "") : "";
          const openNow     = toggles.hours  ? (p.currentOpeningHours?.openNow===true ? "yes" : (p.currentOpeningHours?.openNow===false ? "no" : "")) : "";
          const hoursWeek   = toggles.hours  ? (p.currentOpeningHours?.weekdayDescriptions||[]).join(" | ") : "";
          const typeDisp    = toggles.types  ? (p.primaryTypeDisplayName || "") : "";
          const subTypes    = toggles.types  ? (Array.isArray(p.subtypes)?p.subtypes.join("|"):"") : "";
          const summary     = toggles.summary? (p.editorialSummary?.overview || "") : "";
          let photoUrl = "";
          if(toggles.photo){
            const photos = Array.isArray(p.photos) ? p.photos : [];
            const firstPhotoName = photos[0]?.name || "";
            photoUrl = buildPhotoUrl(firstPhotoName, key, 800, 600);
          }

          /* Website + Email (detail fetch si se requieren o si actions) */
          let websiteUri="";
          if(includeWebsite || includeEmail || toggles.actions){
            try{
              const detail=new Place({id:p.id,requestedLanguage:language,region:"mx"});
              await detail.fetchFields({fields:["websiteUri"]});
              websiteUri=detail.websiteUri||"";
            }catch(_){}
          }
          let email="";
          if(includeEmail && websiteUri){
            try{ email=await tryExtractEmail(websiteUri,emailTimeout*1000);}catch(_){ email=""; }
          }

          /* Acciones heur√≠sticas */
          let hasReservation="", reservationProvider="", reservationLink="", deliveryProviders="";
          if(toggles.actions && websiteUri){
            try{
              const html = await fetchHtml(websiteUri, emailTimeout*1000);
              const det = detectActionsFromHtml(html);
              hasReservation = det.hasReservation;
              reservationProvider = det.reservationProvider;
              reservationLink = det.reservationLink;
              deliveryProviders = det.deliveryProviders.join("|");
            }catch(_){}
          }

          rows.push({
            "KW":kw,"Location":loc,"Company Name":name,
            "Category":p.primaryType||(p.types?p.types[0]:""),
            "Website":websiteUri||"","Phone":phone,"email":email,"address":p.formattedAddress||"",
            "Has Reservation":hasReservation,"Reservation Provider":reservationProvider,"Reservation Link":reservationLink,"Delivery Providers":deliveryProviders,
            "Short Address": shortAddr,
            "Postal Code + City":(postal?postal+" ":"")+(city||""),"state":state||"","pin code":postal||"",
            "# Reviews":p.userRatingCount??"","Review":p.rating??"","Price Level":priceLevel,
            "Open Now":openNow,"Hours (week)":hoursWeek,
            "CID":"",
            "MapLink":mapLink,"Maps URI":mapsUri,
            "Lat":(p.location&&(p.location.lat??p.location.latitude))??"",
            "Lng":(p.location&&(p.location.lng??p.location.longitude))??"",
            "Plus Code":(p.plusCode?.compoundCode||p.plusCode?.globalCode||""),
            "Status":p.businessStatus||"",
            "Primary Type (display)": typeDisp, "Subtypes": subTypes,
            "Editorial Summary": summary, "PhotoURL": photoUrl,
            "Embed":embed
          });

          if(i%5===0) renderBody();
        }
        renderBody();
      }
    }
    log("Proceso finalizado.");
  }catch(err){
    log("Fallo inesperado: "+(err?.message||err));
  }finally{
    isRunning=false; $("#start").disabled=false;
  }
}
</script>
</body>
</html>
