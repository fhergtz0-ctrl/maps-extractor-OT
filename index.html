<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scrapping Tool ‚Äî Google Maps Places</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üó∫Ô∏è</text></svg>">

<style>
  :root{
    --bg:#0f1115;
    --panel:#151821;
    --muted:#99a1b3;
    --text:#e7eaf3;
    --accent:#3b82f6;
    --green:#22c55e;
    --red:#ef4444;
    --chip:#1d2332;
    --chip2:#0b1320;
    --border:#242a38;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  h1{font-size:20px;margin:0 0 8px}
  small, .muted{color:var(--muted)}
  .wrap{max-width:1280px;margin:0 auto;padding:16px}
  .toolbar{
    display:grid;gap:10px;
    grid-template-columns: 1.2fr 1fr 0.8fr 0.9fr 0.9fr 0.9fr auto;
    align-items:end;background:var(--panel);padding:12px;border-radius:12px;border:1px solid var(--border)
  }
  .field label{display:block;margin:0 0 6px;color:var(--muted);font-weight:600}
  .input, textarea, select{
    width:100%;border:1px solid var(--border);border-radius:10px;background:#0d111a;color:var(--text);
    padding:10px 12px;outline:none
  }
  textarea{min-height:44px;max-height:120px;resize:vertical}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{
    display:inline-flex;align-items:center;gap:8px;background:var(--chip);
    border:1px solid var(--border);padding:8px 10px;border-radius:999px
  }
  .chip input{accent-color:var(--accent)}
  .btn{
    border:1px solid var(--border);background:var(--chip2);padding:10px 14px;border-radius:10px;color:var(--text);
    cursor:pointer;display:inline-flex;gap:8px;align-items:center;font-weight:600
  }
  .btn:hover{border-color:#2f374a}
  .btn.primary{background:var(--green);border-color:transparent;color:#051108}
  .btn.secondary{background:var(--panel)}
  .stats-bar{display:flex;gap:16px;align-items:center;margin:12px 0}
  .stat{background:var(--panel);border:1px solid var(--border);padding:10px 12px;border-radius:10px}
  .log{white-space:pre-wrap;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;margin:12px 0;min-height:100px}
  /* Table */
  .results{
    margin-top:10px;background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:auto
  }
  table{border-collapse:separate;border-spacing:0;width:100%;min-width:1400px}
  thead th{
    position:sticky;top:0;background:#111520;border-bottom:1px solid var(--border);padding:12px;text-align:left
  }
  tbody td{padding:10px;border-bottom:1px solid #1e2435;vertical-align:top}
  thead input{
    width:100%;padding:6px 8px;border-radius:8px;background:#0d111a;border:1px solid var(--border);color:var(--muted)
  }
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0e1a2b;border:1px solid #22324e;color:#9db7e5}
  .note{font-size:12px;color:var(--muted)}
  .right{justify-self:end}
  .two-col{display:flex;gap:10px}
  .two-col > *{flex:1}
  .danger{color:var(--red)}
  .ok{color:var(--green)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Scrapping Tool ‚Äî <span class="muted">Google Maps Places</span></h1>
  <div class="note">Barra √∫nica, resultados paginados por combinaci√≥n, columnas separadas para Estado / Ciudad / Colonia / CP. Marca los ‚ÄúCampos extra‚Äù que desees.</div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="field">
      <label>Keywords <span class="note">(uno por l√≠nea)</span></label>
      <textarea id="kw" placeholder="restaurantes&#10;taquer√≠a"></textarea>
    </div>
    <div class="field">
      <label>Ciudad(es)</label>
      <textarea id="cities" placeholder="hermosillo"></textarea>
    </div>
    <div class="field">
      <label>Estado(s)</label>
      <textarea id="states" placeholder="sonora"></textarea>
    </div>
    <div class="field">
      <label>Colonia(s) <span class="note">(opcional)</span></label>
      <textarea id="colonies" placeholder="centro"></textarea>
    </div>
    <div class="field">
      <label>C√≥digos postales <span class="note">(opcional)</span></label>
      <textarea id="zips" placeholder="83000&#10;83290"></textarea>
    </div>
    <div class="field">
      <label>API Key</label>
      <input id="apikey" class="input" placeholder="Pegar aqu√≠ la Key" />
      <div class="chips" style="margin-top:8px">
        <label class="chip"><input type="checkbox" id="wantLatLng" checked> <span>Lat &amp; Long</span></label>
        <label class="chip"><input type="checkbox" id="wantWebsite" checked> <span>Website</span></label>
        <label class="chip"><input type="checkbox" id="wantEmail"> <span>Email</span></label>
      </div>
    </div>
    <div class="field right">
      <div class="two-col">
        <div>
          <label>Radio por consulta (km)</label>
          <input id="radiusKm" class="input" type="number" min="1" value="3" />
        </div>
        <div>
          <label>Seg m√°x. email</label>
          <input id="emailWait" class="input" type="number" min="3" value="10" />
        </div>
      </div>
      <div style="margin-top:10px">
        <div class="chips">
          <label class="chip"><input type="checkbox" id="xHorario"> <span>Horario</span></label>
          <label class="chip"><input type="checkbox" id="xPrecio"> <span>Precio</span></label>
          <label class="chip"><input type="checkbox" id="xMapsUri"> <span>Maps URI</span></label>
          <label class="chip"><input type="checkbox" id="xFoto"> <span>Foto</span></label>
          <label class="chip"><input type="checkbox" id="xTipos" checked> <span>Tipo + Subtipos</span></label>
          <label class="chip"><input type="checkbox" id="xShort"> <span>Short Addr</span></label>
          <label class="chip"><input type="checkbox" id="xResumen"> <span>Resumen</span></label>
          <label class="chip"><input type="checkbox" id="xPartners" checked> <span>Partners (Reserva/Delivery)</span></label>
        </div>
      </div>
      <div class="row" style="margin-top:10px;justify-content:flex-end">
        <button id="start" class="btn primary">Iniciar</button>
        <button id="download" class="btn secondary">Descargar</button>
        <div class="stat">Resultados: <b id="count">0</b></div>
      </div>
    </div>
  </div>

  <!-- M√©tricas -->
  <div class="stats-bar">
    <div class="stat">üëÅÔ∏è Visitas: <span id="visits">‚Äî</span></div>
    <div class="stat">‚öôÔ∏è Extracciones: <span id="runs">‚Äî</span></div>
    <div class="stat">üìç Pa√≠s: <span id="country">‚Äî</span></div>
  </div>

  <!-- Log -->
  <div id="log" class="log">Listo para iniciar‚Ä¶</div>

  <!-- Tabla -->
  <div class="results">
    <table id="tbl">
      <thead>
        <tr>
          <th>KW<br><input data-col="kw" placeholder="filtrar‚Ä¶"></th>
          <th>State<br><input data-col="state" placeholder="filtrar‚Ä¶"></th>
          <th>City<br><input data-col="city" placeholder="filtrar‚Ä¶"></th>
          <th>Colony<br><input data-col="colony" placeholder="filtrar‚Ä¶"></th>
          <th>Postal Code<br><input data-col="postal" placeholder="filtrar‚Ä¶"></th>
          <th>Company Name<br><input data-col="name" placeholder="filtrar‚Ä¶"></th>
          <th>Category<br><input data-col="cat" placeholder="filtrar‚Ä¶"></th>
          <th>Website<br><input data-col="web" placeholder="filtrar‚Ä¶"></th>
          <th>Phone<br><input data-col="phone" placeholder="filtrar‚Ä¶"></th>
          <th>email<br><input data-col="email" placeholder="filtrar‚Ä¶"></th>
          <th>address<br><input data-col="addr" placeholder="filtrar‚Ä¶"></th>
          <th>Lat<br><input data-col="lat" placeholder="filtrar‚Ä¶"></th>
          <th>Lng<br><input data-col="lng" placeholder="filtrar‚Ä¶"></th>
          <th class="opt xHorario">Horario</th>
          <th class="opt xPrecio">Precio</th>
          <th class="opt xMapsUri">Maps URI</th>
          <th class="opt xFoto">Foto</th>
          <th class="opt xTipos">Tipo + Subtipos</th>
          <th class="opt xShort">Short Addr</th>
          <th class="opt xResumen">Resumen</th>
          <th class="opt xPartners">Partners</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* =============== Utilidades UI =============== */
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];

function log(msg){
  const el = $("#log");
  el.textContent += (el.textContent ? "\n" : "") + msg;
  el.scrollTop = el.scrollHeight;
}

/* =============== M√©tricas (CountAPI + ipapi) =============== */
(async function updateMetrics(){
  try{
    const base = location.host || "maps-extractor-ot.vercel.app";
    const get = (k)=>fetch(`https://api.countapi.xyz/get/${base}/${k}`).then(r=>r.json()).catch(()=>({value:"‚Äî"}));
    const hit = (k)=>fetch(`https://api.countapi.xyz/hit/${base}/${k}`).then(r=>r.json()).catch(()=>({value:"‚Äî"}));
    const [v1,r1,country] = await Promise.all([get("pageviews"), get("runs"), fetch("https://ipapi.co/json/").then(r=>r.json()).catch(()=>({country_name:"‚Äî"}))]);
    $("#visits").textContent = v1.value ?? "‚Äî";
    $("#runs").textContent = r1.value ?? "‚Äî";
    $("#country").textContent = `${country.country_name || "‚Äî"} (${country.country || "?"})`;
    // Sube contadores
    hit("pageviews");
  }catch(e){}
})();

/* =============== Helpers =============== */
const sleep = ms => new Promise(r=>setTimeout(r, ms));
function val(id){ return $(id).value.trim(); }
function arrLines(id){
  const t = $(id).value.trim();
  if(!t) return [];
  return t.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
}
function uniqBy(arr, key){
  const map = new Map();
  for (const x of arr) map.set(key(x), x);
  return [...map.values()];
}
function toCSV(rows){
  const esc = s => `"${String(s??"").replace(/"/g,'""')}"`;
  const header = Object.keys(rows[0]||{}).map(esc).join(",");
  const body = rows.map(r=>Object.values(r).map(esc).join(",")).join("\n");
  return header + "\n" + body;
}
function downloadFile(name, data, mime="text/csv"){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([data], {type:mime}));
  a.download = name;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* =============== Columnas Opcionales (visibilidad) =============== */
function syncOptionalCols(){
  const opts = ["xHorario","xPrecio","xMapsUri","xFoto","xTipos","xShort","xResumen","xPartners"];
  for(const o of opts){
    const on = $("#"+o).checked;
    $$(".opt."+o).forEach(th => th.style.display = on ? "" : "none");
    const idx = [...thRow.children].findIndex(c=>c.classList.contains(o));
    if(idx>=0){
      // cuerpo: mismas columnas
      [...tbody.rows].forEach(row=>{
        const cell = row.children[idx];
        if(cell) cell.style.display = on ? "" : "none";
      });
    }
  }
}

/* =============== Geocoding (por CP o texto) =============== */
async function geocodeText(address, apiKey){
  const url = new URL("https://maps.googleapis.com/maps/api/geocode/json");
  url.searchParams.set("address", address);
  url.searchParams.set("key", apiKey);
  const r = await fetch(url.href);
  const j = await r.json();
  if(j.status!=="OK" || !j.results?.length) throw new Error("No geocoding result");
  const g = j.results[0];
  const loc = g.geometry.location;
  return {
    lat: loc.lat, lng: loc.lng,
    postal: (g.address_components||[]).find(c=>c.types.includes("postal_code"))?.long_name || "",
    state: (g.address_components||[]).find(c=>c.types.includes("administrative_area_level_1"))?.long_name || "",
    city: (g.address_components||[]).find(c=>c.types.includes("locality")||c.types.includes("postal_town"))?.long_name || "",
    colony: (g.address_components||[]).find(c=>c.types.includes("sublocality") || c.types.includes("sublocality_level_1"))?.long_name || "",
    formatted: g.formatted_address
  };
}

/* =============== Places v1: searchText + paginaci√≥n =============== */
async function textSearchAll({apiKey, textQuery, center, radiusMeters, fieldMask}){
  const out = [];
  let pageToken = null;
  for(let round=0; round<8; round++){ // hasta ~160 resultados (depende disponibilidad)
    const body = pageToken ? {pageToken} : {
      textQuery,
      languageCode:"es",
      locationBias:{
        circle:{
          center:{ latLng:{ latitude:center.lat, longitude:center.lng } },
          radius: radiusMeters
        }
      }
    };
    const r = await fetch("https://places.googleapis.com/v1/places:searchText", {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "X-Goog-Api-Key": apiKey,
        "X-Goog-FieldMask": fieldMask
      },
      body: JSON.stringify(body)
    });
    if(!r.ok){
      const t = await r.text().catch(()=>r.statusText);
      throw new Error(`HTTP ${r.status} en searchText: ${t}`);
    }
    const j = await r.json();
    const arr = j.places || [];
    out.push(...arr);
    pageToken = j.nextPageToken || null;
    if(!pageToken) break;
    await sleep(1100); // respeta cuota/paginaci√≥n
  }
  return out;
}

/* =============== Place Details (website) =============== */
async function fetchDetails(apiKey, placeId){
  const url = `https://places.googleapis.com/v1/places/${encodeURIComponent(placeId)}`;
  const heads = {
    "X-Goog-Api-Key": apiKey,
    "X-Goog-FieldMask": "id,websiteUri"
  };
  const r = await fetch(url, {headers: heads});
  if(!r.ok) return {};
  return r.json();
}

/* =============== Email y Partners via r.jina.ai =============== */
function extractEmails(text){
  const re = /([a-zA-Z0-9._%+-]+)@([a-zA-Z0-9.-]+)\.([a-zA-Z]{2,})/g;
  const set = new Set();
  text.replace(re,(m)=>{ if(m.length<=120) set.add(m.toLowerCase());});
  return [...set].join(" | ");
}
function detectPartners(text,url){
  const low = (text||"").toLowerCase();
  const tests = [
    ["OpenTable","opentable"],
    ["UberEats","ubereats"],
    ["Rappi","rappi"],
    ["DoorDash","doordash"],
    ["Didi Food","didi food"],
    ["Resy","resy"],
    ["Tock","exploretock"]
  ];
  const hits = [];
  for(const [label,needle] of tests){
    if(low.includes(needle)) hits.push(label);
  }
  // pistas de reserva/delivery gen√©ricas
  const flags = [
    ["Reservas","reserv"],
    ["Delivery","delivery"],
    ["Pedido","pedido"],
    ["Order","order"]
  ];
  for(const [label,needle] of flags){
    if(low.includes(needle)) hits.push(label);
  }
  // dominio mismo
  if((url||"").includes("opentable")) hits.push("OpenTable (dominio)");
  return [...new Set(hits)].join(" | ");
}
async function fetchSiteText(url, timeoutMs=15000){
  if(!/^https?:\/\//i.test(url)) return "";
  const ctl = new AbortController();
  const t = setTimeout(()=>ctl.abort(), timeoutMs);
  try{
    const prox = "https://r.jina.ai/http/" + url.replace(/^https?:\/\//,'');
    const r = await fetch(prox, {signal: ctl.signal});
    if(!r.ok) return "";
    return await r.text();
  }catch(e){ return ""; } finally{ clearTimeout(t); }
}

/* =============== Tabla =============== */
const tbody = $("#tbl tbody");
const thRow = $("#tbl thead tr");
let allRows = [];

function clearTable(){
  tbody.innerHTML = "";
  allRows.length = 0;
  $("#count").textContent = "0";
}
function pushRow(obj){
  allRows.push(obj);
  const tr = document.createElement("tr");

  const cols = [
    "kw","state","city","colony","postal","name","cat","web","phone","email",
    "addr","lat","lng","Horario","Precio","MapsURI","Foto","Tipos","ShortAddr","Resumen","Partners"
  ];
  for(const k of cols){
    const td = document.createElement("td");
    const v = obj[k] ?? "";
    if(k==="web" && v){
      td.innerHTML = `<a href="${v}" target="_blank" rel="noreferrer">${v}</a>`;
    }else if(k==="MapsURI" && v){
      td.innerHTML = `<a href="${v}" target="_blank" rel="noreferrer">Abrir</a>`;
    }else{
      td.textContent = v;
    }
    td.className = (["Horario","Precio","MapsURI","Foto","Tipos","ShortAddr","Resumen","Partners"].includes(k) ? "opt c-"+k : "");
    tr.appendChild(td);
  }
  tbody.appendChild(tr);
  $("#count").textContent = String(allRows.length);
  syncOptionalCols();
}
function applyFilters(){
  const f = {};
  $$("#tbl thead input[data-col]").forEach(i=>f[i.dataset.col]=i.value.toLowerCase());
  for(const tr of tbody.rows){
    const data = Array.from(tr.cells).map(td=>(td.textContent||"").toLowerCase());
    const map = {
      kw: data[0], state: data[1], city: data[2], colony: data[3], postal: data[4],
      name: data[5], cat: data[6], web: data[7], phone: data[8], email: data[9],
      addr: data[10], lat: data[11], lng: data[12]
    };
    let ok = true;
    for(const k in f){
      if(f[k] && !(map[k]||"").includes(f[k])){ ok=false;break; }
    }
    tr.style.display = ok ? "" : "none";
  }
}
$$("#tbl thead input[data-col]").forEach(i=>i.addEventListener("input", applyFilters));

/* =============== FieldMask para Places v1 =============== */
function buildFieldMask(){
  const base = [
    "places.id",
    "places.displayName",
    "places.primaryType",
    "places.types",
    "places.formattedAddress",
    "places.addressComponents",
    "places.location",
    "places.plusCode",
    "places.businessStatus",
    "places.nationalPhoneNumber",
    "places.internationalPhoneNumber",
    "places.rating",
    "places.userRatingCount",
    "places.priceLevel",
    "places.googleMapsUri",
    "places.currentOpeningHours.openNow",
    "places.currentOpeningHours.weekdayDescriptions",
    "places.primaryTypeDisplayName",
    "places.editorialSummary",
    "nextPageToken"
  ];
  // ojo: 'places.subtypes' NO existe en v1 ‚Üí usamos places.types
  return base.join(",");
}

/* =============== Start =============== */
$("#start").addEventListener("click", async ()=>{
  const apiKey = $("#apikey").value.trim();
  if(!apiKey){ log("‚ö†Ô∏è Coloca tu API Key"); return; }

  // m√©trica de run
  fetch(`https://api.countapi.xyz/hit/${location.host||"maps-extractor-ot.vercel.app"}/runs`).catch(()=>{});

  clearTable();
  $("#log").textContent = "Iniciando‚Ä¶";

  const keywords = arrLines("#kw");
  const cities   = arrLines("#cities");
  const states   = arrLines("#states");
  const colonies = arrLines("#colonies");
  const zips     = arrLines("#zips");
  const radiusKm = parseFloat($("#radiusKm").value) || 3;
  const wantLatLng = $("#wantLatLng").checked;
  const wantWebsite = $("#wantWebsite").checked;
  const wantEmail = $("#wantEmail").checked;
  const emailWait = Math.max(3, parseInt($("#emailWait").value || "10",10));

  if(!keywords.length || (!cities.length && !zips.length)){
    log("‚ö†Ô∏è Debes escribir al menos un keyword y ciudad o CP.");
    return;
  }

  // generar seeds de ubicaci√≥n
  let seeds = [];
  const country = "MX"; // puedes permitir cambiar esto en UI si lo deseas

  if(zips.length){
    for(const zip of zips){
      // si hay ciudad/estado, mejor precisi√≥n
      const ctx = [zip, cities[0]||"", states[0]||"", country].filter(Boolean).join(", ");
      seeds.push({ label:`CP ${zip}`, query: ctx, zip });
    }
  }else{
    // colonia + ciudad + estado
    const combos = [];
    const ci = cities.length?cities:[""];
    const st = states.length?states:[""];
    const co = colonies.length?colonies:[""];
    for(const c of ci) for(const s of st) for(const col of co){
      const q = [col,c,s,country].filter(Boolean).join(", ");
      combos.push({label:`${col||""} ${c} ${s}`.trim(), query:q});
    }
    seeds = combos;
  }

  log(`Se generaron ${seeds.length} ubicaci√≥n(es).`);

  // FieldMask
  const fieldMask = buildFieldMask();

  // iterar combinaciones
  const radiusMeters = Math.max(1, radiusKm) * 1000;
  const resultsSet = new Map(); // deduplicar por place.id + kw

  for(const seed of seeds){
    log(`Buscando "${keywords.join(" | ")}" @ "${seed.label}" (radio ${radiusKm} km)‚Ä¶`);
    // geocode seed
    let center;
    try{
      const g = await geocodeText(seed.query, apiKey);
      center = {lat:g.lat, lng:g.lng};
    }catch(e){
      log(`‚ö†Ô∏è No se pudo geocodificar: ${seed.query}`);
      continue;
    }

    for(const kw of keywords){
      try{
        const places = await textSearchAll({
          apiKey, textQuery: kw, center, radiusMeters, fieldMask
        });

        for(const p of places){
          const ac = p.addressComponents || [];
          const get = t => ac.find(c=>c.types?.includes(t))?.longText || ac.find(c=>c.types?.includes(t))?.long_name || "";
          const state = get("administrative_area_level_1");
          const city = get("locality") || get("postal_town");
          const colony = get("sublocality") || get("sublocality_level_1");
          const postal = get("postal_code");
          const lat = p.location?.latitude || p.location?.latLng?.latitude || "";
          const lng = p.location?.longitude || p.location?.latLng?.longitude || "";
          const phone = p.nationalPhoneNumber || p.internationalPhoneNumber || "";
          const price = typeof p.priceLevel==="number" ? ["Free","$","$$","$$$","$$$$"][p.priceLevel] || "" : "";
          const horario = p.currentOpeningHours?.weekdayDescriptions?.join(" | ") || (p.currentOpeningHours?.openNow!=null? ("Abierto ahora: " + (p.currentOpeningHours.openNow?"S√≠":"No")) : "");
          const tipos = [p.primaryTypeDisplayName || p.primaryType, ...(p.types||[])].filter(Boolean).join(" | ");
          const shortAddr = p.shortFormattedAddress || "";
          const resumen = p.editorialSummary?.text || "";
          const mapsURI = p.googleMapsUri || "";

          // website & email opcional
          let website = "";
          if(wantWebsite){
            try{
              const det = await fetchDetails(apiKey, p.id);
              website = det.websiteUri || "";
            }catch(e){}
          }
          let email = "";
          let partners = "";
          if((wantEmail || $("#xPartners").checked) && website){
            const txt = await fetchSiteText(website, emailWait*1000).catch(()=> "");
            if(wantEmail) email = extractEmails(txt);
            if($("#xPartners").checked) partners = detectPartners(txt, website);
          }

          const key = `${kw}__${p.id}`;
          if(resultsSet.has(key)) continue;

          const row = {
            kw: kw,
            state: state, city: city, colony: colony, postal: postal,
            name: p.displayName?.text || p.displayName || "",
            cat: p.primaryTypeDisplayName || p.primaryType || "",
            web: website, phone: phone, email: email,
            addr: p.formattedAddress || "",
            lat: wantLatLng ? lat : "",
            lng: wantLatLng ? lng : "",
            Horario: $("#xHorario").checked ? horario : "",
            Precio: $("#xPrecio").checked ? price : "",
            MapsURI: $("#xMapsUri").checked ? mapsURI : "",
            Foto: $("#xFoto").checked ? (p.photos?.[0]?.name ? `https://places.googleapis.com/v1/${encodeURIComponent(p.photos[0].name)}/media?maxHeightPx=200&key=${apiKey}` : "") : "",
            Tipos: $("#xTipos").checked ? tipos : "",
            ShortAddr: $("#xShort").checked ? shortAddr : "",
            Resumen: $("#xResumen").checked ? resumen : "",
            Partners: $("#xPartners").checked ? partners : ""
          };
          resultsSet.set(key,row);
          pushRow(row);
        }

      }catch(e){
        log(`‚ùå Error "${kw}" @ "${seed.label}": ${e.message}`);
      }
      await sleep(500); // cortes√≠a
    }
  }

  const uniques = allRows.length;
  log(`Proceso finalizado. Lugares √∫nicos: ${uniques}.`);
});

$("#download").addEventListener("click", ()=>{
  if(!allRows.length){ log("No hay datos para descargar."); return; }
  const csv = toCSV(allRows);
  downloadFile(`places_${new Date().toISOString().slice(0,10)}.csv`, csv);
});


/* =============== Inicializaci√≥n de UI =============== */
const optInputs = ["#xHorario","#xPrecio","#xMapsUri","#xFoto","#xTipos","#xShort","#xResumen","#xPartners"];
optInputs.forEach(s => $(s).addEventListener("change", syncOptionalCols));
syncOptionalCols();

</script>
</body>
</html>
