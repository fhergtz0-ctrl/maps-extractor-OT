<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Extractor de Restaurantes — Encabezados estilo hoja</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; --card:#121212; --muted:#1e1e1e; --text:#e5e5e5; --border:#2d2d2d; --primary:#22c55e; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b0b0c;color:var(--text)}
    .app{min-height:100vh;display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
    aside{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;position:sticky;top:16px;height:fit-content}
    main{display:flex;flex-direction:column;gap:12px}
    h1{margin:0 0 8px}
    label{display:block;margin:10px 0 6px;font-weight:600}
    input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--muted);color:var(--text)}
    textarea{min-height:60px}
    .row{display:flex;gap:8px}
    .toolbar{background:var(--card);border:1px solid var(--border);border-radius:14px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;padding:12px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--muted);cursor:pointer;font-weight:600}
    .btn.primary{background:var(--primary);color:#041e10;border-color:transparent}
    .searchbox{flex:1;min-width:220px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    #log{white-space:pre-wrap;font-size:12px;background:var(--muted);padding:10px;border-radius:10px;min-height:56px}
    .progress{height:8px;background:var(--muted);border-radius:999px;overflow:hidden}
    .progress>div{height:100%;width:0%;background:var(--primary)}
    table{width:100%;border-collapse:collapse}
    thead th{position:sticky;top:0;background:var(--card);z-index:1}
    th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left;font-size:13px;vertical-align:top}
    thead input{width:100%;padding:6px 8px;font-size:12px;margin-top:4px;border-radius:8px;border:1px solid var(--border);background:var(--muted);color:var(--text)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="app">
    <aside>
      <h1>Extractor de Restaurantes</h1>
      <p style="margin:0 0 12px;color:#9aa0a6">Google Maps — <b>Places API (New)</b> + Maps JS</p>

      <label>API Key</label>
      <input id="apiKey" placeholder="AIza... (tu key)"/>

      <label>Keyword</label>
      <textarea id="keywords">restaurantes</textarea>

      <label>Centro (lat, lng)</label>
      <div class="row">
        <input id="lat" value="23.2167"/>
        <input id="lng" value="-106.4167"/>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>Radio (m)</label>
          <input id="radius" value="5000"/>
        </div>
        <div style="flex:1">
          <label>Idioma</label>
          <select id="lang"><option value="es" selected>es</option><option value="en">en</option></select>
        </div>
      </div>

      <p style="color:#9aa0a6;font-size:12px">Origen: <span id="origin" class="pill"></span></p>
    </aside>

    <main>
      <div class="toolbar">
        <div style="display:flex;align-items:center;gap:10px;min-width:220px">
          <div style="font-weight:800;font-size:18px"><span id="count">0</span></div>
          <div>
            <div style="font-weight:700;font-size:12px;opacity:.8">RESULTADOS ENCONTRADOS</div>
            <div class="progress"><div id="bar"></div></div>
          </div>
        </div>
        <button class="btn" id="clear">Limpiar Datos</button>
        <button class="btn" id="export">Descargar</button>
        <input class="searchbox" id="globalSearch" placeholder="Buscar en la tabla…"/>
        <button class="btn primary" id="start">Start Extracting</button>
      </div>

      <div class="panel">
        <div id="log"></div>
        <div style="height:12px"></div>
        <div style="overflow:auto;max-height:62vh;border:1px solid var(--border);border-radius:10px">
          <table id="table">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
  "use strict";

  // ===== UTIL =====
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  $("#origin").textContent = location.origin;
  const headersWanted = [
    "KW","Location","Company Name","Category","Website","Phone","email","address",
    "Postal Code + City","state","pin code","# Reviews","Review","CID","MapLink"
  ];
  let rows = [];

  function toStr(v){ return v==null ? "" : String(v); }
  function escCSV(v){ return '"' + toStr(v).replace(/"/g,'""') + '"'; }
  function downloadCSV(name, data){
    if(!data.length){ alert("No hay filas."); return; }
    const cols = Object.keys(data[0]);
    const lines = [cols.map(escCSV).join(",")];
    for(const r of data) lines.push(cols.map(h=>escCSV(r[h])).join(","));
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob); const a=document.createElement("a");
    a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function log(m){ const el=$("#log"); el.textContent = (el.textContent?el.textContent+"\n":"")+m; console.log("[Extractor]",m); }
  function setProgress(p){ $("#bar").style.width = Math.max(0,Math.min(100,p)) + "%"; }
  function renderHeader(){
    const thead=$("#thead"); thead.innerHTML="";
    const tr1=document.createElement("tr"); const tr2=document.createElement("tr");
    headersWanted.forEach(h=>{
      const th=document.createElement("th"); th.textContent=h; tr1.appendChild(th);
      const th2=document.createElement("th");
      const inp=document.createElement("input"); inp.placeholder="filtrar…"; inp.dataset.col=h; inp.addEventListener("input",renderBody);
      th2.appendChild(inp); tr2.appendChild(th2);
    });
    thead.appendChild(tr1); thead.appendChild(tr2);
  }
  function renderBody(){
    const tbody=$("#tbody"); tbody.innerHTML="";
    const filters={}; $$("#thead input").forEach(i=>{ const v=i.value.trim().toLowerCase(); if(v) filters[i.dataset.col]=v; });
    const data = rows.filter(r=>{
      for(const k in filters){ if(!toStr(r[k]).toLowerCase().includes(filters[k])) return false; } return true;
    });
    for(const r of data){
      const tr=document.createElement("tr");
      headersWanted.forEach(h=>{ const td=document.createElement("td"); td.textContent=toStr(r[h]??""); tr.appendChild(td); });
      tbody.appendChild(tr);
    }
    $("#count").textContent = data.length;
  }

  $("#clear").addEventListener("click",()=>{ rows=[]; $("#log").textContent=""; $("#count").textContent="0"; setProgress(0); renderBody(); });
  $("#export").addEventListener("click",()=> downloadCSV("restaurantes.csv", rows));
  $("#globalSearch").addEventListener("input", e=>{
    const term=e.target.value.trim().toLowerCase(); $$("#thead input").forEach(i=>i.value="");
    const tbody=$("#tbody"); tbody.innerHTML="";
    const data = term? rows.filter(r=>Object.values(r).some(v=>toStr(v).toLowerCase().includes(term))) : rows;
    for(const r of data){
      const tr=document.createElement("tr");
      headersWanted.forEach(h=>{ const td=document.createElement("td"); td.textContent=toStr(r[h]??""); tr.appendChild(td); });
      tbody.appendChild(tr);
    }
    $("#count").textContent=data.length;
  });

  renderHeader(); renderBody();

  // ===== EXTRACCIÓN =====
  $("#start").addEventListener("click", start);

  async function start(){
    const key=$("#apiKey").value.trim(); if(!key) return alert("Coloca tu API key.");
    // Cargar Maps JS si no está
    if(!window.google || !google.maps || !google.maps.importLibrary){
      const s=document.createElement("script");
      s.src="https://maps.googleapis.com/maps/api/js?key="+encodeURIComponent(key)+"&v=quarterly";
      s.async=true; s.defer=true; s.onerror=()=>log("No se pudo cargar Google Maps JS API.");
      document.body.appendChild(s);
      await new Promise(res=> s.onload=res);
    }

    const kw = ($("#keywords").value||"").split("\n").map(t=>t.trim()).filter(Boolean)[0] || "restaurantes";
    const lat=parseFloat($("#lat").value), lng=parseFloat($("#lng").value);
    const radius=parseInt($("#radius").value,10)||3000;
    const language=$("#lang").value||"es";

    log(`Inicializando búsqueda… "${kw}"`);
    setProgress(5);

    const { Map } = await google.maps.importLibrary("maps");
    const { Place } = await google.maps.importLibrary("places");
    const center = (Number.isFinite(lat)&&Number.isFinite(lng))? {lat,lng} : {lat:23.2167,lng:-106.4167};
    const dummy=document.createElement("div"); dummy.style.width="0"; dummy.style.height="0"; document.body.appendChild(dummy);
    const map=new Map(dummy,{center,zoom:12});

    const req = {
      textQuery: kw,
      fields: [
        "id","displayName","formattedAddress","location","types","primaryType",
        "websiteUri","nationalPhoneNumber","internationalPhoneNumber",
        "rating","userRatingCount","googleMapsUri","addressComponents"
      ],
      locationBias: map.getCenter(),
      maxResultCount: 50,
      language, region:"mx"
    };

    try{
      const { places } = await Place.searchByText(req);
      const total = places?.length || 0;
      log(`Resultados: ${total}`); setProgress(15);
      if(!total){ rows=[]; renderBody(); return; }

      rows=[]; let i=0;
      for(const p of places){
        i++;

        // Address components -> city/state/postal
        let city="", state="", postal="";
        if(Array.isArray(p.addressComponents)){
          for(const c of p.addressComponents){
            const t=c.types||[];
            const longTxt=c.longText||c.long_name||c.name||"";
            if(t.includes("locality")||t.includes("sublocality")||t.includes("postal_town")) city=city||longTxt;
            if(t.includes("administrative_area_level_1")) state=state||longTxt;
            if(t.includes("postal_code")) postal=postal||longTxt;
          }
        }

        // Location string como "Ciudad - Estado" (fallback a lat,lng si no hay)
        const locLabel = (city||state) ? `${city}${city&&state?" - ":""}${state}` : `${center.lat}, ${center.lng}`;

        // Phone
        const phone = p.nationalPhoneNumber || p.internationalPhoneNumber || "";

        // CID desde la URL de Google Maps (si existe ?cid=)
        const cid = extractCID(p.googleMapsUri||"");

        rows.push({
          "KW": kw,
          "Location": locLabel,
          "Company Name": p.displayName || "",
          "Category": p.primaryType || (p.types ? p.types.join("|") : ""),
          "Website": p.websiteUri || "",
          "Phone": phone,
          "email": "", // Google no expone email; requeriría scraping del website con backend
          "address": p.formattedAddress || "",
          "Postal Code + City": (postal?postal+" ":"") + (city||""),
          "state": state || "",
          "pin code": postal || "",
          "# Reviews": p.userRatingCount ?? "",
          "Review": p.rating ?? "",
          "CID": cid,
          "MapLink": p.googleMapsUri || ""
        });

        if(i%5===0) renderBody();
        setProgress(15 + Math.round((i/total)*80));
      }

      setProgress(100);
      renderBody();
      log("Listo.");
    }catch(e){
      log("Error: " + (e && e.message ? e.message : e));
      log("Pista: habilita Billing + Places API (New) y autoriza tu dominio en la API key.");
    }
  }

  function extractCID(url){
    try{
      if(!url) return "";
      const u = new URL(url);
      const cid = u.searchParams.get("cid");
      if(cid) return cid;
      const m = url.match(/[?&]cid=(\d+)/);
      return m? m[1] : "";
    }catch{ return ""; }
  }
  </script>
</body>
</html>
