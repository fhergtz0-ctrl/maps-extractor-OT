<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Scrapping Tool — Google Places</title>

<style>
  :root{ --panel:#111; --border:#2a2a2a; --fg:#eaeaea; --muted:#bfbfbf; --accent:#1db954; }
  html,body{margin:0;padding:0;background:#0b0b0b;color:var(--fg);font:14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
  .app{padding:12px;}
  /* ======= BARRA ÚNICA ======= */
  .unibar{
    display:grid;
    grid-template-columns: 1.3fr 1.3fr 1fr .8fr .8fr .9fr .6fr .9fr .9fr;
    gap:8px;
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:10px;
    padding:10px;
  }
  .cell{display:flex;flex-direction:column;gap:6px;min-width:0}
  .head{font-size:12px;color:var(--muted)}
  textarea, input[type="text"], input[type="number"]{
    width:100%; min-height:36px; box-sizing:border-box;
    background:#1a1a1a; color:var(--fg); border:1px solid var(--border); border-radius:8px; padding:8px 10px;
  }
  textarea{min-height:58px; resize:vertical}
  .checkwrap{
    height:36px; display:flex; align-items:center; justify-content:center;
    background:#1a1a1a; border:1px solid var(--border); border-radius:8px;
  }
  .checkwrap input{transform:scale(1.15)}
  .btn{height:36px; border-radius:8px; border:1px solid var(--border); background:#2b2b2b; color:#fff; font-weight:600}
  .btn.primary{background:var(--accent); border-color:#159a45; color:#0b130d}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  /* ======= TABLA ======= */
  .panel{margin-top:12px}
  .log{white-space:pre-wrap;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:10px;max-height:120px;overflow:auto}
  .tblwrap{overflow:auto;max-height:65vh;border:1px solid var(--border);border-radius:10px}
  table{table-layout:fixed;width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:8px 10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  thead th{position:relative;background:#161616}
  .col-resizer{position:absolute;right:0;top:0;bottom:0;width:6px;cursor:col-resize}
  .col-resizer:hover{background:rgba(255,255,255,.06)}
  thead input{width:100%;box-sizing:border-box;background:#1a1a1a;color:#fff;border:1px solid var(--border);border-radius:8px;padding:6px 8px}
</style>
</head>
<body>
<div class="app">

  <!-- ====== BARRA ÚNICA ====== -->
  <div class="unibar" id="unibar">
    <div class="cell">
      <div class="head">Keywords</div>
      <textarea id="keywords">Restaurante</textarea>
    </div>

    <div class="cell">
      <div class="head">Ubicaciones</div>
      <textarea id="locations">Hermosillo Sonora
Nogales Sonora</textarea>
    </div>

    <div class="cell">
      <div class="head">API Key</div>
      <input type="text" id="apiKey" placeholder="pegar aqui la Key">
    </div>

    <div class="cell">
      <div class="head">Extract Lat & Log</div>
      <div class="checkwrap"><input type="checkbox" id="includeLatLng" checked disabled></div>
    </div>

    <div class="cell">
      <div class="head">Extract Email</div>
      <div class="checkwrap"><input type="checkbox" id="extractEmail"></div>
    </div>

    <div class="cell">
      <div class="head">Extract Website</div>
      <div class="checkwrap"><input type="checkbox" id="includeWebsite"></div>
    </div>

    <div class="cell">
      <div class="head">Seg Max Email</div>
      <input type="number" id="emailTimeoutTop" min="1" max="20" value="10">
    </div>

    <div class="cell">
      <div class="head">&nbsp;</div>
      <button class="btn primary" id="start">Iniciar Extracción</button>
    </div>

    <div class="cell">
      <div class="head">&nbsp;</div>
      <button class="btn" id="export">Descargar</button>
    </div>
  </div>

  <!-- ====== RESULTADOS ====== -->
  <div class="panel">
    <div class="log" id="log"></div>
    <div class="tblwrap">
      <table id="table">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
"use strict";

/* ===== Helpers ===== */
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
function toStr(v){return v==null?"":String(v);}
function escCSV(v){return '"'+toStr(v).replace(/"/g,'""')+'"'}

function log(msg){
  const el=$("#log");
  el.textContent = (el.textContent?el.textContent+"\n":"") + msg;
  console.log("[ScrappingTool]", msg);
}
function setProgress(p){ const b=$("#bar"); if(b) b.style.width=Math.max(0,Math.min(100,p))+"%"; }
function setComboProgress(p){ const b=$("#comboBar"); if(b) b.style.width=Math.max(0,Math.min(100,p))+"%"; }

/* ===== UI state ===== */
const apiKey=$("#apiKey");
apiKey.value=localStorage.getItem("st_api_key")||"";
apiKey.addEventListener("change",()=>localStorage.setItem("st_api_key", apiKey.value));

let includeEmail=false, includeWebsite=false, isRunning=false;
$("#extractEmail").addEventListener("change",e=>{ includeEmail=e.target.checked; renderHeader(); renderBody(); });
$("#includeWebsite").addEventListener("change",e=>{ includeWebsite=e.target.checked; });

/* ===== Tabla config ===== */
const headersWantedBase=[
  "KW","Location","Company Name","Category","Website","Phone","email","address",
  "Postal Code + City","state","pin code","# Reviews","Review","CID","MapLink",
  "Lat","Lng","Plus Code","Status","Types","Embed"
];
const COL_WIDTHS={
  "KW":120,"Location":140,"Company Name":220,"Category":130,
  "Website":180,"Phone":120,"email":220,"address":340,
  "Postal Code + City":160,"state":120,"pin code":100,
  "# Reviews":110,"Review":90,"CID":150,"MapLink":220,
  "Lat":120,"Lng":120,"Plus Code":150,"Status":150,"Types":220,"Embed":220
};
let rows=[];

function currentHeaders(){
  const h=[...headersWantedBase];
  if(!includeEmail){ const i=h.indexOf("email"); if(i>-1) h.splice(i,1); }
  return h;
}
function renderColGroup(){
  const table=$("#table");
  let cg=table.querySelector("colgroup"); if(cg) cg.remove();
  cg=document.createElement("colgroup");
  currentHeaders().forEach(h=>{
    const col=document.createElement("col");
    col.style.width=(COL_WIDTHS[h]||160)+"px";
    cg.appendChild(col);
  });
  table.insertBefore(cg, table.firstChild);
}
function makeHeadersResizable(){
  const table=$("#table");
  const cols=Array.from(table.querySelectorAll("colgroup col"));
  const ths=Array.from(document.querySelectorAll("#thead tr:first-child th"));
  ths.forEach((th,i)=>{
    let g=th.querySelector(".col-resizer");
    if(!g){ g=document.createElement("span"); g.className="col-resizer"; th.appendChild(g); }
    else { const c=g.cloneNode(true); g.replaceWith(c); g=c; }
    g.addEventListener("mousedown",(ev)=>{
      ev.preventDefault();
      const startX=ev.pageX;
      const startW=parseInt((cols[i].style.width||th.offsetWidth)+"",10)||th.offsetWidth;
      function onMove(e){
        const nw=Math.max(60,startW+(e.pageX-startX));
        cols[i].style.width=nw+"px";
        const head=currentHeaders()[i]; if(head) COL_WIDTHS[head]=nw;
      }
      function onUp(){ document.removeEventListener("mousemove",onMove); document.removeEventListener("mouseup",onUp); }
      document.addEventListener("mousemove",onMove);
      document.addEventListener("mouseup",onUp);
    });
  });
}
function renderHeader(){
  renderColGroup();
  const thead=$("#thead"); thead.innerHTML="";
  const tr1=document.createElement("tr"), tr2=document.createElement("tr");
  currentHeaders().forEach(h=>{
    const th=document.createElement("th"); th.textContent=h; tr1.appendChild(th);
    const th2=document.createElement("th");
    const inp=document.createElement("input"); inp.placeholder="filtrar…"; inp.dataset.col=h; inp.addEventListener("input",renderBody);
    th2.appendChild(inp); tr2.appendChild(th2);
  });
  thead.appendChild(tr1); thead.appendChild(tr2);
  makeHeadersResizable();
}
function renderBody(){
  const tbody=$("#tbody"); tbody.innerHTML="";
  const filters={}; $$("#thead input").forEach(i=>{ const v=i.value.trim().toLowerCase(); if(v) filters[i.dataset.col]=v;});
  const cols=currentHeaders();
  const data=rows.map(r=>{const pruned={}; cols.forEach(c=>pruned[c]=r[c]??""); return pruned;})
                 .filter(r=>{ for(const k in filters){ if(!toStr(r[k]).toLowerCase().includes(filters[k])) return false; } return true; });
  for(const r of data){
    const tr=document.createElement("tr"); cols.forEach(h=>{ const td=document.createElement("td"); td.textContent=toStr(r[h]??""); tr.appendChild(td); });
    tbody.appendChild(tr);
  }
}
renderHeader(); renderBody();

/* ===== Export ===== */
$("#export").addEventListener("click",()=>{
  if(!rows.length){ alert("No hay filas."); return; }
  const cols=Object.keys(rows[0]);
  const csv=[ cols.map(escCSV).join(",") ];
  for(const r of rows){ csv.push( cols.map(h=>escCSV(r[h])).join(",") ); }
  const blob=new Blob([csv.join("\n")],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="resultados-scrapping.csv"; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

/* ===== Google Places (Text Search API NEW) ===== */
async function textSearchAll({apiKey,textQuery,center,radius=5000,language="es"}){
  const url="https://places.googleapis.com/v1/places:searchText";
  const headers={
    "Content-Type":"application/json",
    "X-Goog-Api-Key":apiKey,
    "X-Goog-FieldMask":[
      "places.id","places.displayName","places.formattedAddress","places.location",
      "places.primaryType","places.types",
      "places.nationalPhoneNumber","places.internationalPhoneNumber",
      "places.rating","places.userRatingCount",
      "places.addressComponents","places.plusCode","places.businessStatus",
      "nextPageToken"
    ].join(",")
  };
  const out=[]; let pageToken=null;
  do{
    const body={ textQuery, languageCode:language,
      locationBias:{ circle:{ center:{ latitude:center.lat, longitude:center.lng }, radius } },
      pageSize:20, pageToken };
    const res=await fetch(url,{method:"POST",headers,body:JSON.stringify(body)});
    if(!res.ok){ const t=await res.text().catch(()=>String(res.status)); throw new Error(`HTTP ${res.status} en searchText: ${t}`); }
    const data=await res.json(); out.push(...(data.places||[])); pageToken=data.nextPageToken||null;
    if(pageToken) await new Promise(r=>setTimeout(r,300));
  }while(pageToken);
  return out;
}
async function geocodeAddress(geocoder, address){
  try{
    const { results } = await geocoder.geocode({ address });
    if(results && results[0]){
      const { lat, lng } = results[0].geometry.location;
      return { lat: lat(), lng: lng() };
    }
    return null;
  }catch{ return null; }
}
async function tryExtractEmail(url, timeoutMs){
  const ctrl=new AbortController(); const to=setTimeout(()=>ctrl.abort(),timeoutMs);
  try{
    const res=await fetch(url,{mode:"cors",signal:ctrl.signal});
    const txt=await res.text(); const m=txt.match(/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}/i);
    return m?m[0]:"";
  }catch{ return ""; } finally{ clearTimeout(to); }
}

/* ===== Start ===== */
window.addEventListener('unhandledrejection',e=>log('Error no capturado: '+(e?.reason?.message||String(e?.reason||e))));
$("#start").addEventListener("click", start);

async function start(){
  if(isRunning) return; isRunning=true; $("#start").disabled=true;
  try{
    const key=$("#apiKey").value.trim(); if(!key){ alert("Coloca tu API key."); return; }

    if(!window.google || !google.maps || !google.maps.importLibrary){
      const s=document.createElement("script");
      s.src="https://maps.googleapis.com/maps/api/js?key="+encodeURIComponent(key)+"&v=quarterly";
      s.async=true; s.defer=true; s.onerror=()=>log("No se pudo cargar Maps JS.");
      document.body.appendChild(s); await new Promise(r=>s.onload=r);
    }

    const keywords=$("#keywords").value.split("\n").map(s=>s.trim()).filter(Boolean);
    const locations=$("#locations").value.split("\n").map(s=>s.trim()).filter(Boolean);
    if(!keywords.length || !locations.length){ alert("Agrega al menos 1 keyword y 1 ubicación."); return; }

    const emailTimeout=Math.max(1,Math.min(20,parseInt($("#emailTimeoutTop").value,10)||10));
    const language="es";
    rows=[]; renderBody(); setProgress(0); setComboProgress(0);

    const { Place } = await google.maps.importLibrary("places");
    const geocoder=new google.maps.Geocoder();

    let combo=0, total=keywords.length*locations.length;
    for(const kw of keywords){
      for(const loc of locations){
        combo++; log(`(${combo}/${total}) ${kw} @ ${loc}`);

        const center=await geocodeAddress(geocoder, loc);
        if(!center){ log(`No se pudo geocodificar: ${loc}`); continue; }

        let places=[];
        try{ places=await textSearchAll({apiKey:key,textQuery:kw,center,radius:5000,language}); }
        catch(err){ log(`Error "${kw}" @ "${loc}": ${err?.message||err}`); continue; }

        let i=0;
        for(const p of places){
          i++;
          const name=(typeof p.displayName==="string")?p.displayName: (p.displayName?.text || "");
          let city="",state="",postal="";
          if(Array.isArray(p.addressComponents)){
            for(const c of p.addressComponents){
              const t=c.types||[]; const v=c.longText||c.long_name||c.name||"";
              if(t.includes("locality")||t.includes("sublocality")||t.includes("postal_town")) city=city||v;
              if(t.includes("administrative_area_level_1")) state=state||v;
              if(t.includes("postal_code")) postal=postal||v;
            }
          }
          const phone=p.nationalPhoneNumber||p.internationalPhoneNumber||"";
          const mapLink="https://www.google.com/maps/search/?api=1&query="+encodeURIComponent((name||" ")+" "+(p.formattedAddress||""));
          const embed="https://www.google.com/maps?q="+encodeURIComponent((name||" ")+" "+(p.formattedAddress||""))+"&output=embed";

          let websiteUri="";
          if(includeWebsite || includeEmail){
            try{ const detail=new Place({id:p.id,requestedLanguage:language,region:"mx"}); await detail.fetchFields({fields:["websiteUri"]}); websiteUri=detail.websiteUri||""; }
            catch(_){}
          }
          let email="";
          if(includeEmail && websiteUri){ try{ email=await tryExtractEmail(websiteUri,emailTimeout*1000);}catch(_){ email=""; } }

          rows.push({
            "KW":kw,"Location":loc,"Company Name":name,
            "Category":p.primaryType||(p.types?p.types[0]:""),
            "Website":websiteUri||"","Phone":phone,"email":email,"address":p.formattedAddress||"",
            "Postal Code + City":(postal?postal+" ":"")+(city||""),"state":state||"","pin code":postal||"",
            "# Reviews":p.userRatingCount??"","Review":p.rating??"","CID":"",
            "MapLink":mapLink,"Lat":(p.location&&(p.location.lat??p.location.latitude))??"",
            "Lng":(p.location&&(p.location.lng??p.location.longitude))??"",
            "Plus Code":(p.plusCode?.compoundCode||p.plusCode?.globalCode||""),
            "Status":p.businessStatus||"","Types":Array.isArray(p.types)?p.types.join("|"):"",
            "Embed":embed
          });

          if(i%5===0) renderBody();
          setProgress(Math.min(100,Math.round((i/Math.max(1,places.length))*100)));
        }
        renderBody();
      }
    }
    log("Proceso finalizado.");
  }catch(err){
    log("Fallo inesperado: "+(err?.message||err));
  }finally{
    isRunning=false; $("#start").disabled=false;
  }
}
</script>
</body>
</html>
