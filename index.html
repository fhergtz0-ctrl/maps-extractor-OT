<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scrapping Tool ‚Äî Google Maps Places</title>

  <!-- Estilos del proyecto (ajusta las rutas si cambian) -->
  <link rel="stylesheet" href="/assets/css/scrapping-tool.css">
  <link rel="stylesheet" media="print" href="/assets/css/print.css">

  <style>
    :root{
      --bg:#0f1115;--panel:#151922;--muted:#9aa4ad;--text:#e9eef5;--accent:#16a34a;--chip:#1d2431;--chip-on:#243040;--danger:#f59e0b;
      --input:#0f1115;--border:#263142;
    }
    html,body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";height:100%;}
    .container{max-width:1200px;margin:20px auto;padding:0 16px;}
    .h1{font-weight:700;font-size:24px;margin:12px 0 6px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:18px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 220px;min-width:220px}
    .col-tiny{flex:1 1 120px;min-width:120px}
    .col-wide{flex:2 1 320px;min-width:320px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,textarea,select{width:100%;background:var(--input);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px;outline:none}
    textarea{min-height:64px;resize:vertical}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:var(--chip);border:1px solid var(--border);font-size:13px;cursor:pointer}
    .chip input{accent-color:#36c173}
    .chip.on{background:var(--chip-on)}
    .actions{display:flex;gap:10px;align-items:center}
    .btn{border-radius:10px;border:1px solid var(--border);background:#212a3a;color:var(--text);padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:#0f7a33;color:#07190f}
    .btn.ghost{background:#1b2331}
    .metric{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);border-radius:12px;padding:6px 10px;background:var(--chip)}
    .log{background:#0b0e13;border:1px dashed var(--border);border-radius:10px;padding:12px;font-family:ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;max-height:180px;overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:12px;color:var(--muted);text-align:left;padding:0 10px}
    tbody tr{background:#121621;border:1px solid var(--border);border-radius:10px}
    tbody td{padding:10px}
    .scroll-x{overflow:auto}
  </style>
</head>
<body>
  <div class="container">

    <div class="h1">Scrapping Tool ‚Äî Google Maps Places</div>
    <div class="sub">Barra √∫nica; resultados paginados; columnas separadas para Estado / Ciudad / Colonia / CP. Marca los ‚ÄúCampos extra‚Äù.</div>

    <!-- Controles -->
    <div class="panel" id="controls">
      <div class="row">
        <div class="col">
          <label>API Key</label>
          <input id="apiKey" placeholder="Pega aqu√≠ la Key" />
        </div>

        <div class="col-tiny">
          <label>Radio por consulta (km)</label>
          <input id="radiusKm" type="number" min="1" value="3" />
        </div>

        <div class="col-tiny">
          <label>Seg m√°x. email</label>
          <input id="maxEmailSec" type="number" min="0" value="10" />
        </div>

        <div class="col">
          <label>Estado(s)</label>
          <input id="state" placeholder="p.ej. Sonora" />
        </div>

        <div class="col">
          <label>Ciudad(es)</label>
          <input id="city" placeholder="p.ej. Hermosillo" />
        </div>

        <div class="col">
          <label>Colonia(s) (opcional)</label>
          <input id="colony" placeholder="p.ej. Centro" />
        </div>

        <div class="col">
          <label>C√≥digos postales (opcional, separados por coma)</label>
          <input id="postalCodes" placeholder="83000, 83290" />
        </div>

        <div class="col-wide">
          <label>Keywords (una por l√≠nea)</label>
          <textarea id="keywords" placeholder="restaurantes&#10;cafeter√≠as"></textarea>
        </div>
      </div>

      <div class="row">
        <div class="col-wide">
          <label>Campos extra</label>
          <div class="chips">
            <label class="chip"><input type="checkbox" id="chkHours"> Horario</label>
            <label class="chip"><input type="checkbox" id="chkPrice"> Precio</label>
            <label class="chip"><input type="checkbox" id="chkMapsUri"> Maps URI</label>
            <label class="chip"><input type="checkbox" id="chkPhoto"> Foto</label>
            <label class="chip"><input type="checkbox" id="chkTypes" checked> Tipo + Subtipos</label>
            <label class="chip"><input type="checkbox" id="chkShortAddr"> Short Addr</label>
            <label class="chip"><input type="checkbox" id="chkSummary"> Resumen</label>
            <label class="chip"><input type="checkbox" id="chkPartners"> Partners (Reserva/Delivery)</label>
          </div>
        </div>

        <div class="col">
          <label>&nbsp;</label>
          <div class="chips">
            <label class="chip"><input type="checkbox" id="chkLatLng" checked> Lat &amp; Long</label>
            <label class="chip"><input type="checkbox" id="chkWebsite" checked> Website</label>
            <label class="chip"><input type="checkbox" id="chkEmail"> Email</label>
          </div>
        </div>

        <div class="col actions">
          <button class="btn primary" id="btnStart">Iniciar</button>
          <button class="btn ghost" id="btnDownload">Descargar</button>
          <span class="metric">Resultados: <b id="resCount">0</b></span>
        </div>
      </div>

      <!-- M√©tricas y Memoria -->
      <div class="row">
        <div class="metric">üëÅÔ∏è Visitas: <span id="mVisits">‚Äî</span></div>
        <div class="metric">‚öôÔ∏è Extracciones: <span id="mRuns">‚Äî</span></div>
        <div class="metric">üìç Pa√≠s: <span id="mCountry">‚Äî</span></div>
      </div>

      <div id="memoryBar" class="row" style="gap:.75rem;align-items:center;margin-top:.5rem;">
        <label style="display:flex;align-items:center;gap:.35rem;">
          <input id="omitSeen" type="checkbox" checked> Omitir vistos
        </label>

        <label style="display:flex;align-items:center;gap:.35rem;">
          √Åmbito:
          <select id="scopeMode">
            <option value="project" selected>Por proyecto</option>
            <option value="global">Global</option>
          </select>
        </label>

        <label style="display:flex;align-items:center;gap:.35rem;">
          Proyecto:
          <input id="projectName" placeholder="auto" style="width:260px">
          <button id="autoProject" type="button" class="btn">Auto</button>
        </label>

        <button id="resetMemory" type="button" class="btn">Reset memoria (scope)</button>
        <button id="exportMemory" type="button" class="btn">Exportar</button>
        <button id="importMemory" type="button" class="btn">Importar</button>
        <input id="importFile" type="file" accept=".txt" style="display:none">

        <span id="memCount" class="metric">0 guardados</span>
      </div>
    </div>

    <!-- Log -->
    <div class="panel">
      <div class="log" id="log">Listo para iniciar‚Ä¶</div>
    </div>

    <!-- Tabla -->
    <div class="panel scroll-x">
      <table id="tbl">
        <thead>
          <tr>
            <th>KW</th>
            <th>State</th>
            <th>City</th>
            <th>Colony</th>
            <th>Postal Code</th>
            <th>Company Name</th>
            <th>Category</th>
            <th>Website</th>
            <th>Phone</th>
            <th>email</th>
            <th>address</th>
            <th>Lat</th>
            <th>Lng</th>
            <th>Horario</th>
            <th>Precio</th>
            <th>Tipo + Subtipos</th>
            <th>Resumen</th>
            <th>Partners</th>
            <th>Maps URI</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="sub">
      Origen: esta p√°gina ‚Äî sin backend ‚Äî usa Google Geocoding (Maps JS) y Places v1 (New). Si falla colonia, probamos ciudad+estado y despu√©s solo ciudad. Si pones CP, se usa como bias de radio.
    </div>

  </div>

  <script>
    /* ===== Config de m√©tricas ===== */
    const ENABLE_METRICS = false; // ‚Üê pon true si quieres visitas/ejecuciones (CountAPI)

    /* -------- util -------- */
    const $ = (s)=>document.querySelector(s);
    const logEl=$("#log"), tbody=$("#tbody"), resCountEl=$("#resCount");
    const rowsData=[];

    function log(msg, type="info"){
      const prefix= type==="warn"?"‚ö†Ô∏è ": type==="err"?"‚ùå ":"";
      logEl.textContent += (logEl.textContent? "\n":"") + prefix + msg;
      logEl.scrollTop = logEl.scrollHeight;
    }
    const clearLog=()=>{logEl.textContent="";};
    const delay=(ms)=>new Promise(r=>setTimeout(r,ms));
    const header=()=>Array.from(document.querySelectorAll("#tbl thead th")).map(th=>th.textContent);

    function toCSV(rows){
      const h=header(); const out=[h.join(",")];
      for(const r of rows){
        out.push(h.map(k=>`"${(r[k]??"").toString().replaceAll('"','""')}"`).join(","));
      }
      return out.join("\n");
    }
    function downloadCSV(name, text){
      const url=URL.createObjectURL(new Blob([text],{type:"text/csv;charset=utf-8"}));
      const a=document.createElement("a"); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
    }

    async function safeJson(u){
      try{ const r=await fetch(u); return await r.json(); }
      catch{ return null; }
    }

    async function updateMetrics(){
      if(!ENABLE_METRICS){
        $("#mVisits").textContent="‚Äî"; $("#mRuns").textContent="‚Äî";
        try{
          const ip=await safeJson("https://ipapi.co/json/"); $("#mCountry").textContent = ip?.country_name?`${ip.country_name} (${ip.country})`:"‚Äî";
        }catch{}
        return;
      }
      const ip=await safeJson("https://ipapi.co/json/"); $("#mCountry").textContent = ip?.country_name?`${ip.country_name} (${ip.country})`:"‚Äî";
      const ns="maps-extractor-ot.vercel.app";
      const v1=await safeJson(`https://api.countapi.xyz/hit/${ns}/pageviews`);
      const v2=await safeJson(`https://api.countapi.xyz/hit/${ns}/runs`);
      $("#mVisits").textContent = v1?.value ?? "‚Äî";
      $("#mRuns").textContent   = v2?.value ?? "‚Äî";
    }

    /* ---- carga Maps JS Din√°mica (Geocoder) ---- */
    let currentKey=null, mapsReady=false;
    function loadMapsScript(key){
      return new Promise((resolve,reject)=>{
        if(mapsReady && currentKey===key) return resolve();
        currentKey=key;
        const prev=document.querySelector("#gmaps-script");
        if(prev){ if(!prev.src.includes(key)) prev.remove(); else return resolve(); }
        const s=document.createElement("script");
        s.id="gmaps-script"; s.async=true; s.defer=true;
        // a√±adimos loading=async para evitar la advertencia
        s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&libraries=places&v=weekly&loading=async`;
        s.onload=()=>{mapsReady=true; resolve();};
        s.onerror=()=>reject(new Error("No se pudo cargar Google Maps JS"));
        document.head.appendChild(s);
      });
    }

    /* -------- geocoder -------- */
    function pickComp(comps, type){ const c=comps?.find(x=>x.types?.includes(type)); return c?c.long_name:""; }

    function geocodeWithMapsJS(query, components={}){
      return new Promise((resolve)=>{
        if(!window.google || !google.maps?.Geocoder) return resolve(null);
        const geocoder=new google.maps.Geocoder();
        const req={ address: query };
        if(components.country) { req.componentRestrictions = {country: components.country}; }
        if(components.administrativeArea){ req.componentRestrictions.administrativeArea = components.administrativeArea; }
        if(components.locality){ req.componentRestrictions.locality = components.locality; }
        if(components.postalCode){ req.componentRestrictions.postalCode = components.postalCode; }
        geocoder.geocode(req,(results,status)=>{
          if(status==="OK" && results && results[0]){
            const r=results[0], loc=r.geometry.location;
            resolve({
              lat: loc.lat(), lng: loc.lng(),
              viewport: r.geometry.viewport||null,
              components: r.address_components,
              formatted: r.formatted_address
            });
          } else resolve(null);
        });
      });
    }

    async function geocodeSmart({ colonia, ciudad, estado, cp, country="MX"}){
      const combos=[];
      if(cp) combos.push({ q:`${cp}, ${ciudad||""}, ${estado||""}, ${country}`, comp:{country, administrativeArea:estado, locality:ciudad, postalCode:cp}});
      if(colonia) combos.push({ q:`${colonia}, ${ciudad||""}, ${estado||""}, ${country}`, comp:{country, administrativeArea:estado, locality:ciudad}});
      if(ciudad && estado) combos.push({ q:`${ciudad}, ${estado}, ${country}`, comp:{country, administrativeArea:estado, locality:ciudad}});
      if(ciudad) combos.push({ q:`${ciudad}, ${country}`, comp:{country, locality:ciudad}});
      for(const c of combos){
        const hit=await geocodeWithMapsJS(c.q, c.comp);
        if(hit){
          const comps=hit.components||[];
          return {
            ok:true, lat:hit.lat, lng:hit.lng, viewport:hit.viewport,
            state: pickComp(comps,"administrative_area_level_1"),
            city:  pickComp(comps,"locality") || pickComp(comps,"sublocality") || pickComp(comps,"administrative_area_level_2"),
            colony:pickComp(comps,"neighborhood") || pickComp(comps,"sublocality_level_1") || pickComp(comps,"sublocality"),
            postalCode: pickComp(comps,"postal_code"),
            formatted: hit.formatted
          };
        }
      }
      return {ok:false};
    }

    /* -------- Places v1 (New) -------- */
    const BASE_FIELDS=[
      "places.id","places.displayName","places.primaryType","places.types",
      "places.formattedAddress","places.shortFormattedAddress",
      "places.addressComponents","places.location",
      "places.nationalPhoneNumber","places.internationalPhoneNumber",
      "places.googleMapsUri","places.websiteUri",
      "places.priceLevel","places.rating","places.userRatingCount",
      "places.currentOpeningHours.openNow","places.currentOpeningHours.weekdayDescriptions",
      "places.editorialSummary","places.photos.name"
    ];

    async function textSearchAll({apiKey,textQuery,bias,pageLimit=50,pageSize=20}){
      const out=[]; let page=0, nextPageToken=null;
      do{
        page++;
        const body={ textQuery, pageSize, languageCode:"es", locationBias: bias||undefined };
        if(nextPageToken) body.pageToken = nextPageToken;
        const r=await fetch("https://places.googleapis.com/v1/places:searchText",{
          method:"POST",
          headers:{
            "Content-Type":"application/json; charset=utf-8",
            "X-Goog-Api-Key": apiKey,
            "X-Goog-FieldMask": BASE_FIELDS.join(",")
          },
          body: JSON.stringify(body)
        });
        if(!r.ok){ throw new Error(`HTTP ${r.status} en searchText: ${await r.text()}`); }
        const data=await r.json();
        (data.places||[]).forEach(p=>out.push(p));
        nextPageToken=data.nextPageToken||null;
        if(nextPageToken) await delay(500);
      }while(nextPageToken && page<pageLimit);
      return out;
    }

    function detectPartners(p){
      const uri=(p.googleMapsUri||"").toLowerCase();
      const summary=(p.editorialSummary?.text||"").toLowerCase();
      const sites=["opentable","restorando","rappi","ubereats","didi food","didifood","doordash","justeat","seamless","postmates"];
      const hit=sites.find(s=> uri.includes(s) || summary.includes(s));
      const notes=[];
      if(hit) notes.push(hit);
      if(summary.includes("delivery")||summary.includes("domicilio")||summary.includes("entrega")) notes.push("delivery");
      return notes.join(" | ");
    }

    function pushRow(r){
      rowsData.push(r);
      const tr=document.createElement("tr");
      for(const k of header()){
        const td=document.createElement("td");
        td.textContent = r[k] ?? "";
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
      $("#resCount").textContent = rowsData.length;
    }
    function clearRows(){ rowsData.length=0; tbody.innerHTML=""; $("#resCount").textContent="0"; }

    /* ======= MEMORIA (global/proyecto) + export/import ======= */
    const SEEN_PREFIX     = 'mapsOT_seen_v2:';
    const SCOPE_MODE_KEY  = 'mapsOT_scope_mode';
    const PROJECT_NAME_KEY= 'mapsOT_project_name';
    const OMITSWITCH_KEY  = 'mapsOT_omit_seen';

    function slug(s) {
      return String(s || '')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-zA-Z0-9]+/g,'-')
        .replace(/^-+|-+$/g,'')
        .toLowerCase();
    }
    function autoScopeFromForm() {
      const kw   = ($("#keywords")?.value || '').split('\n').map(s=>s.trim()).filter(Boolean).slice(0,2).join('+');
      const city = ($("#city")?.value || '').trim();
      const st   = ($("#state")?.value || '').trim();
      const col  = ($("#colony")?.value || '').trim();
      const zips = ($("#postalCodes")?.value || '').replace(/\s+/g,'').trim();
      const km   = ($("#radiusKm")?.value || '').trim();
      const raw = [kw || 'kw', city || 'city', st || 'state', col || 'col', zips || 'cp', km || 'km'].join('|');
      return slug(raw);
    }
    function currentScopeName() {
      const mode = $('#scopeMode')?.value || 'project';
      if (mode === 'global') return 'global';
      const manual = $('#projectName')?.value?.trim();
      return slug(manual || autoScopeFromForm());
    }
    function storageKeyForScope() { return SEEN_PREFIX + currentScopeName(); }

    function loadSeen() {
      try {
        const raw = localStorage.getItem(storageKeyForScope());
        return raw ? JSON.parse(raw) : {};
      } catch { return {}; }
    }
    function saveSeen(map) { localStorage.setItem(storageKeyForScope(), JSON.stringify(map)); }

    function placeKey(p) {
      return (
        p.id ||
        p.googleMapsUri ||
        p.name ||
        ((p.displayName?.text || '') + '|' + (p.formattedAddress || '')) ||
        (p.location
          ? (Number(p.location.latitude).toFixed(5) + ',' + Number(p.location.longitude).toFixed(5))
          : '')
      );
    }
    let seen = loadSeen();

    function updateMemCount() {
      const el = $('#memCount');
      if (el) el.textContent = `${Object.keys(seen).length} guardados (${currentScopeName()})`;
    }
    function filterNew(arr) {
      return arr.filter(p => {
        const k = placeKey(p);
        if (!k) return true;
        return !seen[k];
      });
    }
    function markSeen(arr) {
      let changed = false;
      for (const p of arr) {
        const k = placeKey(p);
        if (k && !seen[k]) { seen[k] = Date.now(); changed = true; }
      }
      if (changed) { saveSeen(seen); updateMemCount(); }
    }
    function restoreMemoryControls() {
      const omit = localStorage.getItem(OMITSWITCH_KEY);
      if ($('#omitSeen')) $('#omitSeen').checked = omit !== '0';
      const mode = localStorage.getItem(SCOPE_MODE_KEY) || 'project';
      if ($('#scopeMode')) $('#scopeMode').value = mode;
      const pname = localStorage.getItem(PROJECT_NAME_KEY) || '';
      if ($('#projectName')) $('#projectName').value = pname;
    }
    restoreMemoryControls();

    $('#omitSeen')?.addEventListener('change', e => {
      localStorage.setItem(OMITSWITCH_KEY, e.target.checked ? '1' : '0');
    });
    $('#scopeMode')?.addEventListener('change', () => {
      localStorage.setItem(SCOPE_MODE_KEY, $('#scopeMode').value);
      seen = loadSeen(); updateMemCount();
    });
    $('#projectName')?.addEventListener('input', () => {
      localStorage.setItem(PROJECT_NAME_KEY, $('#projectName').value);
    });
    $('#autoProject')?.addEventListener('click', () => {
      const auto = autoScopeFromForm();
      if ($('#projectName')) {
        $('#projectName').value = auto;
        localStorage.setItem(PROJECT_NAME_KEY, auto);
      }
      seen = loadSeen(); updateMemCount();
    });
    $('#resetMemory')?.addEventListener('click', () => {
      if (confirm(`Borrar memoria del scope "${currentScopeName()}"?`)) {
        localStorage.removeItem(storageKeyForScope());
        seen = {}; updateMemCount();
      }
    });
    $('#exportMemory')?.addEventListener('click', () => {
      const keys = Object.keys(seen).join('\n');
      const blob = new Blob([keys], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `memoria-${currentScopeName()}-${Object.keys(seen).length}.txt`;
      a.click();
    });
    $('#importMemory')?.addEventListener('click', () => $('#importFile')?.click());
    $('#importFile')?.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const txt = await file.text();
      const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      let changed = false;
      for (const k of lines) { if (!seen[k]) { seen[k] = Date.now(); changed = true; } }
      if (changed) { saveSeen(seen); updateMemCount(); }
      e.target.value = '';
    });
    updateMemCount();

    // Atajos para usar en el scraping
    function memoryFilterBatch(placesArray) {
      const omit = $('#omitSeen')?.checked !== false;
      let lote = placesArray || [];
      if (omit) lote = filterNew(lote);
      return lote;
    }
    function memoryMarkBatch(placesArray) {
      markSeen(placesArray || []);
    }

    /* ====== Handlers principales ====== */
    $("#btnStart").addEventListener("click", start);
    $("#btnDownload").addEventListener("click", ()=>downloadCSV(`maps-extractor-${new Date().toISOString().slice(0,10)}.csv`, toCSV(rowsData)));

    // convierte viewport (Maps JS) al formato rectangle (Places v1)
    function viewportToRectangleBias(viewport){
      try{
        if(viewport?.getSouthWest && viewport?.getNorthEast){
          const sw=viewport.getSouthWest(), ne=viewport.getNorthEast();
          return {
            rectangle:{
              low:{  latitude: sw.lat(), longitude: sw.lng() },
              high:{ latitude: ne.lat(), longitude: ne.lng() }
            }
          };
        }
        if(viewport?.toJSON){
          const {south,west,north,east}=viewport.toJSON();
          return {
            rectangle:{
              low:{  latitude: south, longitude: west },
              high:{ latitude: north, longitude: east }
            }
          };
        }
      }catch{}
      return null;
    }

    async function start(){
      try{
        clearLog(); clearRows();
        const apiKey=$("#apiKey").value.trim();
        if(!apiKey){ log("Coloca tu API Key","warn"); return; }
        await loadMapsScript(apiKey);

        const state=$("#state").value.trim();
        const city=$("#city").value.trim();
        const colony=$("#colony").value.trim();
        const cps=$("#postalCodes").value.trim();
        const radiusKm=Math.max(1, parseFloat($("#radiusKm").value)||3);

        const wantLatLng=$("#chkLatLng").checked;
        const wantWebsite=$("#chkWebsite").checked;
        const wantEmail=$("#chkEmail").checked;

        const optHours=$("#chkHours").checked;
        const optPrice=$("#chkPrice").checked;
        const optMapsUri=$("#chkMapsUri").checked;
        const optPhoto=$("#chkPhoto").checked;
        const optTypes=$("#chkTypes").checked;
        const optShort=$("#chkShortAddr").checked;
        const optSummary=$("#chkSummary").checked;
        const optPartners=$("#chkPartners").checked;

        const kwList=$("#keywords").value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        if(!kwList.length){ log("Agrega al menos una keyword.","warn"); return; }

        const cpArr = cps? cps.split(/[,\s;]+/).map(s=>s.trim()).filter(Boolean):[];
        const cp = cpArr[0] || "";

        log("Iniciando‚Ä¶");
        const geo = await geocodeSmart({ colonia:colony, ciudad:city, estado:state, cp, country:"MX" });
        if(!geo.ok){ log(`‚ö†Ô∏è No se pudo geocodificar: ${[colony,city,state].filter(Boolean).join(", ")}`,"warn"); }

        let bias=undefined;
        if(geo.ok){
          const rectBias = viewportToRectangleBias(geo.viewport);
          if(rectBias) {
            bias = rectBias;
          } else {
            bias = { circle:{ center:{ latitude:geo.lat, longitude:geo.lng }, radius: radiusKm*1000 } };
          }
        }

        for(const kw of kwList){
          const textQuery = colony ? `${kw} @ ${colony}, ${city} ${state}` : `${kw} @ ${city} ${state}`.trim();
          log(`Buscando "${kw}" @ "${[colony,city,state].filter(Boolean).join(", ")}" (radio ${radiusKm} km)‚Ä¶`);
          try{
            const places = await textSearchAll({apiKey,textQuery,bias,pageLimit:50,pageSize:20});

            // ===== memoria: filtrar y marcar =====
            const lote = memoryFilterBatch(places);

            for(const p of lote){
              const comp=p.addressComponents||[];
              const row={
                "KW": kw,
                "State": geo.state || pickComp(comp,"administrative_area_level_1") || state,
                "City":  geo.city  || pickComp(comp,"locality") || city,
                "Colony": geo.colony || pickComp(comp,"neighborhood") || "",
                "Postal Code": geo.postalCode || pickComp(comp,"postal_code") || "",
                "Company Name": p.displayName?.text || "",
                "Category": p.primaryType || (p.types||[])[0] || "",
                "Website": wantWebsite ? (p.websiteUri || "") : "",
                "Phone": p.nationalPhoneNumber || p.internationalPhoneNumber || "",
                "email": wantEmail ? "" : "",
                "address": optShort ? (p.shortFormattedAddress || p.formattedAddress || "") : (p.formattedAddress || p.shortFormattedAddress || "")
              };
              if(wantLatLng){ row["Lat"]=p.location?.latitude??""; row["Lng"]=p.location?.longitude??""; } else { row["Lat"]=""; row["Lng"]=""; }

              row["Horario"]= optHours ? (p.currentOpeningHours?.weekdayDescriptions?.join(" | ") || "") : "";
              row["Precio"]=  optPrice ? (p.priceLevel || "") : "";
              row["Tipo + Subtipos"]= optTypes ? [p.primaryType, ...(p.types||[])].filter(Boolean).filter((x,i,a)=>a.indexOf(x)===i).join(" | ") : "";
              row["Resumen"]= optSummary ? (p.editorialSummary?.text || "") : "";
              row["Partners"]= optPartners ? detectPartners(p) : "";
              row["Maps URI"]= optMapsUri ? (p.googleMapsUri || "") : "";

              pushRow(row);
            }

            // marca como vistos lo que s√≠ se agreg√≥
            memoryMarkBatch(lote);

          }catch(e){
            log(`Error "${kw}" @ "${[colony,city,state].filter(Boolean).join(", ")}": ${e.message}`,"err");
          }
        }
        log("Proceso finalizado.");
        updateMetrics().catch(()=>{});
      }catch(e){
        log(`Error general: ${e.message}`,"err");
      }
    }

    // boot
    updateMetrics().catch(()=>{});
  </script>
</body>
</html>
