<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scrapping Tool ‚Äî Google Places</title>

  <!-- Favicon inline -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><rect width='128' height='128' rx='24' fill='%230b0b0b'/><text x='50%' y='58%' dominant-baseline='middle' text-anchor='middle' font-size='68' fill='%231db954'>S</text></svg>">

  <style>
    :root{
      --bg:#0b0b0b; --panel:#151515; --muted:#7b7b7b; --text:#eaeaea; --accent:#22c55e;
      --chip:#1f2937; --chip-txt:#c9d1d9; --border:#262626; --warn:#f59e0b; --err:#ef4444;
    }
    *{ box-sizing:border-box }
    html,body{ height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; color:var(--text); background:var(--bg) }
    .container{ max-width:1500px; margin:20px auto; padding:0 16px }

    /* Barra √∫nica */
    .toolbar{
      display:grid;
      grid-template-columns:220px 140px 140px 160px 170px 260px 160px 280px 1fr;
      gap:10px; background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px; align-items:start
    }
    .grp{ display:flex; flex-direction:column; gap:6px }
    .lbl{ font-size:12px; color:var(--muted) }
    textarea, input[type="text"], input[type="number"]{
      width:100%; background:#0f0f0f; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px; resize:vertical
    }
    textarea{ height:64px }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; background:#0f0f0f; border:1px solid var(--border); border-radius:12px; padding:10px; min-height:64px }
    .chip{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; background:var(--chip); border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--chip-txt) }
    .actions{ display:flex; gap:8px; align-items:center; justify-content:flex-end }
    button{ background:var(--accent); color:#08210e; border:0; border-radius:999px; padding:10px 14px; font-weight:600; cursor:pointer }
    .ghost{ background:#2a2a2a; color:#ddd }

    .metrics{ display:flex; align-items:center; gap:16px; margin:10px 0 6px; color:var(--muted) }
    .bullet{ width:6px; height:6px; background:#334155; border-radius:999px; display:inline-block; margin:0 8px }

    pre#log{ background:#0f0f0f; border:1px solid var(--border); border-radius:12px; padding:10px; white-space:pre-wrap; max-height:150px; overflow:auto }

    .table-wrap{ margin-top:12px; background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:8px; overflow:auto }
    table{ width:2500px; border-collapse:separate; border-spacing:0 }
    thead th{ position:sticky; top:0; z-index:1; background:#111; color:#cbd5e1; text-align:left; font-weight:700; padding:8px 10px; border-bottom:1px solid var(--border) }
    tbody td{ padding:8px 10px; border-bottom:1px solid var(--border); vertical-align:top; font-size:14px }
    .muted{ color:var(--muted) }
    .count-badge{ display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:999px; background:#111; color:#a7f3d0; font-weight:700; border:1px solid var(--border); margin-right:8px }
    .subgrid{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px }
    .disabled{ opacity:.5; pointer-events:none }
    .help{ font-size:11px; color:#9ca3af; margin-top:6px; line-height:1.2 }
  </style>
</head>
<body>
  <div class="container">

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="grp">
        <div class="lbl">Keywords</div>
        <textarea id="kw" placeholder="Restaurante&#10;Pizzer√≠a"></textarea>
      </div>

      <div class="grp">
        <div class="lbl">Ciudad(es)</div>
        <textarea id="ciudades" placeholder="Hermosillo&#10;Nogales"></textarea>
      </div>

      <div class="grp">
        <div class="lbl">Estado(s)</div>
        <textarea id="estados" placeholder="Sonora&#10;Sinaloa"></textarea>
      </div>

      <div class="grp">
        <div class="lbl">Colonia(s) (opcional)</div>
        <textarea id="colonias" placeholder="Centro&#10;Pitic&#10;San Benito"></textarea>
      </div>

      <div class="grp">
        <div class="lbl">C√≥digos postales</div>
        <textarea id="zips" placeholder="83260&#10;83150"></textarea>
        <div class="help">Puedes dejarlo vac√≠o si usar√°s ciudad/estado/colonia.</div>
      </div>

      <div class="grp">
        <div class="lbl">API Key</div>
        <input id="apiKey" type="text" placeholder="Pegar aqu√≠ tu API Key">
        <div class="chips" style="margin-top:6px">
          <label class="chip"><input id="t-latlng" type="checkbox" checked>Lat &amp; Long</label>
          <label class="chip"><input id="t-website" type="checkbox">Website</label>
          <label class="chip"><input id="t-email" type="checkbox">Email <span class="muted" title="Puede fallar por CORS">?</span></label>
        </div>
      </div>

      <!-- NUEVO: Modo por CP -->
      <div class="grp">
        <div class="lbl">Modo por CP</div>
        <div class="chips">
          <label class="chip" title="Usa radio (c√≠rculo). Puedes escribir un CP y un radio peque√±o.">
            <input type="radio" name="mode" id="mode1" value="quick" checked> R√°pido (radio)
          </label>
          <label class="chip" title="Geocodifica CP y limita por viewport rectangular.">
            <input type="radio" name="mode" id="mode2" value="zipRect"> Preciso por CP (viewport)
          </label>
          <label class="chip" title="Viewport del CP + barrido con grid para m√°s cobertura.">
            <input type="radio" name="mode" id="mode3" value="zipGrid"> CP grande (viewport + grid)
          </label>
        </div>
        <div class="help" id="modeHelp">R√°pido: usa radio (c√≠rculo). Para CP, escribe el CP y usa radio peque√±o (1‚Äì3 km).</div>
      </div>

      <div class="grp">
        <div class="lbl">Radio por consulta (km)</div>
        <input id="radiusKm" type="number" min="1" max="50" value="5">
        <div class="lbl" style="margin-top:10px">Seg m√°x. email</div>
        <input id="maxEmailSec" type="number" min="5" max="30" value="10">
      </div>

      <div class="grp">
        <div class="lbl">Campos extra</div>
        <div class="chips">
          <label class="chip"><input id="x-hours" type="checkbox">Horario</label>
          <label class="chip"><input id="x-price" type="checkbox">Precio</label>
          <label class="chip"><input id="x-mapsuri" type="checkbox">Maps URI</label>
          <label class="chip"><input id="x-photo" type="checkbox">Foto</label>
          <label class="chip"><input id="x-types" type="checkbox" checked>Tipo + Subtipos</label>
          <label class="chip"><input id="x-short" type="checkbox">Short Addr</label>
          <label class="chip"><input id="x-summary" type="checkbox">Resumen</label>
          <label class="chip"><input id="x-partners" type="checkbox">Reservas/Delivery</label>
        </div>
        <div class="lbl" style="margin-top:8px">M√°s de 60 resultados (Grid 60+)</div>
        <div class="chips">
          <label class="chip"><input id="g-on" type="checkbox">Activar grid (costo ‚Üë)</label>
        </div>
        <div class="subgrid" id="gridParams" class="disabled">
          <div>
            <div class="lbl">Paso grid (km)</div>
            <input id="g-step" type="number" min="1" max="20" value="3">
          </div>
          <div>
            <div class="lbl">M√°x celdas</div>
            <input id="g-max" type="number" min="1" max="200" value="60">
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="start">Iniciar extracci√≥n</button>
        <button id="download" class="ghost">Descargar</button>
      </div>
    </div>

    <!-- M√©tricas -->
    <div class="metrics">
      <span>üëÅÔ∏è Visitas: <span id="m-visits">‚Äî</span></span>
      <span class="bullet"></span>
      <span>‚öôÔ∏è Extracciones: <span id="m-runs">‚Äî</span></span>
      <span class="bullet"></span>
      <span>üìç Pa√≠s: <span id="m-country">‚Ä¶</span></span>
    </div>
    <pre id="log">Listo para iniciar‚Ä¶</pre>

    <!-- Resultados -->
    <div class="table-wrap">
      <div style="padding:6px 8px; display:flex; align-items:center;">
        <span class="count-badge" id="found">0</span>
        <span class="muted">RESULTADOS ENCONTRADOS</span>
      </div>
      <table id="tbl">
        <thead>
          <tr>
            <th>KW</th>
            <th>State</th>
            <th>City</th>
            <th>Colony</th>
            <th>Company Name</th>
            <th>Category</th>
            <th>Website</th>
            <th>Phone</th>
            <th>email</th>
            <th>address</th>
            <th>Postal Code + City</th>
            <th>state</th>
            <th>pin code</th>
            <th># Reviews</th>
            <th>Review</th>
            <th>CID</th>
            <th>MapLink</th>
            <th>Lat</th>
            <th>Lng</th>
            <th>Tipo + Subtipos</th>
            <th>Precio</th>
            <th>Horario</th>
            <th>Resumen</th>
            <th>Foto</th>
            <th>Partners</th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const log = (m,k="")=>{ const el=$("#log"); el.textContent+=(el.textContent?"\n":"")+m; el.scrollTop=el.scrollHeight; console[(k==="err"?"error":k==="warn"?"warn":"log")](m); };
    const setFound = n => $("#found").textContent=n;

    // M√©tricas (silenciosas si falla)
    const NS = location.host || "localdev";
    const capi = (kind,key)=>fetch(`https://api.countapi.xyz/${kind}/${encodeURIComponent(NS)}/${encodeURIComponent(key)}`).then(r=>r.ok?r.json():null).catch(()=>null);
    async function updateMetrics(){
      try{ const v=await capi("get","pageviews"); $("#m-visits").textContent=v?.value ?? "‚Äî"; }catch{ $("#m-visits").textContent="‚Äî"; }
      try{ const r=await capi("get","runs"); $("#m-runs").textContent=r?.value ?? "‚Äî"; }catch{ $("#m-runs").textContent="‚Äî"; }
      try{ const ip=await fetch("https://ipapi.co/json/"); const j=await ip.json(); $("#m-country").textContent=`${j.country_name||j.country||"?"} (${j.country||"?"})`; }catch{ $("#m-country").textContent="‚Äî"; }
    }
    updateMetrics(); capi("hit","pageviews").then(updateMetrics).catch(()=>{});

    // Toggles
    const toggles = { latlng:true, website:false, email:false, hours:false, price:false, maps:false, photo:false, types:true, short:false, summary:false, partners:false, grid:false };
    const mapIds = {
      "t-latlng":"latlng","t-website":"website","t-email":"email","x-hours":"hours","x-price":"price","x-mapsuri":"maps",
      "x-photo":"photo","x-types":"types","x-short":"short","x-summary":"summary","x-partners":"partners","g-on":"grid"
    };
    Object.keys(mapIds).forEach(id=>{
      const el=$("#"+id); if(el){ toggles[mapIds[id]]=el.checked; el.addEventListener("change",()=>{ toggles[mapIds[id]]=el.checked; refreshGridParams(); }); }
    });

    // NUEVO: Modo por CP ‚Üî grid UI hints
    function getMode(){
      const r=document.querySelector('input[name="mode"]:checked');
      return r?.value || "quick";
    }
    function refreshModeHelp(){
      const m=getMode();
      if(m==="quick"){
        $("#modeHelp").textContent="R√°pido: usa radio (c√≠rculo). Si escribes CP, usa radio peque√±o (1‚Äì3 km).";
      }else if(m==="zipRect"){
        $("#modeHelp").textContent="Preciso por CP: usa viewport rectangular del CP (sin grid). Requiere escribir al menos un CP.";
      }else{
        $("#modeHelp").textContent="CP grande: usa viewport del CP + grid para mayor cobertura. Requiere CP.";
      }
      // UI de grid
      if(m==="zipRect"){
        $("#g-on").checked=false;
        $("#g-on").disabled=true;
        $("#gridParams").classList.add("disabled");
      }else if(m==="zipGrid"){
        $("#g-on").checked=true;
        $("#g-on").disabled=true;
        $("#gridParams").classList.remove("disabled");
      }else{ // quick
        $("#g-on").disabled=false;
        refreshGridParams();
      }
    }
    document.querySelectorAll('input[name="mode"]').forEach(r=>r.addEventListener('change', refreshModeHelp));
    function refreshGridParams(){ $("#gridParams").classList.toggle("disabled", !$("#g-on").checked); }
    refreshModeHelp();

    // CSV
    const toCSV = rows => rows.map(r=>r.map(v=>v==null?"":(/[",\n]/.test(String(v))?`"${String(v).replace(/"/g,'""')}"`:v)).join(",")).join("\n");

    async function tryExtractEmail(url,sec){
      if (!url) return ""; let ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), Math.max(3,sec)*1000);
      try{ const r=await fetch(url,{mode:"cors",signal:ctrl.signal}); const h=await r.text();
        const m=h.match(/mailto:([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/)||h.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/); return m?(m[1]||m[0]):""; }
      catch{return ""} finally{ clearTimeout(t); }
    }
    function detectPartners(url){
      if(!url) return ""; const L=["opentable","restorando","rappi","ubereats","didifood","corner.shop","quandoo","thefork","tripadvisor","just-eat","grubhub","doordash","menulog"];
      const host=url.replace(/^https?:\/\//,""); return L.filter(s=>host.includes(s)).join("|");
    }

    function buildFieldMask(){
      const fm = [
        "places.id","places.displayName","places.primaryType","places.types","places.formattedAddress","places.addressComponents",
        "places.location","places.plusCode","places.businessStatus","places.nationalPhoneNumber","places.internationalPhoneNumber",
        "places.rating","places.userRatingCount"
      ];
      if (toggles.short)   fm.push("places.shortFormattedAddress");
      if (toggles.price)   fm.push("places.priceLevel");
      if (toggles.maps)    fm.push("places.googleMapsUri");
      if (toggles.hours)   fm.push("places.currentOpeningHours.openNow","places.currentOpeningHours.weekdayDescriptions");
      if (toggles.types)   fm.push("places.primaryTypeDisplayName");
      if (toggles.summary) fm.push("places.editorialSummary");
      if (toggles.photo)   fm.push("places.photos.name");
      fm.push("nextPageToken");
      return fm.join(",");
    }

    // Parse addressComponents (Places v1)
    function parseAddressComponents(ac){
      const get = type => ac?.find(c => Array.isArray(c.types) && c.types.includes(type));
      const val = (c) => c?.longText || c?.shortText || "";
      const postal = val(get("postal_code"));
      const city = val(get("locality")) || val(get("postal_town")) || val(get("administrative_area_level_2")) || val(get("sublocality")) || "";
      const state = val(get("administrative_area_level_1"));
      const neighborhood = val(get("neighborhood")) || val(get("sublocality")) || "";
      return { postal, city, state, neighborhood };
    }

    // Geocode por texto (ciudad/estado/colonia)
    async function geocodeText(address, key, {colonia=false} = {}){
      const params = new URLSearchParams({ address, language:"es", region:"mx", key });
      params.append("components","country:MX");
      if (colonia){ params.append("result_type","neighborhood|sublocality|political"); }
      const url = `https://maps.googleapis.com/maps/api/geocode/json?${params.toString()}`;
      try{
        const r = await fetch(url); const j = await r.json();
        if (j.status === "OK" && j.results?.[0]){ const g=j.results[0].geometry; return { center:g.location, viewport:g.viewport||null }; }
        log(`[Geocode] ${address} ‚Üí ${j.status}${j.error_message?": "+j.error_message:""}`, "warn");
        return await fallbackGeocodeByPlaces(address, key);
      }catch(e){ log(`[Geocode] fetch error: ${e}`, "err"); return await fallbackGeocodeByPlaces(address, key); }
    }

    // Geocode por CP (viewport del CP)
    async function geocodePostal(zip, key, country="MX"){
      const params = new URLSearchParams({ key, language:"es", region:country.toLowerCase() });
      params.append("components", `postal_code:${zip}|country:${country}`);
      const url = `https://maps.googleapis.com/maps/api/geocode/json?${params.toString()}`;
      try{
        const r=await fetch(url); const j=await r.json();
        if (j.status==="OK" && j.results?.[0]){ const g=j.results[0].geometry; return { center:g.location, viewport:g.viewport||null }; }
        return null;
      }catch{ return null; }
    }

    // Fallback con Places si Geocoding falla
    async function fallbackGeocodeByPlaces(q, key){
      try{
        const endpoint=`https://places.googleapis.com/v1/places:searchText?key=${encodeURIComponent(key)}`;
        const body={ textQuery:q, maxResultCount:1, languageCode:"es", regionCode:"MX" };
        const res=await fetch(endpoint,{ method:"POST", headers:{ "Content-Type":"application/json", "X-Goog-FieldMask":"places.location,places.id,places.displayName" }, body:JSON.stringify(body) });
        if(!res.ok) return null;
        const j=await res.json(); const p=j.places?.[0];
        if(p?.location){ return { center:{ lat:p.location.latitude, lng:p.location.longitude }, viewport:null }; }
        return null;
      }catch{ return null; }
    }

    // Places SearchText: c√≠rculo o rect√°ngulo (viewport)
    async function textSearchAll({ query, center, radiusM, viewport, key, lang="es", region="MX" }){
      const all=[]; let token;
      const endpoint=`https://places.googleapis.com/v1/places:searchText?key=${encodeURIComponent(key)}`;
      const fields=buildFieldMask();
      do{
        const body={ textQuery:query, languageCode:lang, regionCode:region, rankPreference:"RELEVANCE", maxResultCount:20, pageToken:token };
        if (viewport && viewport.southwest && viewport.northeast){
          body.locationRestriction = {
            rectangle:{
              low:{ latitude:viewport.southwest.lat, longitude:viewport.southwest.lng },
              high:{ latitude:viewport.northeast.lat, longitude:viewport.northeast.lng }
            }
          };
        } else if (center && radiusM){
          body.locationBias = { circle:{ center:{ latitude:center.lat, longitude:center.lng }, radius:radiusM } };
        }
        const r=await fetch(endpoint,{ method:"POST", headers:{ "Content-Type":"application/json","X-Goog-FieldMask":fields }, body:JSON.stringify(body) });
        if(!r.ok){ const e=await r.json().catch(()=>({})); throw {status:r.status,data:e}; }
        const j=await r.json(); if(j.places?.length) all.push(...j.places); token=j.nextPageToken||undefined;
      }while(token);
      return all;
    }

    // Utilidades grid
    const kmToLat = km => km/110.574;
    const kmToLng = (km,lat) => km/(111.320*Math.cos(lat*Math.PI/180));
    function buildGridCenters({center, viewport, stepKm, maxCells}){
      const pts=[]; let sw, ne;
      if (viewport && viewport.southwest && viewport.northeast){
        sw = {lat: viewport.southwest.lat, lng: viewport.southwest.lng};
        ne = {lat: viewport.northeast.lat, lng: viewport.northeast.lng};
      } else {
        const dLat = kmToLat(stepKm*2), dLng = kmToLng(stepKm*2, center.lat);
        sw = {lat:center.lat-dLat, lng:center.lng-dLng}; ne = {lat:center.lat+dLat, lng:center.lng+dLng};
      }
      const latStep = kmToLat(stepKm);
      for(let lat=sw.lat; lat<=ne.lat; lat+=latStep){
        const lngStep = kmToLng(stepKm, lat||center.lat);
        for(let lng=sw.lng; lng<=ne.lng; lng+=lngStep){
          pts.push({lat, lng}); if(pts.length>=maxCells) return pts;
        }
      }
      return pts;
    }

    function renderRows(rows){
      const tb=$("#body"); tb.innerHTML="";
      for(const r of rows){
        const tr=document.createElement("tr");
        r.forEach((v,i)=>{
          const td=document.createElement("td");
          if(i===6 || i===16){ td.innerHTML = v?`<a href="${v}" target="_blank" rel="noopener">${v}</a>`:""; }
          else td.textContent = v==null ? "" : String(v);
          tr.appendChild(td);
        });
        tb.appendChild(tr);
      }
      setFound(rows.length);
    }

    function downloadCSV(rows,name="results.csv"){
      const head=[
        "KW","State","City","Colony","Company Name","Category","Website","Phone","email","address",
        "Postal Code + City","state","pin code","# Reviews","Review","CID","MapLink","Lat","Lng",
        "Tipo + Subtipos","Precio","Horario","Resumen","Foto","Partners"
      ];
      const csv=toCSV([head,...rows]); const blob=new Blob([csv],{type:"text/csv;charset=utf-8"}); const url=URL.createObjectURL(blob); const a=document.createElement("a");
      a.href=url;a.download=name;a.click();URL.revokeObjectURL(url);
    }

    // Combina Ciudad/Estado/Colonia + Zips con MODO
    function buildTargetsWithZips(ciudades, estados, colonias, zips, mode, country="MX"){
      const targets=[];
      // 1) CPs
      for(const zip of zips){ if(!zip) continue;
        const useZipViewport = (mode!=="quick"); // modo2 y modo3 usan viewport
        const forceGrid = (mode==="zipGrid");
        targets.push({ state:"", city:"", colony:"", label:`CP ${zip}`, query:`${zip}, ${country}`, coloniaFlag:false, useZipViewport, zip, country, forceGrid });
      }
      // 2) Entrada normal
      const C = ciudades.length ? ciudades : [""];
      const E = estados.length ? estados : [""];
      if (colonias.length){
        for(const city of C) for(const state of E) for(const colony of colonias){
          const label=[city,state,`Col. ${colony}`].filter(Boolean).join(", ");
          const query=[colony,city,state,country].filter(Boolean).join(", ");
          targets.push({ state, city, colony, label, query, coloniaFlag:true, useZipViewport:false, forceGrid:false });
        }
      } else {
        for(const city of C) for(const state of E){
          const label=[city,state].filter(Boolean).join(", ");
          const query=[city,state,country].filter(Boolean).join(", ");
          targets.push({ state, city, colony:"", label, query, coloniaFlag:false, useZipViewport:false, forceGrid:false });
        }
      }
      return targets;
    }

    // START
    $("#start").addEventListener("click", async ()=>{
      const key=$("#apiKey").value.trim(); if(!key){ alert("Pega tu API Key"); return; }
      $("#body").innerHTML=""; setFound(0); $("#log").textContent="Iniciando‚Ä¶";
      capi("hit","runs").then(updateMetrics).catch(()=>{});

      const kws=$("#kw").value.split(/\n|,/).map(s=>s.trim()).filter(Boolean);
      const ciudades=$("#ciudades").value.split(/\n|,/).map(s=>s.trim()).filter(Boolean);
      const estados=$("#estados").value.split(/\n|,/).map(s=>s.trim()).filter(Boolean);
      const cols=$("#colonias").value.split(/\n|,/).map(s=>s.trim()).filter(Boolean);
      const zips=$("#zips").value.split(/\n|,/).map(s=>s.trim()).filter(Boolean);
      const mode=getMode();

      // Validaci√≥n modo por CP
      if ((mode==="zipRect" || mode==="zipGrid") && zips.length===0){
        alert("El modo seleccionado requiere ingresar al menos un C√≥digo Postal.");
        return;
      }

      const rKm=Math.max(1,parseInt($("#radiusKm").value||"5",10)); const rM=rKm*1000;
      // Grid seg√∫n modo
      let gridOnUser = $("#g-on").checked;
      if (mode==="zipRect"){ gridOnUser=false; }
      if (mode==="zipGrid"){ gridOnUser=true; }
      const stepKm = Math.max(1, parseInt($("#g-step").value||"3",10));
      const maxCells = Math.max(1, parseInt($("#g-max").value||"60",10));

      const rows=[]; const seen=new Set(); let comb=0;

      const targets = buildTargetsWithZips(ciudades, estados, cols, zips, mode, "MX");
      if (!targets.length){ log("Debes escribir al menos una Ciudad, Estado o C√≥digo Postal.","warn"); return; }

      for(const t of targets){
        let geo=null;
        if (t.useZipViewport && t.zip){
          geo = await geocodePostal(t.zip, key, t.country||"MX");
          if(!geo){ log(`No se pudo geocodificar CP: ${t.zip}`,"warn"); continue; }
          log(`CP ${t.zip}: ${geo.viewport?"viewport listo":"sin viewport"}.`);
        } else {
          geo = await geocodeText(t.query, key, {colonia:t.coloniaFlag});
          if(!geo){ log(`No se pudo geocodificar: ${t.label}`,"warn"); continue; }
        }

        const baseCenter = geo.center;
        const viewport = geo.viewport || null;

        // Determinar estrategia seg√∫n modo/target
        let centers = [];
        let useRectangle = false;
        let gridOn = gridOnUser || t.forceGrid;

        if (t.useZipViewport && viewport){
          if (mode==="zipRect"){
            useRectangle = true; centers = [baseCenter];
          } else if (mode==="zipGrid"){
            gridOn = true;
            centers = buildGridCenters({center:baseCenter, viewport, stepKm, maxCells});
          } else { // quick con zip ‚Üí c√≠rculo
            centers = gridOn ? buildGridCenters({center:baseCenter, viewport, stepKm, maxCells}) : [baseCenter];
          }
        } else {
          centers = gridOn ? buildGridCenters({center:baseCenter, viewport, stepKm, maxCells}) : [baseCenter];
        }

        log(`Ubicaci√≥n "${t.label}": centros=${centers.length}${gridOn?" (grid)":" (simple)"}${useRectangle?" (rect√°ngulo)":` (radio ${rKm} km)`}`);

        for(const kw of kws){
          let idx=0;
          for(const c of centers){
            comb++; idx++;
            log(`[${comb}] ${kw} @ ${t.label} ‚Äî centro ${idx}/${centers.length} ${useRectangle?"(rect√°ngulo)":`(radio ${rKm} km)`}`);
            try{
              const places = await textSearchAll({
                query: kw,
                center: useRectangle ? null : c,
                radiusM: useRectangle ? null : rM,
                viewport: useRectangle ? viewport : null,
                key
              });

              for(const p of places){
                if (seen.has(p.id)) continue;
                seen.add(p.id);

                const name=p.displayName?.text||"", cat=p.primaryType||"", addr=p.formattedAddress||"";
                const phone=p.nationalPhoneNumber||p.internationalPhoneNumber||"";
                const rating=p.rating||"", count=p.userRatingCount||"", guri=p.googleMapsUri||"";
                const lat=p.location?.latitude||"", lng=p.location?.longitude||"";
                const types=Array.isArray(p.types)?p.types:[]; const primary=p.primaryType||"";
                const subTypes=toggles.types?types.filter(tt=>tt!==primary).join("|"):"";
                const price=p.priceLevel!=null?String(p.priceLevel):"";
                const hours=p.currentOpeningHours?.weekdayDescriptions?.join(" | ")||(p.currentOpeningHours?.openNow!=null?(p.currentOpeningHours.openNow?"abierto":"cerrado"):"");
                const summary=p.editorialSummary?.text||"";
                let website=""; // (Place Details opcional futuro)
                let email=""; if(toggles.email){ email = await tryExtractEmail(website, parseInt($("#maxEmailSec").value||"10",10)); }
                const partners=toggles.partners?detectPartners(website):"";

                const ac = parseAddressComponents(p.addressComponents||[]);
                const cpCity = (ac.postal && ac.city) ? `${ac.postal} ${ac.city}` : (ac.postal || ac.city || "");

                rows.push([
                  kw,                 // 0 KW
                  t.state||"",        // 1 State (entrada)
                  t.city||"",         // 2 City  (entrada)
                  t.colony||"",       // 3 Colony(entrada)
                  name,               // 4 Company
                  cat,                // 5 Category
                  website,            // 6 Website (link)
                  phone,              // 7 Phone
                  email,              // 8 email
                  addr,               // 9 address
                  cpCity,             // 10 Postal Code + City (real)
                  ac.state||"",       // 11 state (real)
                  ac.postal||"",      // 12 pin code (real)
                  count,              // 13 # Reviews
                  rating,             // 14 Review
                  p.id||"",           // 15 CID
                  guri,               // 16 MapLink (link)
                  lat,                // 17 Lat
                  lng,                // 18 Lng
                  (toggles.types?((p.primaryTypeDisplayName||primary)+(subTypes?` | ${subTypes}`:"")):""), // 19 Tipos
                  (toggles.price?price:""),      // 20 Precio
                  (toggles.hours?hours:""),      // 21 Horario
                  (toggles.summary?summary:""),  // 22 Resumen
                  (toggles.photo && p.photos && p.photos[0]?.name ? p.photos[0].name : ""), // 23 Foto
                  partners            // 24 Partners
                ]);
              }
            }catch(e){
              log(`Error "${kw}" @ "${t.label}" (centro ${idx}): HTTP ${e.status||"?"} ‚Üí ${JSON.stringify(e.data||e)}`,"err");
            }
          }
        }
      }

      renderRows(rows);
      log(`Proceso finalizado. Lugares √∫nicos: ${rows.length}.`);
      if ($("#g-on").checked || getMode()==="zipGrid") log("Nota: Grid 60+ multiplica consultas. Revisa tu cuota/uso en Google Cloud.","warn");
    });

    $("#download").addEventListener("click", ()=>{
      const trs=[...document.querySelectorAll("#body tr")]; if(!trs.length){ alert("No hay datos para descargar."); return; }
      const rows=trs.map(tr=>[...tr.children].map(td=>td.textContent)); downloadCSV(rows);
    });
  </script>
</body>
</html>
