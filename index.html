<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scrapping Tool — Google Places</title>
<style>
  :root{
    --bg:#0f1115; --panel:#151923; --muted:#7c8193; --text:#e6e6e6;
    --accent:#22c55e; --chip:#1f2430; --chip-b:#2a3040; --danger:#ef4444;
    --border:#232838; --pill:#0b1220;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
    background:var(--bg); color:var(--text);
  }
  .wrap{max-width:1400px; margin:24px auto; padding:0 16px;}
  .toolbar{
    display:grid; grid-template-columns: 1.5fr 1.5fr 1fr auto auto auto auto auto 1fr auto auto;
    gap:10px; align-items:center; background:var(--panel); padding:12px; border-radius:14px; border:1px solid var(--border);
  }
  .toolbar label{font-size:12px; color:var(--muted); display:block; margin-bottom:4px;}
  .toolbar .group{display:flex; gap:10px; align-items:center;}
  textarea, input[type="text"], input[type="number"]{
    width:100%; background:#0c1020; color:var(--text); border:1px solid var(--border);
    border-radius:10px; padding:10px 12px; outline:none;
  }
  textarea{height:48px; resize:vertical;}
  .switch{display:flex; align-items:center; gap:6px; background:var(--chip); border:1px solid var(--border); padding:8px 10px; border-radius:12px;}
  .switch input{accent-color:var(--accent); transform:scale(1.1)}
  .btn{
    background:var(--chip-b); color:#fff; padding:10px 14px; border:1px solid var(--border); border-radius:12px; cursor:pointer;
  }
  .btn.primary{background:var(--accent); color:#05170c; border-color:#1aa34d; font-weight:600;}
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .note{color:var(--muted); font-size:12px}
  .status{
    margin:14px 0; background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px;
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    max-height:160px; overflow:auto; white-space:pre-wrap;
  }
  table{
    width:100%; border-collapse:separate; border-spacing:0; margin-top:14px; background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden;
  }
  th, td{padding:10px 12px; border-bottom:1px solid var(--border); vertical-align:top;}
  th{background:#121725; position:sticky; top:0; z-index:2; text-align:left;}
  tr:last-child td{border-bottom:none}
  .pill{display:inline-block; padding:4px 8px; border-radius:999px; background:var(--pill); border:1px solid var(--border); color:var(--muted); font-size:12px}
  .count{display:inline-grid; place-items:center; width:32px; height:32px; border-radius:8px; background:#0b1322; border:1px solid var(--border); font-weight:700}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .small{width:80px}
  .fit{width:120px}
  .w-160{width:160px}
  a{color:#77b2ff; text-decoration:none}
  a:hover{text-decoration:underline}
</style>
</head>
<body>
<div class="wrap">
  <h2 style="margin:0 0 12px 6px;">Scrapping Tool <span class="note">— Google Maps Places API</span></h2>

  <!-- Toolbar horizontal -->
  <div class="toolbar" id="toolbar">
    <div>
      <label>Keywords</label>
      <textarea id="kw" placeholder="Restaurante, Gimnasio... (una o varias, separadas por coma o nueva línea)">Restaurante</textarea>
    </div>
    <div>
      <label>Ubicaciones (una por línea: ciudad / colonia / CP)</label>
      <textarea id="loc" placeholder="Hermosillo Sonora&#10;Nogales Sonora&#10;83000"></textarea>
    </div>
    <div>
      <label>API Key</label>
      <input id="apiKey" type="text" placeholder="Pega aquí tu Key">
    </div>

    <div class="fit">
      <label>Radio (km)</label>
      <input id="radiusKm" type="number" min="1" max="50" value="3">
    </div>

    <div class="switch"><input id="tgLatLng" type="checkbox" checked><span>Lat &amp; Long</span></div>
    <div class="switch"><input id="tgWebsite" type="checkbox" checked><span>Website</span></div>
    <div class="switch"><input id="tgEmail" type="checkbox"><span>Email</span></div>
    <div class="small">
      <label>Seg máx. email</label>
      <input id="emailSecs" type="number" min="3" max="30" value="10">
    </div>

    <div class="switch"><input id="tgResDel" type="checkbox" checked><span>Reservas/Delivery</span></div>

    <button class="btn primary" id="btnStart">Iniciar extracción</button>
    <button class="btn" id="btnDownload">Descargar</button>
  </div>

  <div class="status" id="log">Listo para iniciar…</div>

  <div style="display:flex; gap:10px; align-items:center; margin:8px 0;">
    <div class="pill">Resultados: <b id="found">0</b></div>
    <div class="pill">Ubicación: <span id="country">—</span></div>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th class="w-160">KW</th>
        <th>State</th>
        <th>City</th>
        <th>Colony</th>
        <th>Company Name</th>
        <th>Category</th>
        <th>Website</th>
        <th>Phone</th>
        <th>email</th>
        <th>address</th>
        <th>Postal Code</th>
        <th>MapLink</th>
        <th>Reserva</th>
        <th>Delivery</th>
        <th>Lat</th>
        <th>Lng</th>
        <th>Rating</th>
        <th>#Reviews</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
/* =============== UTILIDADES UI =============== */
const $ = s => document.querySelector(s);
const logBox = $('#log'); const tbody = $('#tbody');
const foundEl = $('#found'); const countryEl = $('#country');

function log(msg){
  logBox.textContent += (logBox.textContent ? '\n' : '') + msg;
  logBox.scrollTop = logBox.scrollHeight;
}
function setFound(n){ foundEl.textContent = n; }

async function detectCountry(){
  try{
    const res = await fetch('https://ipapi.co/country_name/');
    const txt = await res.text();
    countryEl.textContent = txt || '—';
  }catch{ countryEl.textContent = '—'; }
}
detectCountry();

/* =============== Detección Reservas/Delivery =============== */
const PARTNER_DOMAINS = [
  // Reservas
  { key:'OpenTable', type:'reservation', host:'opentable.' },
  // Delivery
  { key:'UberEats',  type:'delivery', host:'ubereats.' },
  { key:'Rappi',     type:'delivery', host:'rappi.' },
  { key:'DiDi Food', type:'delivery', host:'didi-food.' },
  { key:'DoorDash',  type:'delivery', host:'doordash.' },
  { key:'PedidosYa', type:'delivery', host:'pedidosya.' },
  { key:'Just Eat',  type:'delivery', host:'just-eat.' },
  { key:'Glovo',     type:'delivery', host:'glovo.' },
  { key:'SinDelantal', type:'delivery', host:'sindelantal.' }
];

function normalizeUrl(u){
  if(!u) return '';
  let out = String(u).trim();
  if(!/^https?:\/\//i.test(out)) out = 'https://' + out;
  return out;
}
async function fetchWithTimeout(url, {timeout=8000}={}){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeout);
  try{
    const r = await fetch(url, {signal:ctrl.signal, mode:'cors'});
    clearTimeout(t);
    return await r.text();
  }catch{
    clearTimeout(t);
    return '';
  }
}
function detectPartnersFromHTML(html=''){
  const reservation = new Set();
  const delivery = new Set();
  for(const p of PARTNER_DOMAINS){
    if(html.includes(p.host)){
      if(p.type==='reservation') reservation.add(p.key);
      if(p.type==='delivery')    delivery.add(p.key);
    }
  }
  return {
    reservationProvider: Array.from(reservation).join(', '),
    deliveryProviders:   Array.from(delivery).join(', ')
  };
}
async function detectReservationDelivery(websiteUrl){
  const url = normalizeUrl(websiteUrl);
  if(!url) return {reservationProvider:'', deliveryProviders:''};
  const html = await fetchWithTimeout(url,{timeout:8000});
  if(!html) return {reservationProvider:'', deliveryProviders:''};
  return detectPartnersFromHTML(html);
}

/* =============== Places API (v1) helpers =============== */

function fieldMaskCore(){
  // Campos seguros (evitamos subtypes que da error)
  return [
    'places.id','places.displayName','places.primaryType','places.primaryTypeDisplayName',
    'places.types','places.formattedAddress','places.addressComponents',
    'places.location','places.googleMapsUri','places.rating','places.userRatingCount',
    'places.priceLevel','places.websiteUri','places.nationalPhoneNumber','places.internationalPhoneNumber',
    'nextPageToken'
  ].join(',');
}

async function geocodeCenterByText(apiKey, locationText){
  // Usa el propio searchText para obtener un centro aproximado
  const url = 'https://places.googleapis.com/v1/places:searchText';
  const body = {
    textQuery: locationText,
    maxResultCount: 1
  };
  const resp = await fetch(url,{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'X-Goog-Api-Key': apiKey,
      'X-Goog-FieldMask': 'places.location,places.displayName'
    },
    body: JSON.stringify(body)
  });
  if(!resp.ok) return null;
  const data = await resp.json();
  const place = data.places?.[0];
  return place?.location || null;
}

async function textSearchAll(apiKey, keyword, center, radiusMeters){
  // Pagina hasta agotar nextPageToken
  const results = [];
  let pageToken = null;
  const mask = fieldMaskCore();

  do{
    const url = 'https://places.googleapis.com/v1/places:searchText';
    const req = {
      textQuery: keyword,
      pageSize: 20,
      locationBias: {
        circle: { center, radius: radiusMeters }
      }
    };
    if(pageToken) req.pageToken = pageToken;

    const resp = await fetch(url,{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'X-Goog-Api-Key': apiKey,
        'X-Goog-FieldMask': mask
      },
      body: JSON.stringify(req)
    });
    if(!resp.ok){
      const err = await resp.text();
      throw new Error(`HTTP ${resp.status} en searchText: ${err}`);
    }
    const data = await resp.json();
    if(Array.isArray(data.places)) results.push(...data.places);
    pageToken = data.nextPageToken || null;

    // Google requiere pequeño delay entre páginas
    if(pageToken) await new Promise(r=>setTimeout(r, 1200));
  }while(pageToken);

  return results;
}

function acGet(component, type){
  return (component || []).find(c => c.types?.includes(type))?.longText || '';
}
function parseAddressComponents(ac){
  // Tipos comunes en Places v1
  const state   = acGet(ac, 'administrative_area_level_1') || acGet(ac,'region');
  const city    = acGet(ac, 'locality') || acGet(ac,'postal_town') || acGet(ac,'subadministrative_area_level_1');
  const colony  = acGet(ac, 'sublocality') || acGet(ac,'neighborhood') || acGet(ac,'ward');
  const postal  = acGet(ac, 'postal_code');
  return {state, city, colony, postal};
}

/* =============== Email detection (simple) =============== */
function extractEmailFromHTML(html){
  if(!html) return '';
  const mailto = html.match(/mailto:([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[A-Za-z]{2,})/);
  if(mailto) return mailto[1];
  const plain = html.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[A-Za-z]{2,}/);
  return plain ? plain[0] : '';
}
async function detectEmail(websiteUrl, maxSecs){
  const url = normalizeUrl(websiteUrl);
  if(!url) return '';
  const html = await fetchWithTimeout(url,{timeout:Math.max(3000, maxSecs*1000)});
  return extractEmailFromHTML(html);
}

/* =============== Render/CSV =============== */
const rows = [];
function renderRow(r){
  const tr = document.createElement('tr');
  const cells = [
    r.kw || '',
    r.state || '',
    r.city || '',
    r.colony || '',
    r.name || '',
    r.category || '',
    r.website || '',
    r.phone || '',
    r.email || '',
    r.address || '',
    r.postal || '',
    r.mapLink || '',
    r.reservationProvider || '',
    r.deliveryProviders || '',
    r.lat ?? '',
    r.lng ?? '',
    r.rating ?? '',
    r.reviews ?? ''
  ];
  for(const c of cells){
    const td = document.createElement('td');
    if(/^https?:\/\//i.test(c)){
      const a = document.createElement('a'); a.href=c; a.textContent='link'; a.target='_blank';
      td.appendChild(a);
    }else{
      td.textContent = (c===undefined||c===null) ? '' : c;
    }
    tr.appendChild(td);
  }
  tbody.appendChild(tr);
}

function toCSV(arr){
  const cols = ["KW","State","City","Colony","Company Name","Category","Website","Phone","email","address","Postal Code","MapLink","Reservation","Delivery","Lat","Lng","Rating","#Reviews"];
  const esc = v => {
    if(v===undefined||v===null) return '';
    const s = String(v).replace(/"/g,'""');
    return /[",\n]/.test(s) ? `"${s}"` : s;
  };
  const lines = [cols.join(',')];
  for(const r of arr){
    lines.push([
      r.kw, r.state, r.city, r.colony, r.name, r.category, r.website, r.phone, r.email, r.address, r.postal, r.mapLink, r.reservationProvider, r.deliveryProviders, r.lat, r.lng, r.rating, r.reviews
    ].map(esc).join(','));
  }
  return lines.join('\n');
}
function downloadCSV(){
  const csv = toCSV(rows);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='places_export.csv'; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
}

/* =============== START =============== */
$('#btnDownload').addEventListener('click', downloadCSV);

$('#btnStart').addEventListener('click', async ()=>{
  const apiKey = $('#apiKey').value.trim();
  if(!apiKey){ alert('Pega tu API Key.'); return; }

  const kwRaw = $('#kw').value.trim();
  const keywords = kwRaw.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
  const locs = $('#loc').value.trim().split('\n').map(s=>s.trim()).filter(Boolean);
  const radiusKm = Math.max(1, Number($('#radiusKm').value)||3);
  const radiusMeters = radiusKm * 1000;

  const tgLatLng = $('#tgLatLng').checked;
  const tgWebsite= $('#tgWebsite').checked;
  const tgEmail  = $('#tgEmail').checked;
  const emailSecs= Math.max(3, Number($('#emailSecs').value)||10);
  const tgResDel = $('#tgResDel').checked;

  if(keywords.length===0 || locs.length===0){
    alert('Escribe al menos 1 keyword y 1 ubicación.');
    return;
  }

  rows.length = 0; tbody.innerHTML=''; setFound(0);
  logBox.textContent = 'Iniciando…';

  const seen = new Set(); // para evitar duplicados por place.id

  for(const locText of locs){
    log(`Geolocalizando centro: ${locText} …`);
    const center = await geocodeCenterByText(apiKey, locText);
    if(!center){ log(`No se pudo geocodificar: ${locText}`); continue; }

    for(const kw of keywords){
      log(`Buscando "${kw}" @ "${locText}" (radio ${radiusKm} km)…`);
      let places=[];
      try{
        places = await textSearchAll(apiKey, kw, center, radiusMeters);
      }catch(e){
        log(`[Error] "${kw}" @ "${locText}": ${e.message}`);
        continue;
      }
      log(`→ ${places.length} resultados.`);

      for(const p of places){
        if(!p.id || seen.has(p.id)) continue;
        seen.add(p.id);

        const ac = parseAddressComponents(p.addressComponents || []);
        const row = {
          kw: kw,
          state: ac.state || '',
          city: ac.city || '',
          colony: ac.colony || '',
          name: p.displayName?.text || '',
          category: p.primaryTypeDisplayName?.text || p.primaryType || '',
          website: p.websiteUri || '',
          phone: p.nationalPhoneNumber || p.internationalPhoneNumber || '',
          email: '',
          address: p.formattedAddress || '',
          postal: ac.postal || '',
          mapLink: p.googleMapsUri || '',
          reservationProvider: '',
          deliveryProviders: '',
          lat: p.location?.latitude,
          lng: p.location?.longitude,
          rating: p.rating ?? '',
          reviews: p.userRatingCount ?? ''
        };

        // Website/email/partners si está activo y hay website
        if(tgWebsite && row.website){
          if(tgEmail){
            row.email = await detectEmail(row.website, emailSecs);
          }
          if(tgResDel){
            try{
              const partners = await detectReservationDelivery(row.website);
              row.reservationProvider = partners.reservationProvider || '';
              row.deliveryProviders   = partners.deliveryProviders   || '';
            }catch{ /* silencioso */ }
          }
        }

        rows.push(row);
        renderRow(row);
        setFound(rows.length);
      } // end for places
    } // end for kw
  } // end for locs

  log(`Proceso finalizado. Lugares únicos: ${rows.length}.`);
});
</script>
</body>
</html>
