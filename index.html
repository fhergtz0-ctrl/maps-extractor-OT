<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scrapping Tool ‚Äî Google Maps Places</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48'%3E%3Ctext y='34' x='4' font-size='32'%3Eüó∫Ô∏è%3C/text%3E%3C/svg%3E">
<style>
  :root{
    --bg:#0f1115; --panel:#161a22; --panel-2:#1b2130; --muted:#a7b1c2; --text:#e7ecf3;
    --accent:#22c55e; --soft:#2a3346; --chip:#222838; --chip-on:#26334a;
    --good:#16a34a; --warn:#ea580c; --bad:#ef4444; --blue:#60a5fa;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
  }
  .wrap{max-width:1260px;margin:24px auto;padding:0 16px}
  .hrow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .title{font-weight:700;font-size:20px;margin:0 0 8px}
  .sub{color:var(--muted);margin-bottom:14px}

  .toolbar{background:var(--panel);border:1px solid var(--soft);border-radius:12px;padding:16px}
  .group{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap}
  .col{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted)}
  input[type="text"], textarea, select, input[type="number"]{
    background:var(--panel-2);color:var(--text);border:1px solid var(--soft);border-radius:10px;
    height:40px;padding:0 12px;outline:0;min-width:160px;
  }
  textarea{height:40px;padding:8px 10px;min-width:220px;resize:vertical}
  .small{width:84px}
  .tiny{width:64px}
  .full{min-width:260px}
  .chips{display:flex;gap:10px;flex-wrap:wrap}
  .chip{
    background:var(--chip);border:1px solid var(--soft);border-radius:999px;padding:8px 12px;
    display:inline-flex;gap:8px;align-items:center;color:var(--text)
  }
  .chip input{transform:translateY(1px)}
  .btn{
    height:40px;border-radius:10px;border:1px solid var(--soft);background:var(--panel-2);
    color:var(--text);padding:0 14px;cursor:pointer;
  }
  .btn.primary{background:var(--good);border-color:#0e7a34;color:white}
  .btn.gray{background:var(--panel-2)}
  .badge{background:#0b1220;border:1px solid var(--soft);border-radius:999px;padding:6px 10px;color:var(--muted)}
  .counters{display:flex;gap:12px;align-items:center;margin-top:10px}

  .log{margin-top:14px;background:var(--panel);border:1px solid var(--soft);border-radius:12px;padding:12px;height:130px;overflow:auto;white-space:pre-wrap}
  .log small{color:var(--muted)}
  .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}

  .table-wrap{margin-top:14px;background:var(--panel);border:1px solid var(--soft);border-radius:12px;overflow:auto}
  table{width:max(1200px,100%);border-collapse:separate;border-spacing:0}
  thead th{
    position:sticky;top:0;background:#0f1420;border-bottom:1px solid var(--soft);
    text-align:left;padding:10px;font-weight:600
  }
  tbody td{border-bottom:1px solid var(--soft);padding:8px 10px;font-size:13px;vertical-align:top}
  thead th, tbody td{min-width:120px}
  thead th:first-child, tbody td:first-child{position:sticky;left:0;background:linear-gradient(90deg,#0f1420 90%, transparent)}
  .filters input{width:100%;height:34px;background:var(--panel-2);border:1px solid var(--soft);border-radius:8px;color:var(--text);padding:0 8px}

  .footer-note{color:var(--muted);font-size:12px;margin-top:10px}
  .hint{color:var(--muted);font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="hrow">
      <h1 class="title">Scrapping Tool</h1>
      <div class="sub">‚Äî Google Maps Places (barra √∫nica; combina Estado/Ciudad/Colonia/CP; marca los ‚ÄúCampos extra‚Äù que quieras).</div>
    </div>

    <!-- Toolbar ------------------------------------------------------------->
    <div class="toolbar" id="toolbar">
      <div class="group">
        <div class="col">
          <label>API Key</label>
          <input id="apiKey" class="full" type="text" placeholder="Pegar aqu√≠ la Key" />
        </div>
        <div class="col">
          <label>Radio por consulta (km)</label>
          <input id="radioKm" class="tiny" type="number" min="1" value="3" />
        </div>
        <div class="col">
          <label>Seg m√°x. email</label>
          <input id="maxEmailSec" class="tiny" type="number" min="5" value="10" />
        </div>

        <div class="col">
          <label>Keywords (una por l√≠nea)</label>
          <textarea id="kw" placeholder="restaurantes&#10;cafeter√≠as" rows="1"></textarea>
        </div>
        <div class="col">
          <label>Ciudad(es)</label>
          <textarea id="ciudades" placeholder="hermosillo" rows="1"></textarea>
        </div>
        <div class="col">
          <label>Estado(s)</label>
          <textarea id="estados" placeholder="sonora" rows="1"></textarea>
        </div>
        <div class="col">
          <label>Colonia(s) (opcional)</label>
          <textarea id="colonias" placeholder="centro" rows="1"></textarea>
        </div>
        <div class="col">
          <label>C√≥digos postales (opcional)</label>
          <textarea id="cps" placeholder="83000&#10;83290" rows="1"></textarea>
        </div>
      </div>

      <div class="chips" style="margin-top:12px">
        <label>Campos extra:</label>
        <label class="chip"><input id="fHorario" type="checkbox" checked> Horario</label>
        <label class="chip"><input id="fPrecio" type="checkbox" checked> Precio</label>
        <label class="chip"><input id="fMapsUri" type="checkbox"> Maps URI</label>
        <label class="chip"><input id="fFoto" type="checkbox"> Foto</label>
        <label class="chip"><input id="fTipos" type="checkbox" checked> Tipo + Subtipos</label>
        <label class="chip"><input id="fShort" type="checkbox"> Short Addr</label>
        <label class="chip"><input id="fResumen" type="checkbox"> Resumen</label>
        <label class="chip"><input id="fPartners" type="checkbox" checked> Partners (Reserva/Delivery)</label>

        <label class="chip"><input id="wantLL" type="checkbox" checked> Lat &amp; Long</label>
        <label class="chip"><input id="wantWeb" type="checkbox" checked> Website</label>
        <label class="chip"><input id="wantEmail" type="checkbox"> Email</label>

        <button id="btnStart" class="btn primary">Iniciar</button>
        <button id="btnCsv" class="btn gray">Descargar</button>
        <span class="badge">Resultados: <b id="resCount">0</b></span>
      </div>

      <div class="counters">
        <span class="badge">üëÅÔ∏è Visitas: <span id="vCount">‚Äî</span></span>
        <span class="badge">‚öôÔ∏è Extracciones: <span id="xCount">‚Äî</span></span>
        <span class="badge">üìç Pa√≠s: <span id="country">‚Äî</span></span>
      </div>
    </div>

    <!-- Log ----------------------------------------------------------------->
    <div class="log" id="log"><small>Listo para iniciar‚Ä¶</small></div>

    <!-- Tabla --------------------------------------------------------------->
    <div class="table-wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th>KW</th>
            <th>State</th>
            <th>City</th>
            <th>Colony</th>
            <th>Postal Code</th>
            <th>Company Name</th>
            <th>Category</th>
            <th>Website</th>
            <th>Phone</th>
            <th>email</th>
            <th>address</th>
            <th>Lat</th>
            <th>Lng</th>
            <th>Horario</th>
            <th>Precio</th>
            <th>Partners</th>
            <th>Review</th>
            <th># Reviews</th>
            <th>MapLink</th>
          </tr>
          <tr class="filters">
            <td><input data-col="KW" placeholder="filtrar‚Ä¶"></td>
            <td><input data-col="State" placeholder="filtrar‚Ä¶"></td>
            <td><input data-col="City" placeholder="filtrar‚Ä¶"></td>
            <td><input data-col="Colony" placeholder="filtrar‚Ä¶"></td>
            <td><input data-col="Postal Code" placeholder="filtrar‚Ä¶"></td>
            <td><input data-col="Company Name" placeholder="filtrar‚Ä¶"></td>
            <td><input data-col="Category" placeholder="filtrar‚Ä¶"></td>
            <td><input data-col="Website" placeholder="filtrar‚Ä¶"></td>
            <td><input data-col="Phone" placeholder="filtrar‚Ä¶"></td>
            <td><input data-col="email" placeholder="filtrar‚Ä¶"></td>
            <td><input data-col="address" placeholder="filtrar‚Ä¶"></td>
            <td><input data-col="Lat" placeholder="filtra‚Ä¶"></td>
            <td><input data-col="Lng" placeholder="filtra‚Ä¶"></td>
            <td><input data-col="Horario" placeholder="filtrar‚Ä¶"></td>
            <td><input data-col="Precio" placeholder="filtrar‚Ä¶"></td>
            <td><input data-col="Partners" placeholder="filtrar‚Ä¶"></td>
            <td><input data-col="Review" placeholder="filtrar‚Ä¶"></td>
            <td><input data-col="# Reviews" placeholder="filtrar‚Ä¶"></td>
            <td><input data-col="MapLink" placeholder="filtrar‚Ä¶"></td>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="footer-note">
      Origen: esta p√°gina ‚Äî sin backend ‚Äî llama a Google Places v1 y Geocoding.
      <span class="hint">Si el geocodificado falla para ‚Äúcolonia‚Äù, intentamos ciudad+estado y despu√©s solo ciudad/estado o CP.</span>
    </div>
  </div>

<script>
/* ----------------------- util UI --------------------------------------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const log = msg => {
  const el = $("#log");
  el.textContent += (el.textContent ? "\\n" : "") + msg;
  el.scrollTop = el.scrollHeight;
};
const clearLog = () => $("#log").textContent = "Iniciando‚Ä¶";

/* ----------------------- m√©tricas (CountAPI) --------------------------- */
const COUNT_NS = location.host.replace(/[:.]/g,'-') || 'localdev';
const countapiGet = async (key) => {
  try{
    const r = await fetch(`https://api.countapi.xyz/get/${COUNT_NS}/${key}`);
    if(!r.ok) throw 0; return (await r.json()).value;
  }catch{ return "‚Äî"; }
};
const countapiHit = async (key) => {
  try{ await fetch(`https://api.countapi.xyz/hit/${COUNT_NS}/${key}`); }catch{}
};
async function updateMetricsUI(){
  $("#vCount").textContent = await countapiGet('pageviews');
  $("#xCount").textContent = await countapiGet('runs');
  try{
    const r = await fetch("https://ipapi.co/json/");
    const j = await r.json();
    $("#country").textContent = `${j.country_name || j.country} (${j.country || ""})`;
  }catch{ $("#country").textContent = "‚Äî"; }
}
updateMetricsUI(); countapiHit('pageviews');

/* ----------------------- Google helpers ------------------------------- */
function fieldMask(selected){
  // pide solo campos v√°lidos en Places v1
  const base = [
    "places.id","places.displayName","places.primaryType","places.types",
    "places.formattedAddress","places.location","places.plusCode",
    "places.nationalPhoneNumber","places.internationalPhoneNumber",
    "places.rating","places.userRatingCount","places.priceLevel",
    "places.googleMapsUri"
  ];
  if(selected.short) base.push("places.shortFormattedAddress");
  if(selected.horario) base.push("places.currentOpeningHours.openNow","places.currentOpeningHours.weekdayDescriptions");
  if(selected.foto) base.push("places.photos.name");
  if(selected.resumen) base.push("places.editorialSummary");
  // mapsUri ya se devuelve con googleMapsUri (no pedir m√°s)
  return base.join(",");
}

/* geocodificaci√≥n robusta (colonia+ciudad+estado ‚Üí ciudad+estado ‚Üí ciudad ‚Üí estado ‚Üí CP) */
async function geocodeCombo({colonia, ciudad, estado, cp, key}){
  const tryList = [];
  if(cp) tryList.push({type:'cp', url: `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(cp)}&key=${key}`});
  if(colonia && ciudad && estado) tryList.push({type:'full', q:`${colonia}, ${ciudad}, ${estado}`});
  if(ciudad && estado) tryList.push({type:'citystate', q:`${ciudad}, ${estado}`});
  if(ciudad) tryList.push({type:'city', q: ciudad});
  if(estado) tryList.push({type:'state', q: estado});

  for(const t of tryList){
    try{
      let url = t.url || `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(t.q)}&key=${key}`;
      const r = await fetch(url);
      const j = await r.json();
      if(j.results && j.results[0]){
        const g = j.results[0].geometry;
        return {
          lat: g.location.lat,
          lng: g.location.lng,
          viewport: g.viewport || null,
          normalized: j.results[0].formatted_address
        };
      }
    }catch{}
  }
  return null;
}

/* textSearch con paginaci√≥n hasta ~200 (si Google entrega) */
async function textSearchAll({kw, center, radiusM, key, mask}){
  const headers = {
    "Content-Type":"application/json",
    "X-Goog-Api-Key": key,
    "X-Goog-FieldMask": mask + ",nextPageToken"
  };
  const bodyBase = {
    textQuery: kw,
    languageCode:"es",
    regionCode:"MX",
    locationBias:{ circle:{ center:{ latitude:center.lat, longitude:center.lng }, radius: radiusM } },
    pageSize: 20
  };

  const out = [];
  const seen = new Set();
  let pageToken=null, guard=0;

  while(guard++<10){
    const body = {...bodyBase};
    if(pageToken) body.pageToken = pageToken;

    const r = await fetch("https://places.googleapis.com/v1/places:searchText",{method:"POST",headers,body:JSON.stringify(body)});
    if(!r.ok){
      const t = await r.text();
      throw new Error(`HTTP ${r.status} en searchText: ${t}`);
    }
    const j = await r.json();
    (j.places||[]).forEach(p=>{
      if(!p.id || seen.has(p.id)) return;
      seen.add(p.id); out.push(p);
    });
    pageToken = j.nextPageToken || null;
    if(!pageToken) break;
    await new Promise(r=>setTimeout(r, 1200));
  }
  return out;
}

/* enriquecedores simples */
function extractWebsiteFromPlace(p){
  // si viene website del detalle, √∫salo; en v1 textsearch no siempre viene, pero
  // probaremos con una heur√≠stica: algunas veces types incluyen entidades con dominios no‚Ä¶
  // preferimos googleMapsUri entonces
  return p.websiteUri || "";
}
function detectPartners(web){
  const s = (web||"").toLowerCase();
  const map = [
    ["opentable","reservas"],
    ["ubereats","delivery"],
    ["rappi","delivery"],
    ["didi","delivery"],
    ["didi-food","delivery"],
    ["doordash","delivery"],
    ["justeat","delivery"]
  ];
  for(const [k,lbl] of map){
    if(s.includes(k)) return `${lbl}:${k}`;
  }
  return "";
}

/* CSV */
function toCsv(rows){
  const head = Object.keys(rows[0]||{});
  const esc = v => (v==null?"":String(v)).replace(/"/g,'""');
  const lines = [
    head.join(","),
    ...rows.map(r=>head.map(k=>`"${esc(r[k])}"`).join(","))
  ];
  return lines.join("\\r\\n");
}

/* ----------------------- flujo principal ------------------------------- */
const state = { rows:[] };

function collectCombos(){
  const arr = (t)=> t.split(/\\r?\\n|,/).map(s=>s.trim()).filter(Boolean);
  const kws = arr($("#kw").value);                // al menos 1
  const ciudades = arr($("#ciudades").value);     // 1+
  const estados  = arr($("#estados").value);      // 0/1+
  const colonias = arr($("#colonias").value);     // 0/1+
  const cps      = arr($("#cps").value);          // 0/+

  const combos = [];
  const norm = (a)=> (a.length? a : [""]);

  for(const kw of kws){
    for(const ciudad of norm(ciudades)){
      for(const estado of norm(estados)){
        // si hay CPs, genero combos por cada CP (ignora colonia)
        if(cps.length){
          for(const cp of cps){
            combos.push({kw, ciudad, estado, colonia:"", cp});
          }
        }else{
          for(const colonia of norm(colonias)){
            combos.push({kw, ciudad, estado, colonia, cp:""});
          }
        }
      }
    }
  }
  return combos;
}

function currentFlags(){
  return {
    horario: $("#fHorario").checked,
    precio:  $("#fPrecio").checked,
    mapsUri: $("#fMapsUri").checked,
    foto:    $("#fFoto").checked,
    tipos:   $("#fTipos").checked,
    short:   $("#fShort").checked,
    resumen: $("#fResumen").checked,
    partners:$("#fPartners").checked,
    wantLL:  $("#wantLL").checked,
    wantWeb: $("#wantWeb").checked,
    wantEmail: $("#wantEmail").checked
  };
}

function rowFromPlace({p, combo, flags}){
  const addr = p.shortFormattedAddress || p.formattedAddress || "";
  const phone = p.nationalPhoneNumber || p.internationalPhoneNumber || "";
  const cat = p.primaryTypeDisplayName || p.primaryType || (p.types||[])[0] || "";
  const web = extractWebsiteFromPlace(p);
  const partners = flags.partners ? detectPartners(web) : "";

  return {
    "KW": combo.kw,
    "State": combo.estado || "",
    "City": combo.ciudad || "",
    "Colony": combo.colonia || "",
    "Postal Code": (p.plusCode && p.plusCode.globalCode ? (addr.match(/\\b\\d{4,6}\\b/)||[])[0] || "" : (addr.match(/\\b\\d{4,6}\\b/)||[])[0] || ""),
    "Company Name": (p.displayName&&p.displayName.text)||"",
    "Category": cat,
    "Website": web,
    "Phone": phone,
    "email": "", // opcional si implementas descubrimiento
    "address": addr,
    "Lat": p.location?.latitude ?? "",
    "Lng": p.location?.longitude ?? "",
    "Horario": flags.horario ? (p.currentOpeningHours?.weekdayDescriptions||[]).join(" | ") : "",
    "Precio": flags.precio ? (p.priceLevel ?? "") : "",
    "Partners": partners,
    "Review": p.rating ?? "",
    "# Reviews": p.userRatingCount ?? "",
    "MapLink": p.googleMapsUri || ""
  };
}

function paint(){
  const tb = $("#tbody"); tb.innerHTML = "";
  const frag = document.createDocumentFragment();
  state.rows.forEach(r=>{
    const tr = document.createElement("tr");
    Object.values(r).forEach(v=>{
      const td = document.createElement("td");
      td.textContent = v==null?"":v; tr.appendChild(td);
    });
    frag.appendChild(tr);
  });
  tb.appendChild(frag);
  $("#resCount").textContent = state.rows.length;
}

async function start(){
  clearLog();
  const key = $("#apiKey").value.trim();
  if(!key){ log("‚úã Coloca tu API Key"); return; }

  const combos = collectCombos();
  if(!combos.length){ log("‚úã Escribe al menos 1 keyword y 1 ciudad"); return; }

  const flags = currentFlags();
  const radiusM = Math.max(1, Number($("#radioKm").value||3))*1000;
  state.rows = []; paint();

  // Build field mask
  const mask = fieldMask({
    short: flags.short, horario: flags.horario, foto: flags.foto, resumen: flags.resumen
  });

  let uniquePlaces = new Map();
  let combosOK = 0;

  for(const combo of combos){
    const label = [combo.colonia, combo.ciudad, combo.estado, combo.cp].filter(Boolean).join(", ");
    log(`Buscando "${combo.kw}" @ "${label}" (radio ${(radiusM/1000)|0} km)‚Ä¶`);
    // Geocode
    let geo = await geocodeCombo({colonia:combo.colonia, ciudad:combo.ciudad, estado:combo.estado, cp:combo.cp, key});
    if(!geo){
      log(`‚ö†Ô∏è No se pudo geocodificar: ${label}`);
      continue;
    }
    combosOK++;

    // Text search (paginado)
    let places = [];
    try{
      places = await textSearchAll({kw:combo.kw, center:{lat:geo.lat,lng:geo.lng}, radiusM, key, mask});
      log(`  ‚Üí ${places.length} resultados`);
    }catch(e){
      log(`‚ùå Error "${combo.kw}" @ "${label}": ${e.message}`);
      continue;
    }

    // convertir a filas + deduplicar por id
    for(const p of places){
      if(uniquePlaces.has(p.id)) continue;
      const row = rowFromPlace({p, combo, flags});
      uniquePlaces.set(p.id, row);
      state.rows.push(row);
    }
    paint();
    await new Promise(r=>setTimeout(r,500));
  }

  log(`Proceso finalizado. Lugares √∫nicos: ${state.rows.length}.`);
  countapiHit('runs');
}

function downloadCsv(){
  if(!state.rows.length){ alert("No hay datos."); return; }
  const csv = toCsv(state.rows);
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "places.csv"; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

$("#btnStart").addEventListener("click", start);
$("#btnCsv").addEventListener("click", downloadCsv);

// filtros r√°pidos por cabecera
$$(".filters input").forEach(inp=>{
  inp.addEventListener("input", ()=>{
    const col = inp.getAttribute("data-col");
    const q = inp.value.toLowerCase();
    const idx = Array.from($("#tbl thead tr:nth-child(1)").children).findIndex(th=>th.textContent.trim()===col);
    $("#tbody").querySelectorAll("tr").forEach(tr=>{
      const td = tr.children[idx];
      const t = (td?.textContent||"").toLowerCase();
      tr.style.display = t.includes(q) ? "" : "none";
    });
  });
});
</script>
</body>
</html>
