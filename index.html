<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scrapping Tool ‚Äî Google Maps Places</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48'%3E%3Ctext x='6' y='34' font-size='28'%3Eüó∫Ô∏è%3C/text%3E%3C/svg%3E">
<style>
  :root{
    --bg:#0f1115;--panel:#161a22;--panel2:#1b2130;--soft:#273048;--muted:#9aa7bd;--text:#e9eef6;
    --accent:#22c55e;--good:#16a34a;--warn:#ea580c;--bad:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial}
  .wrap{max-width:1260px;margin:22px auto;padding:0 16px}
  h1{margin:0 0 6px;font-size:20px}
  .sub{color:var(--muted);margin-bottom:12px}
  /* toolbar */
  .toolbar{background:var(--panel);border:1px solid var(--soft);border-radius:12px;padding:14px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted)}
  input[type=text],textarea,select,input[type=number]{background:var(--panel2);border:1px solid var(--soft);color:var(--text);border-radius:10px;height:40px;padding:0 12px;min-width:160px;outline:0}
  textarea{height:40px;padding:8px 10px;resize:vertical;min-width:220px}
  .tiny{width:76px}.small{width:96px}.wide{min-width:260px}
  .chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .chip{display:inline-flex;gap:8px;align-items:center;background:#1f2433;border:1px solid var(--soft);border-radius:999px;padding:8px 12px}
  .chip input{transform:translateY(1px)}
  .btn{height:40px;border-radius:10px;border:1px solid var(--soft);background:#1f2433;color:var(--text);padding:0 14px;cursor:pointer}
  .btn.primary{background:var(--good);border-color:#0e7a34;color:#fff}
  .badge{background:#0d1322;border:1px solid var(--soft);border-radius:999px;padding:6px 10px;color:var(--muted)}
  .bad{color:var(--bad)} .ok{color:var(--good)} .warn{color:var(--warn)}
  .counters{display:flex;gap:12px;align-items:center;margin-top:10px}
  /* log */
  .log{margin-top:12px;background:var(--panel);border:1px solid var(--soft);border-radius:12px;padding:10px;height:130px;overflow:auto;white-space:pre-wrap}
  /* table */
  .tbl-wrap{margin-top:12px;background:var(--panel);border:1px solid var(--soft);border-radius:12px;overflow:auto}
  table{width:max(1200px,100%);border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:#0f1420;border-bottom:1px solid var(--soft);text-align:left;padding:10px;font-weight:600}
  tbody td{border-bottom:1px solid var(--soft);padding:8px 10px;font-size:13px;vertical-align:top}
  thead th,tbody td{min-width:120px}
  .filters input{width:100%;height:34px;background:var(--panel2);border:1px solid var(--soft);border-radius:8px;color:var(--text);padding:0 8px}
  .foot{color:var(--muted);font-size:12px;margin-top:10px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Scrapping Tool</h1>
  <div class="sub">‚Äî Google Maps Places (barra √∫nica; combina Estado/Ciudad/Colonia/CP; marca los ‚ÄúCampos extra‚Äù que desees).</div>

  <div class="toolbar">
    <div class="row">
      <div class="col">
        <label>API Key</label>
        <input id="apiKey" class="wide" type="text" placeholder="Pegar aqu√≠ la Key">
      </div>
      <div class="col">
        <label>Radio por consulta (km)</label>
        <input id="radioKm" class="tiny" type="number" value="3" min="1">
      </div>
      <div class="col">
        <label>Seg m√°x. email</label>
        <input id="maxEmailSec" class="tiny" type="number" value="10" min="5">
      </div>

      <div class="col">
        <label>Keywords (una por l√≠nea)</label>
        <textarea id="kw" placeholder="restaurantes&#10;cafeter√≠as"></textarea>
      </div>
      <div class="col">
        <label>Ciudad(es)</label>
        <textarea id="ciudades" placeholder="hermosillo"></textarea>
      </div>
      <div class="col">
        <label>Estado(s)</label>
        <textarea id="estados" placeholder="sonora"></textarea>
      </div>
      <div class="col">
        <label>Colonia(s) (opcional)</label>
        <textarea id="colonias" placeholder="centro"></textarea>
      </div>
      <div class="col">
        <label>C√≥digos postales (opcional)</label>
        <textarea id="cps" placeholder="83000&#10;83290"></textarea>
      </div>
    </div>

    <div class="chips">
      <span style="align-self:center;color:#9aa7bd">Campos extra:</span>
      <label class="chip"><input id="fHorario" type="checkbox" checked> Horario</label>
      <label class="chip"><input id="fPrecio"  type="checkbox" checked> Precio</label>
      <label class="chip"><input id="fMapsUri" type="checkbox"> Maps URI</label>
      <label class="chip"><input id="fFoto"    type="checkbox"> Foto</label>
      <label class="chip"><input id="fTipos"   type="checkbox" checked> Tipo + Subtipos</label>
      <label class="chip"><input id="fShort"   type="checkbox"> Short Addr</label>
      <label class="chip"><input id="fResumen" type="checkbox"> Resumen</label>
      <label class="chip"><input id="fPartners" type="checkbox" checked> Partners (Reserva/Delivery)</label>

      <label class="chip"><input id="wantLL"   type="checkbox" checked> Lat &amp; Long</label>
      <label class="chip"><input id="wantWeb"  type="checkbox" checked> Website</label>
      <label class="chip"><input id="wantMail" type="checkbox"> Email</label>

      <button id="btnStart" class="btn primary">Iniciar</button>
      <button id="btnCsv" class="btn">Descargar</button>
      <span class="badge">Resultados: <b id="resCount">0</b></span>
    </div>

    <div class="counters">
      <span class="badge">üëÅÔ∏è Visitas: <span id="vCount">‚Äî</span></span>
      <span class="badge">‚öôÔ∏è Extracciones: <span id="xCount">‚Äî</span></span>
      <span class="badge">üìç Pa√≠s: <span id="country">‚Äî</span></span>
    </div>
  </div>

  <div id="log" class="log">Listo para iniciar‚Ä¶</div>

  <div class="tbl-wrap">
    <table id="tbl">
      <thead>
        <tr>
          <th>KW</th><th>State</th><th>City</th><th>Colony</th><th>Postal Code</th>
          <th>Company Name</th><th>Category</th><th>Website</th><th>Phone</th><th>email</th>
          <th>address</th><th>Lat</th><th>Lng</th><th>Horario</th><th>Precio</th><th>Partners</th>
          <th>Review</th><th># Reviews</th><th>MapLink</th>
        </tr>
        <tr class="filters">
          <td><input data-col="KW" placeholder="filtrar‚Ä¶"></td>
          <td><input data-col="State" placeholder="filtrar‚Ä¶"></td>
          <td><input data-col="City" placeholder="filtrar‚Ä¶"></td>
          <td><input data-col="Colony" placeholder="filtrar‚Ä¶"></td>
          <td><input data-col="Postal Code" placeholder="filtrar‚Ä¶"></td>
          <td><input data-col="Company Name" placeholder="filtrar‚Ä¶"></td>
          <td><input data-col="Category" placeholder="filtrar‚Ä¶"></td>
          <td><input data-col="Website" placeholder="filtrar‚Ä¶"></td>
          <td><input data-col="Phone" placeholder="filtrar‚Ä¶"></td>
          <td><input data-col="email" placeholder="filtrar‚Ä¶"></td>
          <td><input data-col="address" placeholder="filtrar‚Ä¶"></td>
          <td><input data-col="Lat" placeholder="filtra‚Ä¶"></td>
          <td><input data-col="Lng" placeholder="filtra‚Ä¶"></td>
          <td><input data-col="Horario" placeholder="filtrar‚Ä¶"></td>
          <td><input data-col="Precio" placeholder="filtrar‚Ä¶"></td>
          <td><input data-col="Partners" placeholder="filtrar‚Ä¶"></td>
          <td><input data-col="Review" placeholder="filtrar‚Ä¶"></td>
          <td><input data-col="# Reviews" placeholder="filtrar‚Ä¶"></td>
          <td><input data-col="MapLink" placeholder="filtrar‚Ä¶"></td>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="foot">
    Origen: esta p√°gina ‚Äî sin backend ‚Äî usa Google Geocoding y Places v1. Si falla colonia, probamos ciudad+estado ‚Üí ciudad ‚Üí estado; si pusiste CP, lo intentamos primero con <code>components=postal_code:XXXX|country:MX</code>.
  </div>
</div>

<script>
/* ==================== util UI ==================== */
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const appendLog = t=>{ const el=$("#log"); el.textContent += (el.textContent?"\\n":"")+t; el.scrollTop=el.scrollHeight; };
const clearLog = ()=>$("#log").textContent="Iniciando‚Ä¶";

/* ==================== CountAPI (tolerante) ==================== */
const COUNT_NS = "maps-extractor-ot"; // namespace corto y estable
async function capiGet(key){ try{ const r=await fetch(`https://api.countapi.xyz/get/${COUNT_NS}/${key}`); if(!r.ok) throw 0; return (await r.json()).value; }catch{ return "‚Äî"; } }
async function capiHit(key){ try{ await fetch(`https://api.countapi.xyz/hit/${COUNT_NS}/${key}`); }catch{} }
async function updateMetrics(){
  $("#vCount").textContent = await capiGet("pageviews");
  $("#xCount").textContent = await capiGet("runs");
  try{
    const r = await fetch("https://ipapi.co/json/"); const j = await r.json();
    $("#country").textContent = `${j.country_name||j.country||"‚Äî"} (${j.country||"?"})`;
  }catch{ $("#country").textContent="‚Äî"; }
}
updateMetrics(); capiHit("pageviews");

/* ==================== helpers ==================== */
const arr = t => t.split(/\\r?\\n|,|;/).map(s=>s.trim()).filter(Boolean);
const cleanCPs = t => arr(t).map(s=>s.replace(/\\D/g,"")).filter(s=>s.length>=4);

function fieldMask(flags){
  const base = [
    "places.id","places.displayName","places.primaryType","places.types",
    "places.formattedAddress","places.location","places.plusCode",
    "places.nationalPhoneNumber","places.internationalPhoneNumber",
    "places.rating","places.userRatingCount","places.priceLevel",
    "places.googleMapsUri"
  ];
  if(flags.short)   base.push("places.shortFormattedAddress");
  if(flags.horario) base.push("places.currentOpeningHours.openNow","places.currentOpeningHours.weekdayDescriptions");
  if(flags.foto)    base.push("places.photos.name");
  if(flags.resumen) base.push("places.editorialSummary");
  return base.join(",");
}

async function geocodeText(q, key){
  const url = `https://maps.googleapis.com/maps/api/geocode/json?region=mx&address=${encodeURIComponent(q)}&key=${key}`;
  const r = await fetch(url); const j = await r.json();
  if(j.results && j.results[0]){
    const g=j.results[0].geometry;
    return {lat:g.location.lat,lng:g.location.lng,viewport:g.viewport||null, label:j.results[0].formatted_address, mode:`texto: ${q}`};
  }
  return null;
}
async function geocodeCP(cp, key){
  const url = `https://maps.googleapis.com/maps/api/geocode/json?components=postal_code:${cp}|country:MX&key=${key}`;
  const r = await fetch(url); const j = await r.json();
  if(j.results && j.results[0]){
    const g=j.results[0].geometry;
    return {lat:g.location.lat,lng:g.location.lng,viewport:g.viewport||null, label:j.results[0].formatted_address, mode:`CP: ${cp}`};
  }
  return null;
}
async function geocodeSmart({colonia,ciudad,estado,cp,key}){
  // 1) CP
  if(cp){
    const a = await geocodeCP(cp,key); if(a) return a;
  }
  // 2) colonia+ciudad+estado
  if(colonia && ciudad && estado){
    const a = await geocodeText(`${colonia}, ${ciudad}, ${estado}`, key); if(a) return a;
  }
  // 3) ciudad+estado
  if(ciudad && estado){ const a = await geocodeText(`${ciudad}, ${estado}`, key); if(a) return a; }
  // 4) ciudad
  if(ciudad){ const a = await geocodeText(ciudad, key); if(a) return a; }
  // 5) estado
  if(estado){ const a = await geocodeText(estado, key); if(a) return a; }
  return null;
}

function detectPartners(website){
  const s=(website||"").toLowerCase();
  const rules=[["opentable","reservas"],["ubereats","delivery"],["rappi","delivery"],["didi","delivery"],["doordash","delivery"]];
  for(const [k,lbl] of rules){ if(s.includes(k)) return `${lbl}:${k}`; }
  return "";
}

function rowFromPlace({p, combo, flags}){
  const addr = p.shortFormattedAddress || p.formattedAddress || "";
  const cat  = p.primaryTypeDisplayName || p.primaryType || (p.types||[])[0] || "";
  const phone= p.nationalPhoneNumber || p.internationalPhoneNumber || "";
  const web  = p.websiteUri || ""; // textSearch no siempre lo trae; mantenemos heur√≠stica simple
  return {
    "KW": combo.kw,
    "State": combo.estado||"",
    "City":  combo.ciudad||"",
    "Colony": combo.colonia||"",
    "Postal Code": (addr.match(/\\b\\d{4,6}\\b/)||[])[0] || "",
    "Company Name": (p.displayName&&p.displayName.text)||"",
    "Category": cat,
    "Website": web,
    "Phone": phone,
    "email": "",
    "address": addr,
    "Lat": p.location?.latitude ?? "",
    "Lng": p.location?.longitude ?? "",
    "Horario": flags.horario ? (p.currentOpeningHours?.weekdayDescriptions||[]).join(" | ") : "",
    "Precio": flags.precio ? (p.priceLevel ?? "") : "",
    "Partners": flags.partners ? detectPartners(web) : "",
    "Review": p.rating ?? "",
    "# Reviews": p.userRatingCount ?? "",
    "MapLink": p.googleMapsUri || ""
  };
}

function toCsv(rows){
  if(!rows.length) return "";
  const head = Object.keys(rows[0]);
  const esc = v => (v==null?"":String(v)).replace(/"/g,'""');
  const lines = [head.join(","), ...rows.map(r=>head.map(k=>`"${esc(r[k])}"`).join(","))];
  return lines.join("\\r\\n");
}

function paint(rows){
  const tb = $("#tbody"); tb.innerHTML="";
  const frag = document.createDocumentFragment();
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    Object.values(r).forEach(v=>{
      const td=document.createElement("td"); td.textContent=(v==null?"":v); tr.appendChild(td);
    });
    frag.appendChild(tr);
  });
  tb.appendChild(frag);
  $("#resCount").textContent = rows.length;
}

/* Places search paginado */
async function textSearchAll({kw, center, radiusM, key, mask}){
  const headers={
    "Content-Type":"application/json",
    "X-Goog-Api-Key": key,
    "X-Goog-FieldMask": mask + ",nextPageToken"
  };
  const base={
    textQuery: kw,
    languageCode:"es",
    regionCode:"MX",
    locationBias:{ circle:{ center:{ latitude:center.lat, longitude:center.lng }, radius: radiusM } },
    pageSize:20
  };
  const out=[]; const seen=new Set(); let token=null, guard=0;
  while(guard++<10){
    const body={...base}; if(token) body.pageToken=token;
    const r=await fetch("https://places.googleapis.com/v1/places:searchText",{method:"POST",headers,body:JSON.stringify(body)});
    if(!r.ok){ const t=await r.text(); throw new Error(`HTTP ${r.status} en searchText: ${t}`); }
    const j=await r.json();
    (j.places||[]).forEach(p=>{ if(!p.id||seen.has(p.id)) return; seen.add(p.id); out.push(p); });
    token=j.nextPageToken||null; if(!token) break;
    await new Promise(r=>setTimeout(r,1200));
  }
  return out;
}

/* ==================== run ==================== */
const state={rows:[]};

function getCombos(){
  const kws=arr($("#kw").value);
  const ciudades=arr($("#ciudades").value);
  const estados=arr($("#estados").value);
  const colonias=arr($("#colonias").value);
  const cps=cleanCPs($("#cps").value);

  const combos=[];
  const nz=a=>a.length?a:[""];
  for(const kw of kws){
    // si hay CPs, tambi√©n genero combos por CP
    for(const ciudad of nz(ciudades)){
      for(const estado of nz(estados)){
        if(cps.length){
          for(const cp of cps) combos.push({kw,ciudad,estado,colonia:"",cp});
        }
        // adem√°s, si hay colonias, tambi√©n
        for(const colonia of nz(colonias)){
          if(colonia) combos.push({kw,ciudad,estado,colonia,cp:""});
        }
        // si no hay ni colonias ni cps, tambi√©n agrego el combo base ciudad/estado
        if(!cps.length && !colonias.length) combos.push({kw,ciudad,estado,colonia:"",cp:""});
      }
    }
  }
  return combos;
}

function currentFlags(){
  return {
    horario: $("#fHorario").checked,
    precio:  $("#fPrecio").checked,
    mapsUri: $("#fMapsUri").checked,
    foto:    $("#fFoto").checked,
    tipos:   $("#fTipos").checked,
    short:   $("#fShort").checked,
    resumen: $("#fResumen").checked,
    partners:$("#fPartners").checked,
    wantLL:  $("#wantLL").checked,
    wantWeb: $("#wantWeb").checked,
    wantMail:$("#wantMail").checked
  };
}

async function start(){
  clearLog();
  const key=$("#apiKey").value.trim();
  if(!key){ appendLog("‚úã Coloca tu API Key"); return; }

  const combos=getCombos();
  if(!combos.length){ appendLog("‚úã Escribe al menos 1 keyword y 1 ciudad/estado/cp"); return; }

  const flags=currentFlags();
  const radiusM=Math.max(1, Number($("#radioKm").value||3))*1000;

  state.rows=[]; paint(state.rows);

  const mask=fieldMask({short:flags.short,horario:flags.horario,foto:flags.foto,resumen:flags.resumen});
  const dedup=new Map();

  for(const combo of combos){
    const label=[combo.colonia, combo.ciudad, combo.estado, combo.cp].filter(Boolean).join(", ");
    appendLog(`Buscando "${combo.kw}" @ "${label}" (radio ${(radiusM/1000)|0} km)‚Ä¶`);
    const geo=await geocodeSmart({colonia:combo.colonia,ciudad:combo.ciudad,estado:combo.estado,cp:combo.cp,key});
    if(!geo){ appendLog(`‚ö†Ô∏è No se pudo geocodificar: ${label}`); continue; }
    appendLog(`  ‚Üí Geocode por ${geo.mode} ‚Üí ${geo.label}`);

    let places=[];
    try{
      places = await textSearchAll({kw:combo.kw,center:{lat:geo.lat,lng:geo.lng},radiusM,key,mask});
      appendLog(`  ‚Üí ${places.length} resultados`);
    }catch(e){ appendLog(`‚ùå Error "${combo.kw}" @ "${label}": ${e.message}`); continue; }

    for(const p of places){
      if(dedup.has(p.id)) continue;
      const row=rowFromPlace({p,combo,flags});
      dedup.set(p.id,true); state.rows.push(row);
    }
    paint(state.rows);
    await new Promise(r=>setTimeout(r,400));
  }

  appendLog(`Proceso finalizado. Lugares √∫nicos: ${state.rows.length}.`);
  capiHit("runs");
}

function downloadCsv(){
  if(!state.rows.length){ alert("No hay datos."); return; }
  const csv=toCsv(state.rows);
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="places.csv"; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

$("#btnStart").addEventListener("click", start);
$("#btnCsv").addEventListener("click", downloadCsv);

$$(".filters input").forEach(inp=>{
  inp.addEventListener("input",()=>{
    const col=inp.getAttribute("data-col");
    const q=inp.value.toLowerCase();
    const idx=Array.from(document.querySelectorAll("#tbl thead tr:first-child th")).findIndex(th=>th.textContent.trim()===col);
    $("#tbody").querySelectorAll("tr").forEach(tr=>{
      const t=(tr.children[idx]?.textContent||"").toLowerCase();
      tr.style.display = t.includes(q)? "" : "none";
    });
  });
});
</script>
</body>
</html>
