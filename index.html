<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Scrapping Tool — Encabezados estilo hoja</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- CSS -->
  <link rel="stylesheet" href="./assets/css/scrapping-tool.css?v=5">
  <link rel="stylesheet" href="./assets/css/utilities.css?v=5">
  <link rel="stylesheet" href="./assets/css/print.css?v=5" media="print">
</head>
<body>
  <!-- ======== App ======== -->
  <div class="app">
    <aside>
      <h1>Scrapping Tool</h1>
      <p class="hint" style="margin-bottom:12px">Google Maps — <b>Places API (New)</b> + Maps JS</p>

      <!-- Tarjeta de estado -->
      <div class="pill" id="statusPill"><span class="dot"></span><span id="statusText">“Keyword in Ubicación”</span></div>
      <p style="margin:10px 0 6px; font-weight:700">Progress <span id="comboProgress">(0/0)</span></p>
      <div class="progress" aria-label="progreso combinaciones"><div id="comboBar"></div></div>

      <label style="margin-top:14px">API Key</label>
      <input id="apiKey" placeholder="pegar aqui la Key"/>

      <label id="kwLabel">Keywords (0)</label>
      <textarea id="keywords">Restaurante</textarea>

      <label id="locLabel">Ubicaciones (0)</label>
      <textarea id="locations">Hermosillo Sonora
Nogales Sonora</textarea>

      <label>Segundos Max para Extraer Correo</label>
      <input id="emailTimeout" value="10" />
      <p class="hint">El email no lo entrega Google; se intenta detectar en la web del negocio (puede fallar por CORS).</p>

      <p class="hint">Origen: <span id="origin"></span></p>
    </aside>

    <main>
      <!-- Toolbar superior -->
      <div class="toolbar">
        <div style="display:flex; align-items:center; gap:10px; min-width:260px">
          <div class="badge"><span id="count">0</span></div>
          <div>
            <div style="font-weight:700; font-size:12px; opacity:.85">RESULTADOS ENCONTRADOS</div>
            <div class="progress" aria-label="progreso resultados"><div id="bar"></div></div>
          </div>
        </div>

        <button class="btn" id="clear">Limpiar Datos</button>

        <label class="checkpill"><input type="checkbox" id="includeLatLng" checked /> Extraer Lat & Long</label>
        <label class="checkpill"><input type="checkbox" id="extractEmail" /> Extraer Email</label>

        <button class="btn" id="export">Descargar</button>

        <input class="searchbox" id="globalSearch" placeholder="Buscar..." />
        <button class="btn primary" id="start">Iniciar extracción</button>
      </div>

      <!-- Resultados -->
      <div class="panel">
        <div id="log"></div>
        <div style="height:12px"></div>
        <div style="overflow:auto; max-height:62vh; border:1px solid var(--border); border-radius:10px">
          <table id="table">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
  "use strict";

  // ===== UTILIDAD =====
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  $("#origin").textContent = location.origin;

  // Persistencia simple de API Key
  const apiKey = $("#apiKey");
  apiKey.value = localStorage.getItem('st_api_key') || "";
  apiKey.addEventListener('change', () => localStorage.setItem('st_api_key', apiKey.value));

  // Encabezados base + Lat/Lng
  const headersWantedBase = [
    "KW","Location","Company Name","Category","Website","Phone","email","address",
    "Postal Code + City","state","pin code","# Reviews","Review","CID","MapLink",
    "Lat","Lng"
  ];

  let rows = [];
  let includeLatLng = true;
  let includeEmail = false;

  function toStr(v){ return v==null ? "" : String(v); }
  function escCSV(v){ return '"' + toStr(v).replace(/"/g,'""') + '"'; }
  function downloadCSV(name, data){
    if(!data.length){ alert("No hay filas."); return; }
    const cols = Object.keys(data[0]);
    const lines = [cols.map(escCSV).join(",")];
    for(const r of data) lines.push(cols.map(h=>escCSV(r[h])).join(","));
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob); const a=document.createElement("a");
    a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function log(m){ const el=$("#log"); el.textContent = (el.textContent?el.textContent+"\n":"")+m; console.log("[ScrappingTool]",m); }
  function setProgress(p){ $("#bar").style.width = Math.max(0,Math.min(100,p)) + "%"; }
  function setComboProgress(p){ $("#comboBar").style.width = Math.max(0,Math.min(100,p)) + "%"; }

  // Helpers UI
  function updateCounters(){
    const k = $("#keywords").value.split("\n").map(s=>s.trim()).filter(Boolean).length;
    const l = $("#locations").value.split("\n").map(s=>s.trim()).filter(Boolean).length;
    $("#kwLabel").textContent = `Keywords (${k})`;
    $("#locLabel").textContent = `Ubicaciones (${l})`;
  }
  $("#keywords").addEventListener("input", updateCounters);
  $("#locations").addEventListener("input", updateCounters);
  updateCounters();

  // Tabla
  function currentHeaders(){
    const h = [...headersWantedBase];
    if (!includeEmail) {
      const i = h.indexOf("email"); if (i > -1) h.splice(i, 1);
    }
    if (!includeLatLng) {
      ["Lat","Lng"].forEach(col=>{
        const i = h.indexOf(col); if (i > -1) h.splice(i,1);
      });
    }
    return h;
  }
  function renderHeader(){
    const thead=$("#thead"); thead.innerHTML="";
    const tr1=document.createElement("tr"), tr2=document.createElement("tr");
    currentHeaders().forEach(h=>{
      const th=document.createElement("th"); th.textContent=h; tr1.appendChild(th);
      const th2=document.createElement("th");
      const inp=document.createElement("input"); inp.placeholder="filtrar…"; inp.dataset.col=h; inp.addEventListener("input",renderBody);
      th2.appendChild(inp); tr2.appendChild(th2);
    });
    thead.appendChild(tr1); thead.appendChild(tr2);
  }
  function renderBody(){
    const tbody=$("#tbody"); tbody.innerHTML="";
    const filters={}; $$("#thead input").forEach(i=>{ const v=i.value.trim().toLowerCase(); if(v) filters[i.dataset.col]=v; });
    const cols = currentHeaders();
    const data = rows.map(r=>{
      const pruned={}; cols.forEach(c=>pruned[c]=r[c]??""); return pruned;
    }).filter(r=>{
      for(const k in filters){ if(!toStr(r[k]).toLowerCase().includes(filters[k])) return false; } return true;
    });
    for(const r of data){
      const tr=document.createElement("tr");
      cols.forEach(h=>{ const td=document.createElement("td"); td.textContent=toStr(r[h]??""); tr.appendChild(td); });
      tbody.appendChild(tr);
    }
    $("#count").textContent = data.length;
  }

  $("#clear").addEventListener("click",()=>{ rows=[]; $("#log").textContent=""; $("#count").textContent="0"; setProgress(0); setComboProgress(0); renderBody(); });
  $("#export").addEventListener("click",()=> downloadCSV("resultados-scrapping.csv", rows));
  $("#globalSearch").addEventListener("input", e=>{
    const term=e.target.value.trim().toLowerCase(); $$("#thead input").forEach(i=>i.value="");
    const tbody=$("#tbody"); tbody.innerHTML="";
    const cols = currentHeaders();
    const data = term? rows.filter(r=>Object.values(r).some(v=>toStr(v).toLowerCase().includes(term))) : rows;
    for(const r of data){
      const tr=document.createElement("tr");
      cols.forEach(h=>{ const td=document.createElement("td"); td.textContent=toStr(r[h]??""); tr.appendChild(td); });
      tbody.appendChild(tr);
    }
    $("#count").textContent=data.length;
  });

  $("#includeLatLng").addEventListener("change", e=>{ includeLatLng=e.target.checked; renderHeader(); renderBody(); });
  $("#extractEmail").addEventListener("change", e=>{ includeEmail=e.target.checked; renderHeader(); renderBody(); });

  renderHeader(); renderBody();

  // ===== REST Places Text Search (todas las páginas) =====
  async function textSearchAll({ apiKey, textQuery, center, radius = 5000, language = "es" }) {
    const url = "https://places.googleapis.com/v1/places:searchText";
    const headers = {
      "Content-Type": "application/json",
      "X-Goog-Api-Key": apiKey,
      // FieldMask: solo lo necesario (coste y rendimiento)
      "X-Goog-FieldMask": [
        "places.id",
        "places.displayName",
        "places.formattedAddress",
        "places.location",
        "places.primaryType",
        "places.types",
        "places.nationalPhoneNumber",
        "places.internationalPhoneNumber",
        "places.rating",
        "places.userRatingCount",
        "places.addressComponents",
        "nextPageToken"
      ].join(",")
    };

    let pageToken = null;
    const results = [];
    do {
      const body = {
        textQuery,
        languageCode: language,
        locationBias: {
          circle: {
            center: { latitude: center.lat, longitude: center.lng },
            radius
          }
        },
        pageSize: 20,
        pageToken
      };

      const res = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
      if (!res.ok) {
        const t = await res.text().catch(()=>String(res.status));
        throw new Error(`HTTP ${res.status} en places:searchText: ${t}`);
      }
      const data = await res.json();
      results.push(...(data.places || []));
      pageToken = data.nextPageToken || null;
      // Respetuoso: pequeña pausa entre páginas
      if (pageToken) await new Promise(r=>setTimeout(r, 300));
    } while (pageToken);

    return results;
  }

  // ===== EXTRACCIÓN (lote: keywords x ubicaciones) =====
  $("#start").addEventListener("click", start);

  async function start(){
    const key=$("#apiKey").value.trim(); if(!key) return alert("Coloca tu API key.");
    // Cargar Maps JS si no está (para Geocoding y Details opcional)
    if(!window.google || !google.maps || !google.maps.importLibrary){
      const s=document.createElement("script");
      s.src="https://maps.googleapis.com/maps/api/js?key="+encodeURIComponent(key)+"&v=quarterly";
      s.async=true; s.defer=true; s.onerror=()=>log("No se pudo cargar Google Maps JS API.");
      document.body.appendChild(s);
      await new Promise(res=> s.onload=res);
    }

    const keywords = $("#keywords").value.split("\n").map(t=>t.trim()).filter(Boolean);
    const locations = $("#locations").value.split("\n").map(t=>t.trim()).filter(Boolean);
    if (!keywords.length || !locations.length) return alert("Agrega al menos 1 keyword y 1 ubicación.");

    const emailTimeout = Math.max(1, Math.min(20, parseInt($("#emailTimeout").value,10) || 10));
    const language="es";

    rows=[]; renderBody(); setProgress(0); setComboProgress(0);
    const totalCombos
