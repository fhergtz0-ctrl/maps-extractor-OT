<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Scrapping Tool — Google Maps Places</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Ccircle cx='64' cy='64' r='64' fill='%2322c55e'/%3E%3Cpath d='M64 20c-18 0-32 14-32 32 0 17 26 46 30 50 2 2 5 2 6 0 4-4 30-33 30-50 0-18-14-32-34-32zm0 48a16 16 0 1 1 0-32 16 16 0 0 1 0 32z' fill='%23fff'/%3E%3C/svg%3E" />
<style>
  :root{
    --bg:#0b0e11; --panel:#11161b; --muted:#88919c; --txt:#e6eef6;
    --brand:#22c55e; --accent:#0ea5e9; --bad:#ef4444; --chip:#1b2330;
    --border:#1f2937;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,'Noto Sans',sans-serif}
  .wrap{max-width:1360px;margin:0 auto;padding:16px}
  h1{margin:0 0 10px;font-size:22px}
  .subtitle{color:var(--muted);margin-bottom:14px}

  /* Toolbar */
  .toolbar{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;align-items:end;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:12px;color:var(--muted)}
  textarea, input[type="text"], input[type="number"]{
    background:#0e141a;border:1px solid var(--border);color:var(--txt);border-radius:10px;padding:10px 12px;font-size:14px;outline:none
  }
  textarea{resize:vertical;min-height:40px;max-height:140px}
  .chips{display:flex;gap:10px;flex-wrap:wrap}
  .chip{display:flex;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--border);padding:8px 10px;border-radius:999px;font-size:13px}
  .actions{display:flex;gap:10px;justify-content:flex-end}
  .btn{appearance:none;border:none;border-radius:10px;padding:10px 16px;font-weight:600;cursor:pointer}
  .btn-primary{background:var(--brand);color:#071307}
  .btn-ghost{background:#0f151b;color:var(--txt);border:1px solid var(--border)}
  .badge{display:inline-flex;align-items:center;gap:8px;background:#0f151b;border:1px dashed var(--border);padding:8px 10px;border-radius:10px;color:var(--muted);font-size:13px}

  /* Console */
  .console{margin-top:12px;background:#0f1419;border:1px solid var(--border);border-radius:10px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;color:#aab4bf;white-space:pre-wrap}

  /* Table */
  .table-wrap{margin-top:14px;background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:auto}
  table{border-collapse:separate;border-spacing:0;width:max-content;min-width:100%}
  thead th{position:sticky;top:0;background:#0f151b;color:#cbd5e1;font-weight:600;font-size:13px;padding:10px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap}
  tbody td{font-size:13px;color:#e5eef9;border-bottom:1px solid var(--border);padding:8px 10px;vertical-align:top;white-space:nowrap}
  thead th .filter{display:block;margin-top:6px;background:#0c1015;border:1px solid var(--border);color:#aab4bf;border-radius:8px;padding:6px 8px;width:200px;font-size:12px}
  .th-shrink{width:140px}
  .th-mini{width:90px}
  .th-wide{width:280px}
  .nowrap{white-space:nowrap}
  .ok{color:#22c55e}
  .warn{color:#f59e0b}
  .err{color:#ef4444}

  /* Grid layout for the toolbar */
  .c-keywords{grid-column:span 3}
  .c-cities{grid-column:span 2}
  .c-states{grid-column:span 2}
  .c-colonies{grid-column:span 2}
  .c-zips{grid-column:span 1}
  .c-key{grid-column:span 2}
  .c-radius{grid-column:span 1}
  .c-emailsec{grid-column:span 1}
  .c-flags{grid-column:span 3}
  .c-extras{grid-column:span 6}
  .c-actions{grid-column:span 3;display:flex;gap:10px;align-items:center;justify-content:flex-end}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Scrapping Tool — <span class="muted">Google Maps Places</span></h1>
  <div class="subtitle">Barra única, resultados paginados por combinación y columnas separadas para Estado / Ciudad / Colonia / CP. Marca los “Campos extra” que desees.</div>

  <!-- TOOLBAR -->
  <section class="toolbar">
    <div class="field c-keywords">
      <label>Keywords (uno por línea)</label>
      <textarea id="kw" placeholder="Restaurante&#10;Tacos"></textarea>
    </div>
    <div class="field c-cities">
      <label>Ciudad(es)</label>
      <textarea id="cities" placeholder="Hermosillo&#10;Nogales"></textarea>
    </div>
    <div class="field c-states">
      <label>Estado(s)</label>
      <textarea id="states" placeholder="Sonora"></textarea>
    </div>
    <div class="field c-colonies">
      <label>Colonia(s) (opcional)</label>
      <textarea id="colonies" placeholder="Centro&#10;Pitic"></textarea>
    </div>
    <div class="field c-zips">
      <label>Códigos postales (opcional)</label>
      <textarea id="zips" placeholder="83000&#10;83290"></textarea>
    </div>

    <div class="field c-key">
      <label>API Key</label>
      <input id="apiKey" type="text" placeholder="Pegar aquí la Key">
      <div class="chips" style="margin-top:8px">
        <label class="chip"><input id="wantLatLng" type="checkbox" checked> Lat &amp; Long</label>
        <label class="chip"><input id="wantWebsite" type="checkbox" checked> Website</label>
        <label class="chip"><input id="wantEmail" type="checkbox"> Email</label>
      </div>
    </div>

    <div class="field c-radius">
      <label>Radio por consulta (km)</label>
      <input id="radiusKm" type="number" min="1" max="50" value="3">
    </div>

    <div class="field c-emailsec">
      <label>Seg máx. email</label>
      <input id="emailWait" type="number" min="0" max="30" value="10">
    </div>

    <div class="field c-extras">
      <label>Campos extra</label>
      <div class="chips">
        <label class="chip"><input id="exHorario" type="checkbox"> Horario</label>
        <label class="chip"><input id="exPrecio" type="checkbox"> Precio</label>
        <label class="chip"><input id="exMapsUri" type="checkbox"> Maps URI</label>
        <label class="chip"><input id="exFoto" type="checkbox"> Foto</label>
        <label class="chip"><input id="exTipos" type="checkbox" checked> Tipo + Subtipos</label>
        <label class="chip"><input id="exShortAddr" type="checkbox" checked> Short Addr</label>
        <label class="chip"><input id="exResumen" type="checkbox"> Resumen</label>
        <label class="chip"><input id="exPartners" type="checkbox" checked> Partners (Reserva/Delivery)</label>
      </div>
    </div>

    <div class="c-actions">
      <button id="btnStart" class="btn btn-primary">Iniciar</button>
      <button id="btnDownload" class="btn btn-ghost">Descargar</button>
      <span class="badge">Resultados: <b id="found">0</b></span>
    </div>
  </section>

  <!-- LOG -->
  <div id="log" class="console">Listo para iniciar…</div>

  <!-- TABLE -->
  <div class="table-wrap">
    <table id="tbl">
      <thead>
        <tr>
          <th class="th-mini">KW<input class="filter" data-col="kw" placeholder="filtrar…"></th>
          <th class="th-mini">State<input class="filter" data-col="state" placeholder="filtrar…"></th>
          <th class="th-mini">City<input class="filter" data-col="city" placeholder="filtrar…"></th>
          <th class="th-mini">Colony<input class="filter" data-col="colony" placeholder="filtrar…"></th>
          <th class="th-shrink">Company Name<input class="filter" data-col="name" placeholder="filtrar…"></th>
          <th class="th-mini">Category<input class="filter" data-col="category" placeholder="filtrar…"></th>
          <th class="th-shrink">Website<input class="filter" data-col="website" placeholder="filtrar…"></th>
          <th class="th-mini">Phone<input class="filter" data-col="phone" placeholder="filtrar…"></th>
          <th class="th-mini">email<input class="filter" data-col="email" placeholder="filtrar…"></th>
          <th class="th-wide">address<input class="filter" data-col="address" placeholder="filtrar…"></th>
          <th class="th-mini">Postal Code<input class="filter" data-col="postal" placeholder="filtrar…"></th>
          <th class="th-mini">Lat<input class="filter" data-col="lat" placeholder="filtrar…"></th>
          <th class="th-mini">Lng<input class="filter" data-col="lng" placeholder="filtrar…"></th>
          <th class="th-wide">Tipo + Subtipos<input class="filter" data-col="types" placeholder="filtrar…"></th>
          <th class="th-mini">Precio<input class="filter" data-col="price" placeholder="filtrar…"></th>
          <th class="th-mini">Horario<input class="filter" data-col="hours" placeholder="filtrar…"></th>
          <th class="th-wide">Resumen<input class="filter" data-col="summary" placeholder="filtrar…"></th>
          <th class="th-shrink">Foto<input class="filter" data-col="photo" placeholder="filtrar…"></th>
          <th class="th-mini"># Reviews<input class="filter" data-col="reviews" placeholder="filtrar…"></th>
          <th class="th-mini">Review<input class="filter" data-col="rating" placeholder="filtrar…"></th>
          <th class="th-mini">CID<input class="filter" data-col="cid" placeholder="filtrar…"></th>
          <th class="th-shrink">MapLink<input class="filter" data-col="map" placeholder="filtrar…"></th>
          <th class="th-mini">Partners<input class="filter" data-col="partners" placeholder="filtrar…"></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
/* ==========================
   Helpers UI
========================== */
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
const log = (msg, cls="")=>{
  const el = $("#log");
  el.textContent = el.textContent ? (el.textContent + "\\n" + msg) : msg;
  if(cls){ el.className = "console " + cls; }
};
const setFound = n => $("#found").textContent = n;

const byCol = key => (tr) => (tr.dataset[key]||"").toLowerCase();
const applyFilters = ()=>{
  const filters = {};
  $$(".filter").forEach(inp => {
    if(inp.value.trim()) filters[inp.dataset.col] = inp.value.trim().toLowerCase();
  });
  $$("#tbody tr").forEach(tr=>{
    let ok = true;
    for(const k in filters){
      if(!byCol(k)(tr).includes(filters[k])){ ok=false; break; }
    }
    tr.style.display = ok ? "" : "none";
  });
};
document.addEventListener("input", e=>{
  if(e.target.classList.contains("filter")) applyFilters();
});

/* ==========================
   Core extraction logic
========================== */
let RESULTS = [];
let running = false;
let mapsLoaded = false;

const loadMaps = (key) => new Promise((resolve,reject)=>{
  if(mapsLoaded) return resolve();
  const s = document.createElement("script");
  s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&v=weekly`;
  s.onload = ()=>{ mapsLoaded=true; resolve(); };
  s.onerror = ()=>reject(new Error("No se pudo cargar Maps JS"));
  document.head.appendChild(s);
});

const geocodeOne = (s) => new Promise((resolve)=>{
  const g = new google.maps.Geocoder();
  g.geocode({ address: s }, (res, status)=>{
    if(status==="OK" && res?.[0]){
      const r = res[0];
      const loc = r.geometry.location;
      const comp = parseAddressComponents(r.address_components||[]);
      resolve({ lat: loc.lat(), lng: loc.lng(), components: comp, viewport: r.geometry.viewport || null });
    } else {
      resolve(null);
    }
  });
});

function parseAddressComponents(comps){
  const out = { country:"", state:"", city:"", postal:"", colony:"" };
  comps.forEach(c=>{
    if(c.types.includes("administrative_area_level_1")) out.state = c.long_name;
    if(c.types.includes("locality")) out.city = c.long_name;
    if(c.types.includes("sublocality") || c.types.includes("neighborhood")) out.colony = out.colony || c.long_name;
    if(c.types.includes("postal_code")) out.postal = c.long_name;
    if(c.types.includes("country")) out.country = c.long_name;
  });
  return out;
}

/* Places API (New) searchText paginado hasta 60 (3 páginas x 20) */
async function textSearchAll(apiKey, body){
  const url = "https://places.googleapis.com/v1/places:searchText";
  const headers = {
    "Content-Type":"application/json",
    "X-Goog-Api-Key": apiKey,
    "X-Goog-FieldMask": [
      "places.id",
      "places.displayName",
      "places.primaryType",
      "places.types",
      "places.formattedAddress",
      "places.addressComponents",
      "places.shortFormattedAddress",
      "places.location",
      "places.plusCode",
      "places.nationalPhoneNumber",
      "places.internationalPhoneNumber",
      "places.rating",
      "places.userRatingCount",
      "places.priceLevel",
      "places.googleMapsUri",
      "places.currentOpeningHours",
      "places.photos.name",
      "nextPageToken"
    ].join(",")
  };

  let out = [];
  let page = 0;
  let token = null;
  do{
    const payload = token ? { ...body, pageToken: token } : body;
    const r = await fetch(url, { method:"POST", headers, body: JSON.stringify(payload) });
    if(!r.ok){
      const t = await r.text().catch(()=>r.statusText);
      throw new Error(t || ("HTTP "+r.status));
    }
    const j = await r.json();
    out.push(...(j.places||[]));
    token = j.nextPageToken || null;
    page++;
  } while(token && page < 3); // 3 páginas x 20 = 60
  return out;
}

/* partners detector (best-effort): lee la página pública a través de r.jina.ai */
async function detectPartners(publicOrWebsiteUrl){
  if(!publicOrWebsiteUrl) return "";
  const url = /^https?:\/\//i.test(publicOrWebsiteUrl) ? publicOrWebsiteUrl : ("https://www.google.com/maps/search/?api=1&query="+encodeURIComponent(publicOrWebsiteUrl));
  try{
    const r = await fetch("https://r.jina.ai/http/"+url.replace(/^https?:\/\//,""));
    if(!r.ok) return "";
    const html = (await r.text()).toLowerCase();
    const hits = [];
    if(html.includes("opentable")) hits.push("OpenTable");
    if(html.includes("ubereats")) hits.push("UberEats");
    if(html.includes("rappi")) hits.push("Rappi");
    if(html.includes("didi food") || html.includes("didifood")) hits.push("DiDi Food");
    if(html.includes("ordena") && html.includes("restaurant")) hits.push("Orden web");
    return [...new Set(hits)].join(", ");
  }catch(_){ return ""; }
}

/* email scraper (muy best-effort) */
async function tryExtractEmail(website, waitSec){
  if(!website) return "";
  try{
    const r = await fetch("https://r.jina.ai/http/"+website.replace(/^https?:\/\//,""), { cache:"no-store" });
    if(!r.ok) return "";
    const tx = await r.text();
    const m = tx.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/ig);
    if(m && m.length) return [...new Set(m)].slice(0,3).join(" / ");
  }catch(_){}
  return "";
}

function pushRow(row){
  RESULTS.push(row);
  const tr = document.createElement("tr");
  const cols = [
    "kw","state","city","colony","name","category","website","phone","email","address","postal","lat","lng","types","price","hours","summary","photo","reviews","rating","cid","map","partners"
  ];
  cols.forEach(c=>{
    const td = document.createElement("td");
    td.textContent = row[c] || "";
    tr.appendChild(td);
  });
  // dataset para filtros
  for(const k of cols) tr.dataset[k] = (row[k]||"").toString();
  $("#tbody").appendChild(tr);
  setFound(RESULTS.length);
}

/* ==========================
   Start
========================== */
$("#btnStart").addEventListener("click", async ()=>{
  if(running) return;
  RESULTS = []; $("#tbody").innerHTML=""; setFound(0);
  $("#log").textContent = "Iniciando…";
  running = true;

  try{
    const key = $("#apiKey").value.trim();
    if(!key){ running=false; return log("Coloca tu API Key", "err"); }
    await loadMaps(key);

    // entradas
    const radiusKm   = parseFloat($("#radiusKm").value)||3;
    const radiusM    = Math.max(1, radiusKm)*1000;
    const waitMail   = parseInt($("#emailWait").value)||10;

    // toggles
    const wantLatLng = $("#wantLatLng").checked;
    const wantWebsite= $("#wantWebsite").checked;
    const wantEmail  = $("#wantEmail").checked;

    const exHorario  = $("#exHorario").checked;
    const exPrecio   = $("#exPrecio").checked;
    const exMapsUri  = $("#exMapsUri").checked;
    const exFoto     = $("#exFoto").checked;
    const exTipos    = $("#exTipos").checked;
    const exShort    = $("#exShortAddr").checked;
    const exResumen  = $("#exResumen").checked;
    const exPartners = $("#exPartners").checked;

    const KW   = $("#kw").value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    const CITS = $("#cities").value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    const STS  = $("#states").value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    const COLS = $("#colonies").value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    const ZIPS = $("#zips").value.split(/\n+/).map(s=>s.trim()).filter(Boolean);

    if(!KW.length || (!CITS.length && !ZIPS.length)){
      running=false;
      return log("Pon al menos una Keyword y una Ciudad (o un CP).", "err");
    }

    // genera combinaciones de ubicaciones: CPs directos + combinaciones ciudad/estado/colonia
    const combos = [];
    ZIPS.forEach(cp => combos.push({label:`CP: ${cp}`, geostr:`${cp}`}));
    if(CITS.length){
      const statesList = STS.length?STS:[""];
      const colsList   = COLS.length?COLS:[""];
      for(const city of CITS){
        for(const st of statesList){
          for(const col of colsList){
            const label = [col, city, st].filter(Boolean).join(", ");
            const geostr= label;
            combos.push({label, geostr});
          }
        }
      }
    }

    log(`Se generaron ${combos.length} ubicacione(s).`);

    for(let ci=0; ci<combos.length; ci++){
      const { label, geostr } = combos[ci];

      // geocodificar
      let center = null, components=null;
      try{
        const g = await geocodeOne(geostr);
        if(!g){ log(`No se pudo geocodificar: ${geostr}`,"warn"); continue; }
        center = { lat: g.lat, lng: g.lng };
        components = g.components;
      }catch(e){
        log(`Error geocodificando ${geostr}: ${e.message}`, "err");
        continue;
      }

      for(const kw of KW){
        log(`Buscando "${kw}" @ "${label}" (radio ${radiusKm} km)…`);

        // Places searchText con bias circular
        const body = {
          textQuery: `${kw}`,
          pageSize : 20,
          locationBias: {
            circle: { center, radius: radiusM }
          }
        };

        let places = [];
        try{
          places = await textSearchAll(key, body);
        }catch(e){
          log(`Error "${kw}" @ "${label}": ${e.message}`, "err");
          continue;
        }

        // procesar resultados
        for(const p of places){
          const name = p.displayName?.text || "";
          const phone = p.nationalPhoneNumber || p.internationalPhoneNumber || "";
          const cat = p.primaryType || (p.types||[]).join(", ");

          // Address components -> separar state/city/colony/postal
          const ac = parseAddressComponents(p.addressComponents||[]);
          const state = ac.state || components?.state || "";
          const city  = ac.city  || components?.city  || "";
          const colony= ac.colony|| components?.colony|| "";
          const postal= ac.postal|| "";

          const address = (exShort ? (p.shortFormattedAddress||"") : (p.formattedAddress||"")) || "";
          const lat = p.location?.latitude?.toFixed(6) || p.location?.lat?.toFixed?.(6) || "";
          const lng = p.location?.longitude?.toFixed(6) || p.location?.lng?.toFixed?.(6) || "";

          const rating  = p.rating ?? "";
          const reviews = p.userRatingCount ?? "";
          const price   = exPrecio ? (p.priceLevel ?? "") : "";

          const types   = exTipos ? [p.primaryType, ...(p.types||[])].filter(Boolean).join(" / ") : "";
          const hours   = exHorario ? (p.currentOpeningHours?.weekdayDescriptions||[]).join(" | ") : "";

          const summary = exResumen ? (p.editorialSummary?.text || "") : "";
          const mapUri  = exMapsUri ? (p.googleMapsUri||"") : (p.googleMapsUri||"");

          // Foto (solo el "name" del asset)
          const photo   = exFoto ? (p.photos?.[0]?.name || "") : "";

          // website: NO llega en v1; a veces viene en Details. Haremos best-effort = vacío (o el mismo mapsUri)
          let website = wantWebsite ? "" : "";
          // email best-effort
          let email = wantEmail ? await tryExtractEmail(website, parseInt($("#emailWait").value)||10) : "";

          // CID (puede no venir; intentamos extraer de googleMapsUri si aparece)
          let cid = "";
          if(mapUri && mapUri.includes("cid=")){
            const m = mapUri.match(/[?&]cid=([0-9]+)/);
            if(m) cid = m[1];
          }

          // Partners
          let partners = "";
          if(exPartners){
            const candidate = website || mapUri;
            partners = await detectPartners(candidate);
          }

          const row = {
            kw: kw,
            state, city, colony, postal,
            name,
            category: cat,
            website,
            phone,
            email,
            address,
            lat: wantLatLng ? lat : "",
            lng: wantLatLng ? lng : "",
            types,
            price,
            hours,
            summary,
            photo,
            reviews: reviews.toString(),
            rating: rating.toString(),
            cid,
            map: mapUri,
            partners
          };
          pushRow(row);
        }
      }
    }

    log("Proceso finalizado. Lugares únicos: " + RESULTS.length);
  }catch(e){
    log("Error general: " + e.message, "err");
  }finally{
    running = false;
  }
});

/* ==========================
   CSV Download
========================== */
$("#btnDownload").addEventListener("click", ()=>{
  if(!RESULTS.length){ return log("No hay datos para descargar.", "warn"); }
  const cols = ["kw","state","city","colony","name","category","website","phone","email","address","postal","lat","lng","types","price","hours","summary","photo","reviews","rating","cid","map","partners"];
  const head = cols.map(c=>JSON.stringify(c)).join(",");
  const rows = RESULTS.map(r=>cols.map(c=>JSON.stringify(r[c]??"")).join(","));
  const csv = [head, ...rows].join("\\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "places.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
});

/* ==========================
   UX touch
========================== */
["kw","cities","states","colonies","zips"].forEach(id=>{
  $("#"+id).addEventListener("keydown", e=>{
    if(e.key==="Enter" && (e.metaKey||e.ctrlKey)){ $("#btnStart").click(); }
  });
});
</script>
</body>
</html>
